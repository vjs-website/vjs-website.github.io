<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,
                                   initial-scale=1,
                                   minimum-scale=1,
                                   maximum-scale=1,
                                   user-scalable=no,
                                   minimal-ui">
  
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
  
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
    <title>Identity Service - Vanadium</title>
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,400,400italic,500,500italic,700,700italic|Source+Code+Pro">
  
    <link rel="stylesheet" href="/css/github.css">
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  
    <script src="/js/react-0.14.3.min.js"></script>
    <script src="/js/react-dom-0.14.3.min.js"></script>
  
    <link rel="apple-touch-icon" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="160x160" href="/favicons/favicon-160x160.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/favicons/favicon-192x192.png">
    <meta name="msapplication-TileColor" content="#00acc1">
    <meta name="msapplication-TileImage" content="/favicons/mstile-144x144.png">
  
    <link rel="stylesheet" href="/css/bundle.css">
    <script src="/js/bundle.js"></script>
  </head>
  <body>
    <header class="mdl-shadow--2dp">
      <div class="row">
        <div class="icon menu"><i class="material-icons">menu</i></div>
        <div class="icon v-icon"><img src="/images/v-icon-white.svg"></div>
        <div class="logo"><a href="/">Vanadium</a></div>
        <div class="spacer"></div>
        <nav>
          <a href="/">Overview</a>
          <a href="/installation/">Installation</a>
          <a href="/tutorials/hello-world.html">Tutorials</a>
        </nav>
      </div>
    </header>
    <div class="sidebar"></div>
    <div class="sidebar-data">
      <a href="/">Overview</a>
      <a href="/installation/">Installation</a>
    
      <a href="#" class="nav">Tutorials</a>
      <nav>
        <a href="/tutorials/hello-world.html">Hello World</a>
        <a href="/tutorials/basics.html">Client/Server Basics</a>
    
        <a href="#" class="nav">Security</a>
        <nav>
          <a href="/tutorials/security/">Overview</a>
          <a href="/tutorials/security/principals-and-blessings.html">Principals and Blessings</a>
      <a href="/tutorials/security/permissions-authorizer.html">Permissions Authorizer</a>
      <a href="/tutorials/security/first-party-caveats.html">Caveats</a>
      <a href="/tutorials/security/third-party-caveats.html">Third-party Caveats</a>
      <a href="/tutorials/security/agent.html">The Agent</a>
      <a href="/tutorials/security/custom-authorizer.html">Custom Authorizer</a>
    </nav>
    
        <a href="#" class="nav">Naming</a>
        <nav>
          <a href="/tutorials/naming/">Overview</a>
          <a href="/tutorials/naming/mount-table.html">The Mount Table</a>
      <a href="/tutorials/naming/namespace.html">Namespaces</a>
      <a href="/tutorials/naming/suffix-part1.html">The Suffix - Part I</a>
      <a href="/tutorials/naming/suffix-part2.html">The Suffix - Part II</a>
      <a href="/tutorials/naming/globber.html">Globber</a>
    </nav>
    
        <a href="#" class="nav">Java</a>
        <nav>
          <a href="/tutorials/java/">Overview</a>
          <a href="/tutorials/java/fortune.html">Fortune in Java</a>
      <a href="/tutorials/java/android.html">Location Service in Android</a>
    </nav>
    
        <a href="#" class="nav">JavaScript</a>
        <nav>
          <a href="/tutorials/javascript/">Overview</a>
          <a href="/tutorials/javascript/hellopeer.html">Hello Peer</a>
      <a href="/tutorials/javascript/fortune.html">Fortune in JS</a>
      <a href="/tutorials/javascript/security.html">Security in JS</a>
    </nav>
    
        <a href="/tutorials/faq.html">Tutorial FAQ</a>
      </nav>
    
      <a href="#" class="nav">Concepts</a>
      <nav>
        <a href="/concepts/rpc.html">RPC System</a>
    <a href="/concepts/naming.html">Naming</a>
    <a href="/concepts/security.html">Security</a>
    <a href="/concepts/device-management.html">Device Management</a>
    <a href="/concepts/syncbase-overview.html">Syncbase</a>
  </nav>
    
      <a href="/example-apps.html">Example Apps</a>
      <a href="/api-reference.html">API Reference</a>
    
      <a href="#" class="nav">Community</a>
      <nav>
        <a href="/community/coding-guidelines.html">Coding Guidelines</a>
    <a href="/community/contributing.html">Contributing</a>
  </nav>
    
      <a href="#" class="nav">Tools</a>
      <nav>
        <a href="/tools/identity-service-faq.html">Vanadium Identity Service</a>
    <a href="/tools/jiri.html">Jiri</a>
    <a href="/tools/services.html">Vanadium Cloud Services</a>
    <a href="/tools/vanadium-chrome-extension.html">Vanadium Chrome Extension</a>
  </nav>
    
      <a href="#" class="nav">Design Docs</a>
      <nav>
        <a href="/designdocs/authentication.html">Authentication Protocol</a>
    <a href="/designdocs/identity-service.html">Identity Service</a>
    <a href="/designdocs/vdl-spec.html">VDL Specification</a>
    <a href="/designdocs/vom-spec.html">VOM Specification</a>
  </nav>
    
      <a href="/glossary.html">Glossary</a>
      <a href="/faq.html">FAQ</a>
      <a href="/tos.html">Terms of Service</a>
    </div>
    <main>
      <h1 class="title">
        
        Identity Service
      </h1>

      <div class="toc"></div>

      <p>The <a href="https://github.com/vanadium/go.ref/tree/master/services/identity/identityd">Vanadium Identity Service</a> generates <a href="/glossary.html#blessing">blessings</a>.
It uses an <a href="http://oauth.net/2/">OAuth2</a> identity provider to get the email address of a user and
then issues a blessing with that email address. For example, after determining
that the user is <code>alice@university.edu</code> (using OAuth2), this service will issue
the blessing <code>dev.v.io:u:alice@university.edu</code> (where <code>dev.v.io</code> is
the namespace for which the public key of the identity service is considered
authoritative).  The blessing may also contain specific caveats per the user&#39;s
request.</p>
<p>Broadly, this identity service consists of two main components:</p>
<ul>
<li><strong>HTTPS Authentication Service</strong>: This service authenticates the user using
an OAuth2 Identity Provider, and securely hands out a token (henceforth
called a macaroon) that encapsulates the user&#39;s authenticated identity and
any caveats that the user may have requested to be added to the blessing. The
cryptographic construction of macaroons ensures that their contents cannot be
tampered with.</li>
<li><strong>Vanadium Blessing Service</strong>: This is a Vanadium RPC service with a method
that exchanges the macaroon for a blessing. The principal invoking this RPC
is blessed with a name and caveats extracted from the presented macaroon.</li>
</ul>
<p>One additional service enables revocation of the blessings granted by the
blessing service:</p>
<ul>
<li><strong>Vanadium Discharge Service</strong>: This is a Vanadium RPC service that enables
revocation. The service issues <a href="/glossary.html#discharge">discharges</a> for a revocation
<a href="/glossary.html#caveat">caveat</a> if the blessing has not been revoked by the user. The discharges are
valid for 15 minutes.</li>
</ul>
<p>All three services are exposed by a single binary - <a href="https://github.com/vanadium/go.ref/tree/master/services/identity/identityd"><code>identityd</code></a>.  In order to
save users from talking to two different services (the HTTP service and the
Blessing service) and managing macaroons, we also provide a command-line tool -
<a href="https://github.com/vanadium/go.ref/tree/master/cmd/principal"><code>principal</code></a> - that talks to both of the services and obtains a blessing for
the principal that the tool is running as.</p>
<h1 id="preliminaries">Preliminaries</h1>
<p>Before diving into the details of <a href="https://github.com/vanadium/go.ref/tree/master/services/identity/identityd"><code>identityd</code></a>&#39;s design, some prerequisites:</p>
<ul>
<li><a href="/concepts/security.html">Principals, Blessings and Caveats</a>.</li>
<li>Third-party caveats: In a nutshell, a third-party caveat is a restriction on
the use of a blessing that must be validated by a party other than the two
communicating with and authorizing each other. The <a href="/glossary.html#blessing">blessing</a> with a
third-party caveat is considered valid only if accompanied by a <a href="/glossary.html#discharge">discharge</a>
issued by the third party that validated the restrictions. Discharges are
unforgeable and cryptographically bound to the correpsonding third-party
caveat.</li>
<li><em>Macaroons</em>: For the purposes of the identity service, a macaroon is a bearer
token, similar to a cookie that can only be minted (and verified) by the
identity service. A macaroon encapsulates state whose bits cannot be tampered
with by anyone but the identity service. The state itself though is visible
to the bearers of the macaroon. In particular, the identity service with a
secret <a href="http://en.wikipedia.org/wiki/Hash-based_message_authentication_code">HMAC</a> key <code>k</code> defines a macaroon for a state as:
<code>Macaroon<sub>k</sub>(state) = HMAC(k, state)</code>
The name &quot;cookie&quot; or &quot;token&quot; could have been used instead, but the term
macaroon was an allusion to <a href="http://research.google.com/pubs/archive/41892.pdf">this
paper</a>.</li>
</ul>
<h1 id="service-interfaces">Service interfaces</h1>
<p>The HTTPS Authentication Service runs at <a href="https://dev.v.io/auth">https://dev.v.io/auth</a> and uses the
Google OAuth2 <a href="https://developers.google.com/accounts/docs/OAuth2WebServer">web service flow</a> for authenticating users.  It has a specific
OAuth2 ClientID and ClientSecret obtained from the Google Developer Console. It
supports the following routes:</p>
<table>
<thead>
<tr>
<th>Route</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/google/seekblessings</code></td>
<td>Receive blessing requests</td>
</tr>
<tr>
<td><code>/google/caveats</code></td>
<td>Display a form for selecting caveats to be added to a blessing</td>
</tr>
<tr>
<td><code>/google/sendmacaroon</code></td>
<td>Receive a POST request from the caveat selection form</td>
</tr>
<tr>
<td><code>/google/listblessings</code></td>
<td>Enumerate all blessings made by a particular user</td>
</tr>
<tr>
<td><code>/google/revoke</code></td>
<td>Receive revocation requests</td>
</tr>
</tbody>
</table>
<p>The blessing service is a Vanadium RPC service reachable via the name
<code>/ns.dev.v.io:8101/identity/dev.v.io/u/google</code> and presents the <a href="https://github.com/vanadium/go.ref/blob/master/services/identity/identity.vdl"><code>MacaroonBlesser</code></a> interface:</p>
<pre><code>type MacaroonBlesser interface {
  // Bless uses the provided macaroon (which contains email and caveats)
  // to return a blessing for the client.
  Bless(macaroon string) (blessing security.WireBlessings | error)
}
</code></pre><h1 id="blessing-flow">Blessing flow</h1>
<p>The <a href="https://github.com/vanadium/go.ref/tree/master/cmd/principal"><code>principal</code></a> command-line tool is used to orchestrate the process of
obtaining a macaroon from the HTTPS Authentication Service and exchanging it
for a blessing from the Vanadium Blessing Service. The following sequence
diagram lists the network requests involved in this process:</p>
<p><img src="/images/blessing-flow.svg" alt="Blessing flow diagram"></p>
<ul>
<li>Solid-line arrows represent HTTPS requests (except one HTTP to localhost).</li>
<li>Dotted-line arrows represent Vanadium RPC requests.</li>
</ul>
<p>Steps 1 thru 4 in the sequence diagram above result in the <a href="https://github.com/vanadium/go.ref/tree/master/cmd/principal"><code>principal</code></a> tool
invocation obtaining a macaroon.</p>
<p>Steps 5 and 6 exchange that macaroon for a blessing.</p>
<ol>
<li><p>The tool generates a random state parameter <code>toolState</code> and starts an HTTP
server on <code>localhost</code> for receiving the macaroon. <code>toolURI</code> denotes the URI
of this server (e.g., <code>http://127.0.0.1:14141</code>), and <code>toolPublicKey</code> denotes
the public key of the principal running the tool.
It then directs the web browser on the machine to the HTTP Authentication
Service while informing it of <code>toolURI</code>, <code>toolPublicKey</code> and the <code>toolState</code>
parameters. For example, it might redirect to:
<code>https://dev.v.io/auth/google/seekblessings?redirect_uri=&lt;toolURI&gt;&amp;state=&lt;toolState&gt;&amp;public_key=&lt;toolPublicKey&gt;</code></p>
</li>
<li><p>The HTTP Authentication Service extracts <code>toolURI</code>, <code>toolState</code> and
<code>toolPublicKey</code> and redirects the browser to the Google OAuth2 endpoint
(using the <a href="https://developers.google.com/accounts/docs/OAuth2WebServer">web service flow</a>). The <code>redirect_uri</code> provided to this endpoint
is set to the page that presents a form to control caveats on the final
blessing and the <code>state</code> parameter is set to: <code>oauthstate = Macaroon<sub>k</sub>(toolURI +
toolState + toolPublicKey + serverCookie)</code> where <code>serverCookie</code> is a
cookie set by the HTTP Authentication Service in the user&#39;s browser. This leads
the user&#39;s browser to a URL like:
<code>https://accounts.google.com/o/oauth2/auth?client_id=...&amp;redirect_uri=https://dev.v.io/auth/google/caveat&amp;state=oauthstate</code></p>
<p>The Google OAuth2 endpoint asks the user to login and grant access to email
address to the Vanadium Identity Server, after which it redirect the browser
back to:
<code>https://dev.v.io/auth/google/caveats?code=&lt;authcode&gt;&amp;state=&lt;oauthstate&gt;</code></p>
</li>
<li><p>The caveats page at the HTTP Authentication Service receives <code>authcode</code> and
<code>oauthstate</code>. It then:</p>
<ul>
<li>Verifies that <code>oauthstate</code> is a valid macaroon generated by step 2.</li>
<li>Extracts <code>toolURI</code>, <code>toolState</code>, <code>toolPublicKey</code> and <code>serverCookie</code> from the macaroon.</li>
<li>Verifies that <code>serverCookie</code> matches the cookie presented by the browser</li>
<li>Exchanges <code>authcode</code> for an email address (via an identity token) using
the OAuth2 client-secret.</li>
<li>Displays a form for selecting caveats to be added to the blessing that
will ultimately be provided to the <a href="https://github.com/vanadium/go.ref/tree/master/cmd/principal"><code>principal</code></a> tool started in step 1.
Embedded in this form is <code>formstate = Macaroon&lt;sub&gt;k&lt;/sub&gt;(toolURI + toolState + toolPublicKey + email + serverCookie)</code>.</li>
</ul>
</li>
<li><p>When the user submits the form rendered in step 3, the browser sends the form
contents to <code>https://dev.v.io/auth/google/sendmacaroon</code> which performs the
following steps:</p>
<ul>
<li>Verifies that <code>formstate</code> is a valid macaroon.</li>
<li>Extracts <code>toolURI</code>, <code>toolState</code>, <code>toolPublicKey</code>, <code>email</code> and <code>serverCookie</code> encapsulated
in the macaroon.</li>
<li>Verifies that <code>serverCookie</code> matches the cookie presented by the browser.</li>
<li>Verifies that <code>toolURI</code> is a localhost URI.</li>
<li>Computes <code>M = Macaroon<sub>k</sub>(email, toolPublicKey, caveats)</code>.</li>
<li>Redirects the browser to:
<code>https://&lt;toolURI&gt;/macaroon?state=&lt;toolState&gt;&amp;macaroon=M&amp;root_key=publicKey</code>
where <code>publicKey</code> is the <a href="/glossary.html#blessing-root">blessing root</a> of the identity service.</li>
</ul>
</li>
<li><p>The <code>principal</code> tool receives the macaroon <code>M</code>, <code>toolState</code> and the
<a href="/glossary.html#blessing-root">blessing root</a> via the HTTP redirect in step 4. It then:</p>
<ul>
<li>Verifies that <code>toolState</code> obtained here matches the one created in step 1.</li>
<li>Invokes the <code>Bless</code> RPC on the blessing service passing it <code>M</code> as an argument.
It only sends this request if the the RPC server proves that it&#39;s public key
is <code>publicKey</code> via the <a href="/designdocs/authentication.html">authentication protocol</a> used in RPCs.</li>
</ul>
</li>
<li><p>The Vanadium Blessing Service that receives this RPC performs the following steps:</p>
<ul>
<li>Verifies that the macaroon presented is valid.</li>
<li>Extracts <code>email</code>, <code>toolPublicKey</code> and <code>caveats</code> from it.</li>
<li>Verifies that the principal making the RPC request has the same public key
as <code>toolPublicKey</code>. This check ensures that the macaroon can only be used by
the principal tool that requested it in the first place. It protects against
impersonation attacks wherein an attacker steals the macaroon handed out in
step 5 and then tries to obtain a blessing for the email address encapsulated
in the macaroon.</li>
<li>Generates a <a href="/glossary.html#blessing">blessing</a> with the name <code>dev.v.io:u:&lt;email&gt;</code> and the
caveats extracted from the macaroon. This blessing is bound to the public
key of the principal making the RPC request (i.e., <code>toolPublicKey</code>).</li>
<li>Records the creation of this blessing in a database which can be queried via
<code>https://dev.v.io/auth/google/listblessings</code>.</li>
</ul>
</li>
</ol>
<h1 id="supported-caveats">Supported caveats</h1>
<p>The caveat addition form presented to the user in step 4 supports a few types
of caveats:</p>
<ul>
<li><a href="https://github.com/vanadium/go.v23/blob/master/security/caveat.vdl"><em>Expiry</em></a>: Which limits the time period during which the blessing is valid.</li>
<li><a href="https://github.com/vanadium/go.v23/blob/master/security/caveat.vdl"><em>PeerBlessings</em></a>: Which limits the set of peers that the blessing will be recognized by.</li>
<li><a href="https://github.com/vanadium/go.v23/blob/master/security/caveat.vdl"><em>Method</em></a>: Which limits the set of methods that can be invoked with the blessing.</li>
<li><a href="https://github.com/vanadium/go.ref/tree/master/services/identity/internal/revocation"><em>Revocation</em></a>: Which allows the user to revoke the blessing at any time in
the future by visiting <a href="https://dev.v.io/auth/google/listblessings">https://dev.v.io/auth/google/listblessings</a>.</li>
</ul>
<h2 id="revocation">Revocation</h2>
<p>The revocation caveat that is (at the user&#39;s request) added to the blessing is
a third-party caveat with a unique 16-byte ID and the object name of the
discharging service. Each time a revocation caveat is created, the blessing
service stores the corresponding ID and the revocation status in a SQL
database.</p>
<p>The <a href="https://github.com/vanadium/go.ref/blob/master/services/discharger/discharger.vdl">discharge service</a> run by <a href="https://github.com/vanadium/go.ref/tree/master/services/identity/identityd"><code>identityd</code></a> extracts the ID from the caveat
and looks it up in the database. If the database suggests that blessing should
be revoked, it refuses to issue a discharge.</p>
<p>This is implemented in
<a href="https://github.com/vanadium/go.ref/tree/master/services/identity/internal/revocation">services/identity/internal/revocation</a>.</p>
<p>Revocation can be triggered by clicking buttons on <a href="https://dev.v.io/auth/google/listblessings">https://dev.v.io/auth/google/listblessings</a>.</p>

    </main>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-59720824-6', 'auto');
        ga('send', 'pageview');
    </script>
  </body>
</html>
