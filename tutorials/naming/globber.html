<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,
                                   initial-scale=1,
                                   minimum-scale=1,
                                   maximum-scale=1,
                                   user-scalable=no,
                                   minimal-ui">
  
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
  
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
    <title>Globber - Vanadium</title>
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,400,400italic,500,500italic,700,700italic|Source+Code+Pro">
  
    <link rel="stylesheet" href="/css/github.css">
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  
    <script src="/js/react-0.14.3.min.js"></script>
    <script src="/js/react-dom-0.14.3.min.js"></script>
  
    <link rel="apple-touch-icon" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="160x160" href="/favicons/favicon-160x160.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/favicons/favicon-192x192.png">
    <meta name="msapplication-TileColor" content="#00acc1">
    <meta name="msapplication-TileImage" content="/favicons/mstile-144x144.png">
  
    <link rel="stylesheet" href="/css/bundle.css">
    <script src="/js/bundle.js"></script>
  </head>
  <body>
    <header class="mdl-shadow--2dp">
      <div class="row">
        <div class="icon menu"><i class="material-icons">menu</i></div>
        <div class="icon v-icon"><img src="/images/v-icon-white.svg"></div>
        <div class="logo"><a href="/">Vanadium</a></div>
        <div class="spacer"></div>
        <nav>
          <a href="/">Overview</a>
          <a href="/installation/">Installation</a>
          <a href="/tutorials/hello-world.html">Tutorials</a>
        </nav>
      </div>
    </header>
    <div class="sidebar"></div>
    <div class="sidebar-data">
      <a href="/">Overview</a>
      <a href="/installation/">Installation</a>
    
      <a href="#" class="nav">Tutorials</a>
      <nav>
        <a href="/tutorials/hello-world.html">Hello World</a>
        <a href="/tutorials/basics.html">Client/Server Basics</a>
    
        <a href="#" class="nav">Security</a>
        <nav>
          <a href="/tutorials/security/">Overview</a>
          <a href="/tutorials/security/principals-and-blessings.html">Principals and Blessings</a>
      <a href="/tutorials/security/permissions-authorizer.html">Permissions Authorizer</a>
      <a href="/tutorials/security/first-party-caveats.html">Caveats</a>
      <a href="/tutorials/security/third-party-caveats.html">Third-party Caveats</a>
      <a href="/tutorials/security/agent.html">The Agent</a>
      <a href="/tutorials/security/custom-authorizer.html">Custom Authorizer</a>
    </nav>
    
        <a href="#" class="nav">Naming</a>
        <nav>
          <a href="/tutorials/naming/">Overview</a>
          <a href="/tutorials/naming/mount-table.html">The Mount Table</a>
      <a href="/tutorials/naming/namespace.html">Namespaces</a>
      <a href="/tutorials/naming/suffix-part1.html">The Suffix - Part I</a>
      <a href="/tutorials/naming/suffix-part2.html">The Suffix - Part II</a>
      <a href="/tutorials/naming/globber.html">Globber</a>
    </nav>
    
        <a href="#" class="nav">Java</a>
        <nav>
          <a href="/tutorials/java/">Overview</a>
          <a href="/tutorials/java/fortune.html">Fortune in Java</a>
      <a href="/tutorials/java/android.html">Location Service in Android</a>
    </nav>
    
        <a href="#" class="nav">JavaScript</a>
        <nav>
          <a href="/tutorials/javascript/">Overview</a>
          <a href="/tutorials/javascript/hellopeer.html">Hello Peer</a>
      <a href="/tutorials/javascript/fortune.html">Fortune in JS</a>
      <a href="/tutorials/javascript/security.html">Security in JS</a>
    </nav>
    
        <a href="/tutorials/faq.html">Tutorial FAQ</a>
      </nav>
    
      <a href="#" class="nav">Concepts</a>
      <nav>
        <a href="/concepts/rpc.html">RPC System</a>
    <a href="/concepts/naming.html">Naming</a>
    <a href="/concepts/security.html">Security</a>
    <a href="/concepts/device-management.html">Device Management</a>
    <a href="/concepts/syncbase-overview.html">Syncbase</a>
  </nav>
    
      <a href="/example-apps.html">Example Apps</a>
      <a href="/api-reference.html">API Reference</a>
    
      <a href="#" class="nav">Community</a>
      <nav>
        <a href="/community/coding-guidelines.html">Coding Guidelines</a>
    <a href="/community/contributing.html">Contributing</a>
  </nav>
    
      <a href="#" class="nav">Tools</a>
      <nav>
        <a href="/tools/identity-service-faq.html">Vanadium Identity Service</a>
    <a href="/tools/jiri.html">Jiri</a>
    <a href="/tools/services.html">Vanadium Cloud Services</a>
    <a href="/tools/vanadium-chrome-extension.html">Vanadium Chrome Extension</a>
  </nav>
    
      <a href="#" class="nav">Design Docs</a>
      <nav>
        <a href="/designdocs/authentication.html">Authentication Protocol</a>
    <a href="/designdocs/identity-service.html">Identity Service</a>
    <a href="/designdocs/vdl-spec.html">VDL Specification</a>
    <a href="/designdocs/vom-spec.html">VOM Specification</a>
  </nav>
    
      <a href="/glossary.html">Glossary</a>
      <a href="/faq.html">FAQ</a>
      <a href="/tos.html">Terms of Service</a>
    </div>
    <main>
      <h1 class="title">
        
        Globber
      </h1>

      <p class="wherein"><strong>Wherein</strong> you use the Globber interface to create your own server namespace. This is an advanced tutorial.</p>

      <div class="toc"></div>

      <div class="prerequisites">
      <div class="note info"><p><strong>Prerequisites</strong>:<br>
All tutorials require Vanadium <a href="/installation/">installation</a>, and must run in a <a href="/tutorials/faq.html#why-bash-">bash shell</a>.
<br>Further, please <a href="/sh/scenario-f-setup.sh" download="scenario-f-setup.sh"> download this script</a> then <a href="/tutorials/faq.html#why-source-">source</a> it:</p>
<pre><code>source ~/Downloads/scenario-f-setup.sh
</code></pre><p>This command wipes tutorial files and defines shell environment variables. If you start a new terminal, and just want to re-establish the environment, see instructions <a href="/tutorials/setup.html">here</a>.
</p>
<p></p>
<p>
If you would like to generate files from this tutorial without the copy/paste steps, download and source <a href="/sh/tut-completer-globber.sh" download="tut-completer-globber.sh">this script</a>. Files will be created in the <code>$V_TUT</code> <a href="/tutorials/setup.html">directory</a>.
</p>
</div>
</div>

      <h1 id="introduction">Introduction</h1>
<p>In the suffix <a href="/tutorials/naming/suffix-part1.html">Part I</a> and <a href="/tutorials/naming/suffix-part2.html">Part II</a> tutorials, we introduced the concept of
server namespace where multiple services on a single server can be accessed by
name and can be discovered with the <em>namespace glob</em> command.</p>
<p>There are two variants of the <code>Globber</code> interface defined in <a href="https://vanadium.googlesource.com/release.go.v23/+/master/rpc/model.go">rpc/model.go</a>:
<code>AllGlobber</code>, and <code>ChildrenGlobber</code>. <code>AllGlobber</code> is the most flexible option,
but also the most difficult to implement correctly. It is used by specialized
applications like a mount table server. <code>ChildrenGlobber</code> provides most of the
same functionality, but is much easier to implement.</p>
<p>In this tutorial, you will learn how to implement complex namespaces
using the <code>ChildrenGlobber</code> interface.</p>
<h1 id="file-server">File server</h1>
<p>A namespace is a tree structure similar to a file system. In the namespace,
the nodes are service objects and the edges are their names. In a file
system, the nodes are files or directories, and the edges are the file names
and directory names.</p>
<p>Let&#39;s create a server that mirrors a local directory tree in its namespace.</p>
<p>To do this, we&#39;ll use two new services and a custom dispatcher.</p>
<h2 id="services">Services</h2>
<p>Let&#39;s create two services: one for files, one for directories.</p>
<h3 id="file-service">File service</h3>
<!-- @newFileService @test @completer -->
<pre><code> mkdir -p $V_TUT/src/fileserver
 cat - &lt;&lt;EOF &gt;$V_TUT/src/fileserver/file_service.go
package main

import (
  &quot;errors&quot;
  &quot;v.io/v23/context&quot;
  &quot;v.io/v23/rpc&quot;
)

type fileService struct {
  name string
}

func (s *fileService) GetContents(*context.T, rpc.ServerCall) ([]byte, error) {
  return nil, errors.New(&quot;method not implemented&quot;)
}

func (s *fileService) SetContents(*context.T, rpc.ServerCall, []byte) (error) {
  return errors.New(&quot;method not implemented&quot;)
}
EOF
</code></pre><p><strong>Code walk</strong></p>
<p>Since we&#39;re not going to send any calls to the file service in this example, we
leave it unimplemented.</p>
<p>The directory service is the interesting part.</p>
<h3 id="directory-service">Directory service</h3>
<!-- @newDirService @test @completer -->
<pre><code> cat - &lt;&lt;EOF &gt;$V_TUT/src/fileserver/dir_service.go
package main

import (
  &quot;os&quot;
  &quot;v.io/v23/context&quot;
  &quot;v.io/v23/glob&quot;
  &quot;v.io/v23/naming&quot;
  &quot;v.io/v23/rpc&quot;
)

type dirService struct {
  name string
}

func (s *dirService) GlobChildren__(
    _ *context.T, call rpc.GlobChildrenServerCall, m *glob.Element) error {
  f, err := os.Open(s.name)
  if err != nil {
    return err
  }
  defer f.Close()
  fi, err := f.Readdir(0)
  if err != nil {
    return err
  }
  sender := call.SendStream()
  for _, file := range fi {
    name := file.Name()
    if m.Match(name) {
      if err := sender.Send(naming.GlobChildrenReplyName{name}); err != nil {
        return err
      }
    }
  }
  return nil
}
EOF
</code></pre><p><strong>Code walk</strong></p>
<p><code>GlobChildren__</code> is a special method that is automatically detected by the
Vanadium infrastructure. It is called when the server receives a glob request,
e.g. from a client using <code>namespace glob</code> to inspect the server&#39;s namespace.</p>
<p>Service objects that can have children must implement <code>GlobChildren__</code> in
order to have their children appear in the server&#39;s namespace.</p>
<p>The <em>directory service</em>&#39;s implementation iterates through the files in the
directory and sends the ones that match.</p>
<p>Since <em>files</em> don&#39;t have children, the <em>file service</em> doesn&#39;t need to implement
<code>GlobChildren__</code>.</p>
<p>Let&#39;s add a custom dispatcher that uses our two services.</p>
<h2 id="dispatcher">Dispatcher</h2>
<!-- @newDispatcher @test @completer -->
<pre><code> cat - &lt;&lt;EOF &gt;$V_TUT/src/fileserver/dispatcher.go
package main

import (
  &quot;os&quot;
  &quot;path/filepath&quot;
  &quot;strings&quot;
  &quot;v.io/v23/context&quot;
  &quot;v.io/v23/security&quot;
)

type myDispatcher struct {
  rootDir string
}

func (d *myDispatcher) Lookup(
    _ *context.T, suffix string) (interface{}, security.Authorizer, error) {

  relPath := filepath.Join(strings.Split(suffix, &quot;/&quot;)...)
  path := filepath.Join(d.rootDir, relPath)
  fi, err := os.Stat(path)
  switch {
  case err != nil:
    return nil, nil, err
  case fi.IsDir():
    return &amp;dirService{path}, nil, nil
  default:
    return &amp;fileService{path}, nil, nil
  }
}
EOF
</code></pre><p><strong>Code walk</strong></p>
<p>This dispatcher maps the suffix to a file or directory on the local file system.
If it is a file, <code>Lookup</code> returns a <code>fileService</code> object. If it is a directory,
it returns a <code>dirService</code> object.</p>
<p>You might have noticed that we haven&#39;t used any <a href="/glossary.html#vanadium-definition-language-vdl-">VDL</a>-generated stub code.
That&#39;s to keep this example as simple as possible. The main benefit of using
stub code in servers is <a href="https://en.wikipedia.org/wiki/Type_system#Type_checking">static type-checking</a>, which means that the compiler
will enforce that all the method arguments and return values have the types
defined in the <a href="/glossary.html#vanadium-definition-language-vdl-">VDL</a> file. Adding a <a href="/glossary.html#vanadium-definition-language-vdl-">VDL</a> file is left as an exercise.</p>
<p>All we need now is the <code>main</code> function.</p>
<h2 id="main">main</h2>
<!-- @newMain @test @completer -->
<pre><code> cat - &lt;&lt;EOF &gt;$V_TUT/src/fileserver/main.go
package main

import (
  &quot;flag&quot;
  &quot;log&quot;
  &quot;v.io/v23&quot;
  &quot;v.io/x/ref/lib/signals&quot;
  _ &quot;v.io/x/ref/runtime/factories/generic&quot;
)

var (
  name = flag.String(
    &quot;mount-name&quot;, &quot;&quot;, &quot;Name for service in default mount table.&quot;)
  root = flag.String(
    &quot;root-dir&quot;, &quot;.&quot;, &quot;The root directory of the file server.&quot;)
)

func main() {
  ctx, shutdown := v23.Init()
  defer shutdown()

  _, _, err := v23.WithNewDispatchingServer(ctx, *name, &amp;myDispatcher{*root})
  if err != nil {
    log.Panic(&quot;Failure creating server: &quot;, err)
  }
  &lt;-signals.ShutdownOnSignals(ctx)
}
EOF
go build fileserver
</code></pre><p><strong>Code walk</strong></p>
<p>The <code>main</code> function creates the vanadium server that serves our custom
dispatcher.</p>
<h1 id="try-it">Try it</h1>
<p>Start a mount table.</p>
<!-- @startMountTable @test @sleep -->
<pre><code>PORT_MT=23000  # Pick an unused port.
kill_tut_process TUT_PID_MT
$V_BIN/mounttabled \
    --v23.credentials $V_TUT/cred/basics \
    --v23.tcp.address :$PORT_MT &amp;
TUT_PID_MT=$!
export V23_NAMESPACE=/localhost:$PORT_MT
</code></pre><p>Fire up the file server with its root directory set to &quot;$V_TUT&quot;:</p>
<!-- @buildServer @test @completer -->
<pre><code>go install fileserver
</code></pre><!-- @runServer @test @sleep -->
<pre><code>kill_tut_process TUT_PID_SERVER
$V_TUT/bin/fileserver \
    --v23.credentials $V_TUT/cred/basics \
    --mount-name my-file-server \
    --root-dir &quot;$V_TUT&quot; &amp;
TUT_PID_SERVER=$!
</code></pre><p>Let&#39;s take a look at the server&#39;s namespace.</p>
<!-- @glob @test -->
<pre><code>$V_BIN/namespace \
    --v23.credentials $V_TUT/cred/basics \
    glob &quot;my-file-server/...&quot;
</code></pre><p>All the files under &quot;$V_TUT&quot; are in the server&#39;s namespace.</p>
<h1 id="exercises">Exercises</h1>
<ol>
<li><p>What would it take to modify the fortune server from <a href="/tutorials/naming/suffix-part1.html">The suffix - Part I</a>
to organize the fortune services by category, e.g. romance, finance, sports,
etc.?</p>
</li>
<li><p>Finish the implementation of the file and directory services:</p>
<ul>
<li>Write a service definition in <a href="/glossary.html#vanadium-definition-language-vdl-">VDL</a>.</li>
<li>Implement the missing methods.</li>
<li>Write a client for them.</li>
<li>Add your own Authorizer.</li>
</ul>
</li>
</ol>
<h1 id="cleanup">Cleanup</h1>
<!-- @cleanup @test -->
<pre><code>kill_tut_process TUT_PID_SERVER
kill_tut_process TUT_PID_MT
unset V23_NAMESPACE
</code></pre><h1 id="summary">Summary</h1>
<ul>
<li>Services that can have children in the namespace need to implement
the <code>GlobChildren__</code> method.</li>
</ul>

    </main>
    <nav class="previous-next">
      <a href="/tutorials/naming/suffix-part2.html" class="previous">
        <div class="icon"><i class="material-icons">arrow_back</i></div>
        <div class="text-wrapper">
          <small>Previous</small>
          <div class="text">
            <span>The Suffix - Part II</span>
          </div>
        </div>
      </a>
</nav>
  </body>
</html>
