<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,
                                   initial-scale=1,
                                   minimum-scale=1,
                                   maximum-scale=1,
                                   user-scalable=no,
                                   minimal-ui">
  
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
  
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
    <title>The Suffix - Part I - Vanadium</title>
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,400,400italic,500,500italic,700,700italic|Source+Code+Pro">
  
    <link rel="stylesheet" href="/css/github.css">
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  
    <script src="/js/react-0.14.3.min.js"></script>
    <script src="/js/react-dom-0.14.3.min.js"></script>
  
    <link rel="apple-touch-icon" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="160x160" href="/favicons/favicon-160x160.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/favicons/favicon-192x192.png">
    <meta name="msapplication-TileColor" content="#00acc1">
    <meta name="msapplication-TileImage" content="/favicons/mstile-144x144.png">
  
    <link rel="stylesheet" href="/css/bundle.css">
    <script src="/js/bundle.js"></script>
  </head>
  <body>
    <header class="mdl-shadow--2dp">
      <div class="row">
        <div class="icon menu"><i class="material-icons">menu</i></div>
        <div class="icon v-icon"><img src="/images/v-icon-white.svg"></div>
        <div class="logo"><a href="/">Vanadium</a></div>
        <div class="spacer"></div>
        <nav>
          <a href="/">Overview</a>
          <a href="/installation/">Installation</a>
          <a href="/tutorials/hello-world.html">Tutorials</a>
        </nav>
      </div>
    </header>
    <div class="sidebar"></div>
    <div class="sidebar-data">
      <a href="/">Overview</a>
      <a href="/installation/">Installation</a>
    
      <a href="#" class="nav">Tutorials</a>
      <nav>
        <a href="/tutorials/hello-world.html">Hello World</a>
        <a href="/tutorials/basics.html">Client/Server Basics</a>
    
        <a href="#" class="nav">Security</a>
        <nav>
          <a href="/tutorials/security/">Overview</a>
          <a href="/tutorials/security/principals-and-blessings.html">Principals and Blessings</a>
      <a href="/tutorials/security/permissions-authorizer.html">Permissions Authorizer</a>
      <a href="/tutorials/security/first-party-caveats.html">Caveats</a>
      <a href="/tutorials/security/third-party-caveats.html">Third-party Caveats</a>
      <a href="/tutorials/security/agent.html">The Agent</a>
      <a href="/tutorials/security/custom-authorizer.html">Custom Authorizer</a>
    </nav>
    
        <a href="#" class="nav">Naming</a>
        <nav>
          <a href="/tutorials/naming/">Overview</a>
          <a href="/tutorials/naming/mount-table.html">The Mount Table</a>
      <a href="/tutorials/naming/namespace.html">Namespaces</a>
      <a href="/tutorials/naming/suffix-part1.html">The Suffix - Part I</a>
      <a href="/tutorials/naming/suffix-part2.html">The Suffix - Part II</a>
      <a href="/tutorials/naming/globber.html">Globber</a>
    </nav>
    
        <a href="#" class="nav">Java</a>
        <nav>
          <a href="/tutorials/java/">Overview</a>
          <a href="/tutorials/java/fortune.html">Fortune in Java</a>
      <a href="/tutorials/java/android.html">Location Service in Android</a>
    </nav>
    
        <a href="#" class="nav">JavaScript</a>
        <nav>
          <a href="/tutorials/javascript/">Overview</a>
          <a href="/tutorials/javascript/hellopeer.html">Hello Peer</a>
      <a href="/tutorials/javascript/fortune.html">Fortune in JS</a>
      <a href="/tutorials/javascript/security.html">Security in JS</a>
    </nav>
    
        <a href="/tutorials/faq.html">Tutorial FAQ</a>
      </nav>
    
      <a href="#" class="nav">Concepts</a>
      <nav>
        <a href="/concepts/rpc.html">RPC System</a>
    <a href="/concepts/naming.html">Naming</a>
    <a href="/concepts/security.html">Security</a>
    <a href="/concepts/device-management.html">Device Management</a>
    <a href="/concepts/syncbase-overview.html">Syncbase</a>
  </nav>
    
      <a href="/example-apps.html">Example Apps</a>
      <a href="/api-reference.html">API Reference</a>
    
      <a href="#" class="nav">Community</a>
      <nav>
        <a href="/community/coding-guidelines.html">Coding Guidelines</a>
    <a href="/community/contributing.html">Contributing</a>
  </nav>
    
      <a href="#" class="nav">Tools</a>
      <nav>
        <a href="/tools/identity-service-faq.html">Vanadium Identity Service</a>
    <a href="/tools/jiri.html">Jiri</a>
    <a href="/tools/services.html">Vanadium Cloud Services</a>
    <a href="/tools/vanadium-chrome-extension.html">Vanadium Chrome Extension</a>
  </nav>
    
      <a href="#" class="nav">Design Docs</a>
      <nav>
        <a href="/designdocs/authentication.html">Authentication Protocol</a>
    <a href="/designdocs/identity-service.html">Identity Service</a>
    <a href="/designdocs/vdl-spec.html">VDL Specification</a>
    <a href="/designdocs/vom-spec.html">VOM Specification</a>
  </nav>
    
      <a href="/glossary.html">Glossary</a>
      <a href="/faq.html">FAQ</a>
      <a href="/tos.html">Terms of Service</a>
    </div>
    <main>
      <h1 class="title">
        
        The Suffix - Part I
      </h1>

      <p class="wherein"><strong>Wherein</strong> for the first time you build a server with multiple services and use the server&#39;s namespace to address them. This is an advanced tutorial.</p>

      <div class="toc"></div>

      <div class="prerequisites">
      <div class="note info"><p><strong>Prerequisites</strong>:<br>
All tutorials require Vanadium <a href="/installation/">installation</a>, and must run in a <a href="/tutorials/faq.html#why-bash-">bash shell</a>.
<br>Further, please <a href="/sh/scenario-c-setup.sh" download="scenario-c-setup.sh"> download this script</a> then <a href="/tutorials/faq.html#why-source-">source</a> it:</p>
<pre><code>source ~/Downloads/scenario-c-setup.sh
</code></pre><p>This command wipes tutorial files and defines shell environment variables. If you start a new terminal, and just want to re-establish the environment, see instructions <a href="/tutorials/setup.html">here</a>.
</p>
<p></p>
<p>
If you would like to generate files from this tutorial without the copy/paste steps, download and source <a href="/sh/tut-completer-suffix-part1.sh" download="tut-completer-suffix-part1.sh">this script</a>. Files will be created in the <code>$V_TUT</code> <a href="/tutorials/setup.html">directory</a>.
</p>
</div>
</div>

      <h1 id="introduction">Introduction</h1>
<p>In an earlier tutorial, a fortune server was
<a href="/tutorials/naming/mount-table.html#mounting">mounted in a table with the name <code>fortuneAlpha</code></a>.</p>
<p>Since that server contained only one service, clients needed nothing
more than that name, as seen in the mount table, to start using the
service.</p>
<p>If a server contains <em>multiple</em> services, a <strong>suffix</strong> is needed to
select one.  <em>A mount table doesn&#39;t know about suffixes directly.</em>  A server
encapsulates that knowledge in its dispatcher.</p>
<p>Let&#39;s build an example.</p>
<h1 id="requirements">Requirements</h1>
<p>Your company, <em>Prophecies Inc</em>, needs a server to support its team of
prophetic <em>consultants</em> - Cassandra, Nostradamus, etc.  Each consultant
needs its own data and customers.</p>
<ol>
<li><p><em>Many services</em>: To support hiring new consultants, the server
must be able to create fortune services on the fly, each with its
own set of fortunes.</p>
</li>
<li><p><em>Discovery</em>: Customers must be able to discover all the available
services.</p>
</li>
</ol>
<p>To do this, we&#39;ll use a custom dispatcher.</p>
<p>One thing we <em>won&#39;t</em> need is a new service implementation.
The one we have can be used as is.</p>
<h2 id="new-dispatcher">New dispatcher</h2>
<p>Recall the basic program layout:</p>
<p><img src="/images/tut/basic-program-1auth.svg" alt=""></p>
<p>The dispatcher owns all the services in a server.  All previous
tutorials used servers with just one service, so a default dispatcher
was used - its only job was to figure out which method to invoke on
the single service.</p>
<p>In this tutorial, we need a custom dispatcher that maps from
<em>suffixes</em> to services.</p>
<p>Examples below will show a client asking for a fortune from a service,
named <code>prophInc/cassandra</code>.  The resolution process will
determine that <code>prophInc</code> is a name associated with a server
endpoint in a mount table (exactly like <a href="/tutorials/naming/mount-table.html#mounting"><code>fortuneAlpha</code></a>
was earlier), and that <code>cassandra</code> is a suffix.</p>
<p>This suffix <code>cassandra</code> is ultimately passed to the <code>Lookup</code> method in
a <a href="https://godoc.org/v.io/v23/rpc#Dispatcher">dispatcher interface</a>.  <code>Lookup</code> accepts a suffix and returns a
service, and the authorizer that guards it.</p>
<p>The examples will also show that <code>cassandra</code> and all other service
names under <code>prophInc</code> are discoverable in the namespace.</p>
<p>Here&#39;s an implementation satisfying the <em>service</em> requirements:</p>
<!-- @newDispatcher @test @completer -->
<pre><code> cat - &lt;&lt;EOF &gt;$V_TUT/src/fortune/server/util/dispatcher.go
package util

import (
  &quot;errors&quot;
  &quot;strings&quot;
  &quot;sync&quot;
  &quot;fortune/ifc&quot;
  &quot;fortune/service&quot;
  &quot;v.io/v23/context&quot;
  &quot;v.io/v23/rpc&quot;
  &quot;v.io/v23/security&quot;
)

type myDispatcher struct {
  mu sync.Mutex
  registry map[string]interface{}
}

func (d *myDispatcher) Lookup(
    _ *context.T, suffix string) (interface{}, security.Authorizer, error) {
  if strings.Contains(suffix, &quot;/&quot;) {
    return nil, nil, errors.New(&quot;unsupported service name&quot;)
  }
  auth := MakeAuthorizer()
  d.mu.Lock()
  defer d.mu.Unlock()
  if suffix == &quot;&quot; {
    names := make([]string, 0, len(d.registry))
    for name, _ := range d.registry {
      names = append(names, name)
    }
    return rpc.ChildrenGlobberInvoker(names...), auth, nil
  }
  s, ok := d.registry[suffix]
  if !ok {
    // Make the service on first attempt to use.
    s = ifc.FortuneServer(service.Make())
    d.registry[suffix] = s
  }
  return s, auth, nil;
}

func MakeDispatcher() rpc.Dispatcher {
  return &amp;myDispatcher {
    registry: make(map[string]interface{}),
  }
}
EOF
</code></pre><p><strong>Code walk</strong></p>
<p>The server&#39;s <code>root</code> object is accessed with an empty suffix (<em>&quot;&quot;</em>). In
this example, the <code>root</code> object is a <a href="/tutorials/naming/globber.html#introduction">ChildrenGlobber</a> service that makes
the fortune service names discoverable in the server&#39;s namespace.</p>
<p>This dispatcher uses the suffix as a key in a string-to-service map
called <code>registry</code>.  If the map lookup fails, <em>a new service is created
on the fly</em>, and stored in the map using the suffix.</p>
<p>The service object associated with the suffix is returned to the caller
of <code>Lookup</code>.</p>
<p><code>Lookup</code> must also return an authorizer.  A dispatcher&#39;s job is to
determine which authorizer to use with a given service. In this example,
we use the <a href="/tutorials/security/principals-and-blessings.html#default-authorization-policy">default authorizer</a> for simplicity.</p>
<p>Since any server should support concurrent access, its service map should
be protected my a mutex.</p>
<h1 id="try-it">Try it</h1>
<h2 id="principal">Principal</h2>
<p>In this example, we run the client and the server as the same [principal].
We can re-use the <code>tutorial</code> principal from the basics tutorial.</p>
<h2 id="start-the-server">Start the server</h2>
<p>Fire up the server with the new dispatcher code:</p>
<!-- @buildServer @test @completer -->
<pre><code>go install fortune/server
</code></pre><!-- @runServer @test @sleep -->
<pre><code>kill_tut_process TUT_PID_SERVER
$V_TUT/bin/server \
    --v23.credentials $V_TUT/cred/basics \
    --endpoint-file-name $V_TUT/server.txt &amp;
TUT_PID_SERVER=$!
</code></pre><h2 id="hire-cassandra">Hire Cassandra</h2>
<p>Try to run a client as Cassandra:</p>
<div class="note warning"><p>Expect it to fail.</p>
</div>

<!-- @firstTry -->
<pre><code>$V_TUT/bin/client \
    --v23.credentials $V_TUT/cred/basics \
    --server `cat $V_TUT/server.txt`
</code></pre><p>The error is <em>Method does not exist: Get</em>. This is because the root
object, i.e. the one associated with an empty <em>suffix</em>, does not implement
the Fortune interface.</p>
<p>To get past this, specify a <em>suffix</em>:</p>
<!-- @secondTry -->
<pre><code>$V_TUT/bin/client \
    --v23.credentials $V_TUT/cred/basics \
    --server `cat $V_TUT/server.txt`/cassandra
</code></pre><p>That works.  This time the server was specified with the suffix
<code>cassandra</code>.</p>
<p>Likewise, the client should be able to write to that service:</p>
<!-- @writingWorksToo -->
<pre><code>$V_TUT/bin/client \
    --v23.credentials $V_TUT/cred/basics \
    --server `cat $V_TUT/server.txt`/cassandra \
    --add &#39;Do not visit Sparta!&#39;
</code></pre><p>But how would customers know that the <code>cassandra</code> service exists? The
answer is in the server&#39;s namespace.</p>
<p>The server&#39;s namespace is just like the mount table namespace. It allows
the server to publish the name of the services that it hosts. In this
example, this is accomplished by the <a href="/tutorials/naming/globber.html#introduction">ChildrenGlobber</a> service at the
server&#39;s <code>root</code>.</p>
<p><a href="/tutorials/naming/globber.html#introduction">ChildrenGlobber</a> is covered in more details in the <a href="/tutorials/naming/globber.html">Globber</a> tutorial.</p>
<!-- @globServer -->
<pre><code>$V_BIN/namespace \
    --v23.credentials $V_TUT/cred/basics \
    --v23.namespace.root `cat $V_TUT/server.txt` \
    glob &quot;*&quot;
</code></pre><p>Let&#39;s insert a table to make service specifications easier to read.</p>
<h1 id="mount-it">Mount it</h1>
<p>Start a mount table and save it in
<a href="/tutorials/naming/mount-table.html#the-namespace-variable"><code>$V23_NAMESPACE</code></a>:</p>
<!-- @startMountTable @test @sleep -->
<pre><code>PORT_MT=23000  # Pick an unused port.
kill_tut_process TUT_PID_MT
$V_BIN/mounttabled \
    --v23.credentials $V_TUT/cred/basics \
    --v23.tcp.address :$PORT_MT &amp;
TUT_PID_MT=$!
export V23_NAMESPACE=/localhost:$PORT_MT
</code></pre><p>Restart the fortune server to publish itself in the mount table at the
name <code>prophInc</code>:</p>
<!-- @runServer2 @test @sleep -->
<pre><code>kill_tut_process TUT_PID_SERVER
$V_TUT/bin/server \
    --v23.credentials $V_TUT/cred/basics \
    --service-name prophInc \
    --endpoint-file-name $V_TUT/server.txt &amp;
TUT_PID_SERVER=$!
</code></pre><p>Now add a new fortune via a mount table lookup:</p>
<!-- @writeViaTable @test -->
<pre><code>$V_TUT/bin/client \
    --v23.credentials $V_TUT/cred/basics \
    --server prophInc/cassandra \
    --add &#39;Troy is doomed!&#39;
</code></pre><p>It&#39;s this last usage that makes the term <strong>suffix</strong> clear.</p>
<p>The mount name <code>prophInc</code> is followed by the suffix <code>cassandra</code> to
specify which service to access in the server.</p>
<p>Customers can discover the service names via the mount table:</p>
<!-- @globMounttable -->
<pre><code>$V_BIN/namespace \
    --v23.credentials $V_TUT/cred/basics \
    glob &quot;prophInc/*&quot;
</code></pre><p>The server&#39;s namespace transparently extends the mount table&#39;s namespace.</p>
<h1 id="exercises">Exercises</h1>
<h2 id="add-other-services">Add other services</h2>
<p>Create another service for nostradamus and watch it appear in the
namespace next to cassandra.</p>
<!-- @createNostradamusService @test -->
<pre><code>$V_TUT/bin/client \
    --v23.credentials $V_TUT/cred/basics \
    --server prophInc/nostradamus

$V_BIN/namespace \
    --v23.credentials $V_TUT/cred/basics \
    glob &quot;prophInc/*&quot;
</code></pre><h1 id="cleanup">Cleanup</h1>
<!-- @cleanup @test -->
<pre><code>kill_tut_process TUT_PID_SERVER
kill_tut_process TUT_PID_MT
unset V23_NAMESPACE
</code></pre><h1 id="summary">Summary</h1>
<ul>
<li><p>Servers can contain multiple services, identified by a <strong>suffix</strong>.</p>
</li>
<li><p>These services can be published in the server&#39;s namespace.</p>
</li>
</ul>

    </main>
    <nav class="previous-next">
      <a href="/tutorials/naming/namespace.html" class="previous">
        <div class="icon"><i class="material-icons">arrow_back</i></div>
        <div class="text-wrapper">
          <small>Previous</small>
          <div class="text">
            <span>Namespaces</span>
          </div>
        </div>
      </a>
  <a href="/tutorials/naming/suffix-part2.html" class="next">
        <div class="text-wrapper">
          <small>Next</small>
          <div class="text">
            <span>The Suffix - Part II</span>
          </div>
        </div>
        <div class="icon"><i class="material-icons">arrow_forward</i></div>
      </a>
</nav>
  </body>
</html>
