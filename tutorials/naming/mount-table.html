<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,
                                   initial-scale=1,
                                   minimum-scale=1,
                                   maximum-scale=1,
                                   user-scalable=no,
                                   minimal-ui">
  
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
  
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
    <title>The Mount Table - Vanadium</title>
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,400,400italic,500,500italic,700,700italic|Source+Code+Pro">
  
    <link rel="stylesheet" href="/css/github.css">
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  
    <script src="/js/react-0.14.3.min.js"></script>
    <script src="/js/react-dom-0.14.3.min.js"></script>
  
    <link rel="apple-touch-icon" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="160x160" href="/favicons/favicon-160x160.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/favicons/favicon-192x192.png">
    <meta name="msapplication-TileColor" content="#00acc1">
    <meta name="msapplication-TileImage" content="/favicons/mstile-144x144.png">
  
    <link rel="stylesheet" href="/css/bundle.css">
    <script src="/js/bundle.js"></script>
  </head>
  <body>
    <header class="mdl-shadow--2dp">
      <div class="row">
        <div class="icon menu"><i class="material-icons">menu</i></div>
        <div class="icon v-icon"><img src="/images/v-icon-white.svg"></div>
        <div class="logo"><a href="/">Vanadium</a></div>
        <div class="spacer"></div>
        <nav>
          <a href="/">Overview</a>
          <a href="/installation/">Installation</a>
          <a href="/tutorials/hello-world.html">Tutorials</a>
        </nav>
      </div>
    </header>
    <div class="sidebar"></div>
    <div class="sidebar-data">
      <a href="/">Overview</a>
      <a href="/installation/">Installation</a>
    
      <a href="#" class="nav">Tutorials</a>
      <nav>
        <a href="/tutorials/hello-world.html">Hello World</a>
        <a href="/tutorials/basics.html">Client/Server Basics</a>
    
        <a href="#" class="nav">Security</a>
        <nav>
          <a href="/tutorials/security/">Overview</a>
          <a href="/tutorials/security/principals-and-blessings.html">Principals and Blessings</a>
      <a href="/tutorials/security/permissions-authorizer.html">Permissions Authorizer</a>
      <a href="/tutorials/security/first-party-caveats.html">Caveats</a>
      <a href="/tutorials/security/third-party-caveats.html">Third-party Caveats</a>
      <a href="/tutorials/security/agent.html">The Agent</a>
      <a href="/tutorials/security/custom-authorizer.html">Custom Authorizer</a>
    </nav>
    
        <a href="#" class="nav">Naming</a>
        <nav>
          <a href="/tutorials/naming/">Overview</a>
          <a href="/tutorials/naming/mount-table.html">The Mount Table</a>
      <a href="/tutorials/naming/namespace.html">Namespaces</a>
      <a href="/tutorials/naming/suffix-part1.html">The Suffix - Part I</a>
      <a href="/tutorials/naming/suffix-part2.html">The Suffix - Part II</a>
      <a href="/tutorials/naming/globber.html">Globber</a>
    </nav>
    
        <a href="#" class="nav">Java</a>
        <nav>
          <a href="/tutorials/java/">Overview</a>
          <a href="/tutorials/java/fortune.html">Fortune in Java</a>
      <a href="/tutorials/java/android.html">Location Service in Android</a>
    </nav>
    
        <a href="#" class="nav">JavaScript</a>
        <nav>
          <a href="/tutorials/javascript/">Overview</a>
          <a href="/tutorials/javascript/hellopeer.html">Hello Peer</a>
      <a href="/tutorials/javascript/fortune.html">Fortune in JS</a>
      <a href="/tutorials/javascript/security.html">Security in JS</a>
    </nav>
    
        <a href="/tutorials/faq.html">Tutorial FAQ</a>
      </nav>
    
      <a href="#" class="nav">Concepts</a>
      <nav>
        <a href="/concepts/rpc.html">RPC System</a>
    <a href="/concepts/naming.html">Naming</a>
    <a href="/concepts/security.html">Security</a>
    <a href="/concepts/device-management.html">Device Management</a>
    <a href="/concepts/syncbase-overview.html">Syncbase</a>
  </nav>
    
      <a href="/example-apps.html">Example Apps</a>
      <a href="/api-reference.html">API Reference</a>
    
      <a href="#" class="nav">Community</a>
      <nav>
        <a href="/community/coding-guidelines.html">Coding Guidelines</a>
    <a href="/community/contributing.html">Contributing</a>
  </nav>
    
      <a href="#" class="nav">Tools</a>
      <nav>
        <a href="/tools/identity-service-faq.html">Vanadium Identity Service</a>
    <a href="/tools/jiri.html">Jiri</a>
    <a href="/tools/services.html">Vanadium Cloud Services</a>
    <a href="/tools/vanadium-chrome-extension.html">Vanadium Chrome Extension</a>
  </nav>
    
      <a href="#" class="nav">Design Docs</a>
      <nav>
        <a href="/designdocs/authentication.html">Authentication Protocol</a>
    <a href="/designdocs/identity-service.html">Identity Service</a>
    <a href="/designdocs/vdl-spec.html">VDL Specification</a>
    <a href="/designdocs/vom-spec.html">VOM Specification</a>
  </nav>
    
      <a href="/glossary.html">Glossary</a>
      <a href="/faq.html">FAQ</a>
      <a href="/tos.html">Terms of Service</a>
    </div>
    <main>
      <h1 class="title">
        
        The Mount Table
      </h1>

      <p class="wherein"><strong>Wherein</strong> you use the basic tools of service discovery.</p>

      <div class="toc"></div>

      <div class="prerequisites">
      <div class="note info"><p><strong>Prerequisites</strong>:<br>
All tutorials require Vanadium <a href="/installation/">installation</a>, and must run in a <a href="/tutorials/faq.html#why-bash-">bash shell</a>.
<br>Further, please <a href="/sh/scenario-b-setup.sh" download="scenario-b-setup.sh"> download this script</a> then <a href="/tutorials/faq.html#why-source-">source</a> it:</p>
<pre><code>source ~/Downloads/scenario-b-setup.sh
</code></pre><p>This command wipes tutorial files and defines shell environment variables. If you start a new terminal, and just want to re-establish the environment, see instructions <a href="/tutorials/setup.html">here</a>.
</p>
<p></p>
<p></p>
</div>
</div>

      <h1 id="introduction">Introduction</h1>
<p>This tutorial focusses on using a mount table with the <em>fortune</em>
server and client programs you made in the <a href="/tutorials/basics.html">basics tutorial</a>, and just
re-made with the prerequisites script above.</p>
<h2 id="credentials">Credentials</h2>
<p>To keep security simple initially, all processes here will
<a href="/tutorials/basics.html#authorization">use the same credentials</a>.  Further, credentials will be specified
using this environment variable:</p>
<!-- @setCredentials @test -->
<pre><code>export V23_CREDENTIALS=$V_TUT/cred/basics
</code></pre><p>Vanadium programs consult this environment variable when the
credentials aren&#39;t specified by using the <code>--v23.credentials</code> flag,
or by using a <a href="/tutorials/security/agent.html">security agent</a>.</p>
<h1 id="start-a-table">Start a table</h1>
<p>When you ran the fortune server in the <a href="/tutorials/basics.html">basics tutorial</a>, you told it
to write its network <a href="/glossary.html#endpoint">endpoint</a> to a file, then you told the client to
read that file so it would know where to find the server.</p>
<p>Let&#39;s do that again, but this time instead of using a file to hold the
endpoint, we&#39;ll use a server.</p>
<p>The server is called a <em>mount table</em>, and its executable has the name
<code>mounttabled</code>:</p>
<!-- @startMountTable @test @sleep -->
<pre><code>PORT_MT=23000  # Pick an unused port.
kill_tut_process TUT_PID_MT
$V_BIN/mounttabled --v23.tcp.address :$PORT_MT &amp;
TUT_PID_MT=$!
</code></pre><p>A mount table happens to be a Vanadium service.  This means the <a href="/tutorials/basics.html#the-vrpc-client">vrpc</a>
program can report its <a href="https://vanadium.googlesource.com/release.go.v23/+/master/services/mounttable/service.vdl">VDL interface</a>:</p>
<!-- @queryMountTable @test -->
<pre><code>$V_BIN/vrpc signature /localhost:$PORT_MT
</code></pre><p>It also means that the mount table has a <a href="/glossary.html#principal">principal</a> - it must run
with credentials.  Since the <code>--v23.credentials</code> flag wasn&#39;t
specified at startup, the Vanadium runtime consulted the environment
variable <code>V23_CREDENTIALS</code> (set above) to get the credentials.</p>
<p>Had credentials been left unspecified, randomly generated credentials
would have been used, and the problems reviewed at the
<a href="/tutorials/basics.html#authorization">end of the basics tutorial</a> would happen below
when processes start talking to each other.  Mount table security will
be discussed in later tutorial.</p>
<h1 id="the-namespace-client">The namespace client</h1>
<p>The table is up, but empty.</p>
<p>Start the existing fortune server binary, so we have a service to put
in the table:</p>
<!-- @startFortune @test @sleep -->
<pre><code>kill_tut_process TUT_PID_S1
$V_TUT/bin/server --endpoint-file-name $V_TUT/s1.txt &amp;
TUT_PID_S1=$!
</code></pre><h2 id="mounting">Mounting</h2>
<p><code>namespace</code> is a command line client dedicated to manipulating mount
tables.  The following mounts the server at the name <code>fortuneAlpha</code>.</p>
<!-- @mountFortune @test -->
<pre><code>$V_BIN/namespace \
    --v23.namespace.root /localhost:$PORT_MT \
    mount fortuneAlpha `cat $V_TUT/s1.txt` 100m
</code></pre><p>The flag <code>--v23.namespace.root</code> specifies which <strong>mount table</strong> to
use.  The flag is available in all Vanadium programs.</p>
<p>In Vanadium, services live in hierachical trees called the
<strong>namespaces</strong>.  The <em>root</em> node of a tree is a mount table, hence the
flag name.  Other nodes are either services (leaves) or other mount
tables.</p>
<h2 id="globbing">Globbing</h2>
<p><em>To <a href="http://en.wikipedia.org/wiki/Glob_%28programming%29">glob</a></em> is to use a character pattern to select strings from a set.</p>
<p>The command <code>namespace glob *</code> reports the names of <em>all</em> known
names:</p>
<!-- @queryMountTable @test -->
<pre><code>$V_BIN/namespace \
    --v23.namespace.root /localhost:$PORT_MT \
    glob -l &#39;*&#39;
</code></pre><p>There&#39;s just one name: <code>fortuneAlpha</code>.  Use of the flag <code>-l</code>
triggers additional output; you see the name&#39;s <a href="/glossary.html#endpoint">endpoint</a>,
and you see it will expire (will be dropped from the table) in
about one hundred minutes.  That&#39;s what the <code>100m</code> meant in the
<code>mount</code> command above.</p>
<h2 id="resolution">Resolution</h2>
<p>When a name is known, and you just want to resolve it to an
<a href="/glossary.html#endpoint">endpoint</a>, use <code>namespace resolve {name}</code>:</p>
<!-- @resolveFortune @test -->
<pre><code>$V_BIN/namespace \
    --v23.namespace.root /localhost:$PORT_MT \
    resolve fortuneAlpha
</code></pre><p>The output should match the endpoint recorded in <code>$V_TUT/s1.txt</code>:</p>
<!-- @lookAtEndpoint @test -->
<pre><code>cat $V_TUT/s1.txt
</code></pre><h1 id="name-usage">Name usage</h1>
<p>Recapping, here&#39;s how you connected the fortune client to the fortune
server using a full service endpoint name in the <a href="/tutorials/basics.html">basics tutorial</a>:</p>
<!-- @reviewFortune @test -->
<pre><code>$V_TUT/bin/client --server `cat $V_TUT/s1.txt`
</code></pre><p>Now you can use the name <code>fortuneAlpha</code> instead:</p>
<!-- @fortuneWithTable @test -->
<pre><code>$V_TUT/bin/client \
    --v23.namespace.root /localhost:$PORT_MT \
    --server fortuneAlpha
</code></pre><p>The <code>client</code> program didn&#39;t need to be recompiled to allow this new
usage because Vanadium code in the client interprets the value
of the <code>--server</code> flag.</p>
<p>In the first command, <code>--server</code>&#39;s value was something like
<code>/@3@tcp@127.0.0.1:...</code>.  The leading <code>/</code> caused it to be interpreted
directly as an <a href="/glossary.html#endpoint">endpoint</a> rather than as a service name to be used as
a lookup key.  That means communication attempts begin immediately,
and if the string doesn&#39;t refer to a live service, you won&#39;t know it
until the attempts timeout.</p>
<p>In the second command, <code>--server</code>&#39;s value was just <code>fortuneAlpha</code>.
Strings that don&#39;t start with <code>/</code> are treated as service names needing
a lookup.  If a lookup fails, the client will know it immediately, and
may retry depending on various configurations.</p>
<h2 id="the-namespace-variable">The namespace variable</h2>
<p>This tutorial uses only one mount table, and it&#39;s repetitive to
constantly specify the <code>--v23.namespace.root</code> flag with the same
value.</p>
<p>Ommiting the flag will trigger use the following shell variable:</p>
<!-- @setNamespace @test -->
<pre><code>export V23_NAMESPACE=/localhost:$PORT_MT
</code></pre><p>Now a fortune retrieval is as simple as:</p>
<!-- @fortuneWithTableAgain @test -->
<pre><code>$V_TUT/bin/client --server fortuneAlpha
</code></pre><h2 id="flags-vs-variables">Flags vs. variables</h2>
<p>In Vanadium, flag values, when specified, always trump the values of
corresponding shell variables.  So <code>--v23.namespace.root</code> trumps
<code>$V23_NAMESPACE</code>, and <code>--v23.credentials</code> trumps <code>$V23_CREDENTIALS</code>.</p>
<p>Shell variable values, in turn, trump default behavior.</p>
<p>The default behavior for unspecified namespace is to use a public
mount table maintained by the v23 team.  Circa April 2015 the service
runs at <code>ns.dev.v.io:8101</code>.  The port serves Vanadium protocol, not
HTTP.</p>
<p>The default behavior for unspecified credentials is to generate
<a href="/tutorials/basics.html#authorization">random credentials</a>.</p>
<h2 id="many-names-one-endpoint">Many names, one endpoint</h2>
<p>A single service instance can have multiple names.  Mount the same
service again, with the name <code>fortuneBeta</code>, and a brief time to live:</p>
<!-- @mountFortune @test -->
<pre><code>$V_BIN/namespace mount fortuneBeta `cat $V_TUT/s1.txt` 5m
</code></pre><p>Do the <code>glob</code> again:</p>
<!-- @doTheGlob @test -->
<pre><code>$V_BIN/namespace glob -l &#39;*&#39;
</code></pre><p>You&#39;ll see two names, with the same endpoint, but with <em>different</em>
expiration times.  Later you&#39;ll find the names can have different
access control lists as well.</p>
<p>Confirm that the second name works:</p>
<!-- @fortuneViaOtherName @test -->
<pre><code>$V_TUT/bin/client --server fortuneBeta
</code></pre><h2 id="many-endpoints-one-name">Many endpoints, one name</h2>
<p>Start a <strong>second instance</strong> of the fortune server:</p>
<!-- @startAnotherFortune @test @sleep -->
<pre><code>kill_tut_process TUT_PID_S2
$V_TUT/bin/server --endpoint-file-name $V_TUT/s2.txt &amp;
TUT_PID_S2=$!
</code></pre><p>Mount it on the (original) name <code>fortuneAlpha</code>:</p>
<!-- @mountFortuneAgain @test -->
<pre><code>$V_BIN/namespace mount fortuneAlpha `cat $V_TUT/s2.txt` 100m
</code></pre><p>List the names again:</p>
<!-- @doTheGlob @test -->
<pre><code>$V_BIN/namespace glob -l &#39;*&#39;
</code></pre><p>Now the name <code>fortuneAlpha</code> reports two endpoints, with distinct
expiration times.</p>
<p>This is a means to implement redundancy, load sharing, etc.  The mount
table will resolve specific requests to one endpoint, but multiple
endpoints let it assign a server using simple rotation, or by using
load, response times, etc.</p>
<p>Confirm that <code>fortuneAlpha</code> still works (with two endpoints):</p>
<!-- @fortuneViaOriginalName @test -->
<pre><code>$V_TUT/bin/client --server fortuneAlpha
</code></pre><p>Now kill the original server:</p>
<!-- @killTutS1 @test -->
<pre><code>kill_tut_process TUT_PID_S1
</code></pre><p>And retry the request:</p>
<!-- @fortuneFromS2 @test -->
<pre><code>$V_TUT/bin/client --server fortuneAlpha
</code></pre><p>You should still get a fortune, but this time it can only come from
the second server instance.</p>
<p>The mount table will still report the dangling endpoint until it
expires, as it might come back to life.</p>
<h1 id="unmounting">Unmounting</h1>
<p>Unmounting works as you might expect:</p>
<!-- @unmountFortune @test -->
<pre><code>$V_BIN/namespace unmount fortuneAlpha `cat $V_TUT/s1.txt`
$V_BIN/namespace unmount fortuneBeta `cat $V_TUT/s1.txt`
</code></pre><p>That leaves only server 2 in the table (with the name <code>fortuneAlpha</code>):</p>
<!-- @globAfterUnmountFortune @test -->
<pre><code>$V_BIN/namespace glob -l &#39;*&#39;
</code></pre><p>The reported endpoint should match the stored endpoint of server 2:</p>
<!-- @catS2Name @test -->
<pre><code>cat $V_TUT/s2.txt
</code></pre><p>Unmount it as well:
<!-- @globAfterUnmountFortune @test --></p>
<pre><code>$V_BIN/namespace unmount fortuneAlpha `cat $V_TUT/s2.txt`
</code></pre><div class="note warning"><h2 id="optionally-observe-failure">Optionally observe failure</h2>
<p>Optionally, confirm that client use of the unmounted name <code>fortuneAlpha</code> fails.
Feel free to interrupt before the retry attempts exhaust themselves.</p>
<pre><code>$V_TUT/bin/client --server fortuneAlpha
</code></pre></div>


<h1 id="cleanup">Cleanup</h1>
<!-- @cleanup @test -->
<pre><code>kill_tut_process TUT_PID_S2
kill_tut_process TUT_PID_MT
unset V23_CREDENTIALS
unset V23_NAMESPACE
</code></pre><h1 id="summary">Summary</h1>
<ul>
<li><p>A service called <code>mounttabled</code> is a Vanadium service that helps
Vanadium services find each other.</p>
</li>
<li><p>The command-line client <code>namespace</code> performs
general operations on an instance of <code>mounttabled</code>.</p>
</li>
<li><p>The shell variables <code>$V23_CREDENTIALS</code> and <code>$V23_NAMESPACE</code>
can be used instead of flags to configure a Vanadium program.</p>
</li>
</ul>

    </main>
    <nav class="previous-next">
      <a href="/tutorials/naming/namespace.html" class="next">
        <div class="text-wrapper">
          <small>Next</small>
          <div class="text">
            <span>Namespaces</span>
          </div>
        </div>
        <div class="icon"><i class="material-icons">arrow_forward</i></div>
      </a>
</nav>
  </body>
</html>
