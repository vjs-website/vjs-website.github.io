<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,
                                   initial-scale=1,
                                   minimum-scale=1,
                                   maximum-scale=1,
                                   user-scalable=no,
                                   minimal-ui">
  
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
  
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
    <title>The Suffix - Part II - Vanadium</title>
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,400,400italic,500,500italic,700,700italic|Source+Code+Pro">
  
    <link rel="stylesheet" href="/css/github.css">
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  
    <script src="/js/react-0.14.3.min.js"></script>
    <script src="/js/react-dom-0.14.3.min.js"></script>
  
    <link rel="apple-touch-icon" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="160x160" href="/favicons/favicon-160x160.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/favicons/favicon-192x192.png">
    <meta name="msapplication-TileColor" content="#00acc1">
    <meta name="msapplication-TileImage" content="/favicons/mstile-144x144.png">
  
    <link rel="stylesheet" href="/css/bundle.css">
    <script src="/js/bundle.js"></script>
  </head>
  <body>
    <header class="mdl-shadow--2dp">
      <div class="row">
        <div class="icon menu"><i class="material-icons">menu</i></div>
        <div class="icon v-icon"><img src="/images/v-icon-white.svg"></div>
        <div class="logo"><a href="/">Vanadium</a></div>
        <div class="spacer"></div>
        <nav>
          <a href="/">Overview</a>
          <a href="/installation/">Installation</a>
          <a href="/tutorials/hello-world.html">Tutorials</a>
        </nav>
      </div>
    </header>
    <div class="sidebar"></div>
    <div class="sidebar-data">
      <a href="/">Overview</a>
      <a href="/installation/">Installation</a>
    
      <a href="#" class="nav">Tutorials</a>
      <nav>
        <a href="/tutorials/hello-world.html">Hello World</a>
        <a href="/tutorials/basics.html">Client/Server Basics</a>
    
        <a href="#" class="nav">Security</a>
        <nav>
          <a href="/tutorials/security/">Overview</a>
          <a href="/tutorials/security/principals-and-blessings.html">Principals and Blessings</a>
      <a href="/tutorials/security/permissions-authorizer.html">Permissions Authorizer</a>
      <a href="/tutorials/security/first-party-caveats.html">Caveats</a>
      <a href="/tutorials/security/third-party-caveats.html">Third-party Caveats</a>
      <a href="/tutorials/security/agent.html">The Agent</a>
      <a href="/tutorials/security/custom-authorizer.html">Custom Authorizer</a>
    </nav>
    
        <a href="#" class="nav">Naming</a>
        <nav>
          <a href="/tutorials/naming/">Overview</a>
          <a href="/tutorials/naming/mount-table.html">The Mount Table</a>
      <a href="/tutorials/naming/namespace.html">Namespaces</a>
      <a href="/tutorials/naming/suffix-part1.html">The Suffix - Part I</a>
      <a href="/tutorials/naming/suffix-part2.html">The Suffix - Part II</a>
      <a href="/tutorials/naming/globber.html">Globber</a>
    </nav>
    
        <a href="#" class="nav">Java</a>
        <nav>
          <a href="/tutorials/java/">Overview</a>
          <a href="/tutorials/java/fortune.html">Fortune in Java</a>
      <a href="/tutorials/java/android.html">Location Service in Android</a>
    </nav>
    
        <a href="#" class="nav">JavaScript</a>
        <nav>
          <a href="/tutorials/javascript/">Overview</a>
          <a href="/tutorials/javascript/hellopeer.html">Hello Peer</a>
      <a href="/tutorials/javascript/fortune.html">Fortune in JS</a>
      <a href="/tutorials/javascript/security.html">Security in JS</a>
    </nav>
    
        <a href="/tutorials/faq.html">Tutorial FAQ</a>
      </nav>
    
      <a href="#" class="nav">Concepts</a>
      <nav>
        <a href="/concepts/rpc.html">RPC System</a>
    <a href="/concepts/naming.html">Naming</a>
    <a href="/concepts/security.html">Security</a>
    <a href="/concepts/device-management.html">Device Management</a>
    <a href="/concepts/syncbase-overview.html">Syncbase</a>
  </nav>
    
      <a href="/example-apps.html">Example Apps</a>
      <a href="/api-reference.html">API Reference</a>
    
      <a href="#" class="nav">Community</a>
      <nav>
        <a href="/community/coding-guidelines.html">Coding Guidelines</a>
    <a href="/community/contributing.html">Contributing</a>
  </nav>
    
      <a href="#" class="nav">Tools</a>
      <nav>
        <a href="/tools/identity-service-faq.html">Vanadium Identity Service</a>
    <a href="/tools/jiri.html">Jiri</a>
    <a href="/tools/services.html">Vanadium Cloud Services</a>
    <a href="/tools/vanadium-chrome-extension.html">Vanadium Chrome Extension</a>
  </nav>
    
      <a href="#" class="nav">Design Docs</a>
      <nav>
        <a href="/designdocs/authentication.html">Authentication Protocol</a>
    <a href="/designdocs/identity-service.html">Identity Service</a>
    <a href="/designdocs/vdl-spec.html">VDL Specification</a>
    <a href="/designdocs/vom-spec.html">VOM Specification</a>
  </nav>
    
      <a href="/glossary.html">Glossary</a>
      <a href="/faq.html">FAQ</a>
      <a href="/tos.html">Terms of Service</a>
    </div>
    <main>
      <h1 class="title">
        
        The Suffix - Part II
      </h1>

      <p class="wherein"><strong>Wherein</strong> you add fine-grained security to control access to your multiple services. This is an advanced tutorial.</p>

      <div class="toc"></div>

      <div class="prerequisites">
      <div class="note info"><p><strong>Prerequisites</strong>:<br>
All tutorials require Vanadium <a href="/installation/">installation</a>, and must run in a <a href="/tutorials/faq.html#why-bash-">bash shell</a>.
<br>Further, please <a href="/sh/scenario-f-setup.sh" download="scenario-f-setup.sh"> download this script</a> then <a href="/tutorials/faq.html#why-source-">source</a> it:</p>
<pre><code>source ~/Downloads/scenario-f-setup.sh
</code></pre><p>This command wipes tutorial files and defines shell environment variables. If you start a new terminal, and just want to re-establish the environment, see instructions <a href="/tutorials/setup.html">here</a>.
</p>
<p></p>
<p>
If you would like to generate files from this tutorial without the copy/paste steps, download and source <a href="/sh/tut-completer-suffix-part2.sh" download="tut-completer-suffix-part2.sh">this script</a>. Files will be created in the <code>$V_TUT</code> <a href="/tutorials/setup.html">directory</a>.
</p>
</div>
</div>

      <h1 id="introduction">Introduction</h1>
<p>In the suffix <a href="/tutorials/naming/suffix-part1.html">Part I</a>, you built a fortune server with multiple services.
For simplicity, this server used the <a href="/tutorials/security/principals-and-blessings.html#default-authorization-policy">default authorizer</a> and only allowed
calls from the same principal.</p>
<p>In Part II, you will learn how to implement a fine-grained access control
policy for your services.</p>
<p>Let&#39;s add some requirements to our Part I example.</p>
<h1 id="requirements">Requirements</h1>
<p>Your company, <em>Prophecies Inc</em>, needs a server to support its team of
prophetic <em>consultants</em> - Cassandra, Nostradamus, etc.  Each
consultant needs its own data and customers.</p>
<ol>
<li><p><em>Many services</em>: To support hiring new consultants, the server
must be able to create fortune services on the fly, each with its
own set of fortunes. [<em>done</em>]</p>
</li>
<li><p><em>Discovery</em>: Customers must be able to discover all the available
services. [<em>done</em>]</p>
</li>
<li><p><em>Consultants</em>: Those blessed by the company.  Only they can
create a service or add a fortune to it. [<em>new</em>]</p>
</li>
<li><p><em>Customers</em>: Those blessed by a particular consultant.  Only they
can get a fortune from that consultant. [<em>new</em>]</p>
</li>
<li><p><em>Internships</em>: A consultant can delegate their ability to an
apprentice fortune teller. [<em>new</em>]</p>
</li>
</ol>
<p>To meet these requirements, we&#39;ll use a custom authorizer.</p>
<p>We <em>won&#39;t</em> need a new dispatcher, or a new service implementation.</p>
<h2 id="new-authorizer">New authorizer</h2>
<p>In <a href="/tutorials/naming/suffix-part1.html">Part I</a> and other tutorials we encountered the so-called <a href="/tutorials/security/principals-and-blessings.html#default-authorization-policy">default authorizer</a>
and the <a href="/tutorials/security/permissions-authorizer.html">Permissions authorizer</a>. The requirements here are out of scope for
the default authorizer. The Permissions authorizer at the time of writing is
configured at server start time, before we know the names of the
services that the server will be running, so it falls short as well.</p>
<p>The following implementation of the <a href="https://godoc.org/v.io/v23/security#Authorizer">authorizer interface</a> attempts to
make a naming policy (both for services and blessings) that makes the
authorization scheme easy to understand.  One look at a blessing
name should make the access of the blessing obvious.</p>
<!-- @newAuthorizer @test @completer -->
<pre><code> cat - &lt;&lt;EOF &gt;$V_TUT/src/fortune/server/util/authorizer.go
package util

import (
  &quot;strings&quot;
  &quot;fortune/ifc&quot;
  &quot;errors&quot;
  &quot;v.io/v23/context&quot;
  &quot;v.io/v23/security&quot;
  &quot;v.io/v23/security/access&quot;
)

type myAuthorizer struct {}

// The method being called - is it tagged?
func isTagged(call security.Call, tag string) (bool) {
  for _, mTag := range call.MethodTags() {
    if tag == mTag.RawString() {
      return true
    }
  }
  return false
}

func join(args ...string) security.BlessingPattern {
  return security.BlessingPattern(strings.Join(args, security.ChainSeparator))
}

func (my myAuthorizer) Authorize(ctx *context.T, call security.Call) error {
  if call.Suffix() == &quot;&quot; {
    return nil
  }
  var (
    serverBlessings    = security.LocalBlessingNames(ctx, call)
    clientBlessings, _ = security.RemoteBlessingNames(ctx, call)
    consultant         = join(serverBlessings[0], &quot;consultant&quot;, call.Suffix())
    intern             = join(string(consultant), &quot;intern&quot;)
    customer           = join(string(consultant), &quot;cust&quot;)
  )
  if consultant.MakeNonExtendable().MatchedBy(clientBlessings...) {
    return nil
  }
  if intern.MatchedBy(clientBlessings...) {
    return nil
  }
  if (isTagged(call, string(ifc.Reader)) ||
      isTagged(call, string(access.Resolve))) &amp;&amp; customer.MatchedBy(clientBlessings...) {
    return nil
  }

  return errors.New(&quot;access denied.&quot;)
}

func MakeAuthorizer() security.Authorizer {
  return &amp;myAuthorizer {}
}
EOF
</code></pre><p><strong>Code walk</strong></p>
<p>In the body of <code>Authorize</code>, the first <em>if</em> grants full access
to the <code>root</code> service to everyone. Remember that the <code>root</code> service
in our dispatcher is the ChildrenGlobber that publishes the name
of the fortune services in the server&#39;s namespace.</p>
<p>The second <em>if</em> grants full access to a given service if the
client has a blessing of the form <code>{server}:consultant:{service}</code>.</p>
<p>The third <em>if</em> allows interns the same sort of service-specific
access if their blessing has a particular pattern.</p>
<p>The fourth <em>if</em> allows customers to get <em>read-only</em> access, exploiting
the <code>Reader</code> annotation in the <a href="/tutorials/security/permissions-authorizer.html#permissions-policy">fortune VDL</a> file.</p>
<h1 id="try-it">Try it</h1>
<h2 id="new-principals">New principals</h2>
<p>First, initialize some principals.
<!-- @createProphIncPrincipal @test --></p>
<pre><code>$V_BIN/principal create --overwrite \
    $V_TUT/cred/prophInc prophInc
$V_BIN/principal create --overwrite \
    $V_TUT/cred/cassandra cassandra
$V_BIN/principal create --overwrite \
    $V_TUT/cred/nostradamus nostradamus
$V_BIN/principal create --overwrite \
    $V_TUT/cred/alice alice
$V_BIN/principal create --overwrite \
    $V_TUT/cred/bob bob
</code></pre><h2 id="start-the-server">Start the server</h2>
<p>Fire up the server with the new authorizer code, and mount it in a
mount table:</p>
<!-- @buildServer @test @completer -->
<pre><code>go install fortune/server
</code></pre><p>Start the fortune server.</p>
<!-- @runServer @test @sleep -->
<pre><code>kill_tut_process TUT_PID_SERVER
$V_TUT/bin/server \
    --v23.credentials $V_TUT/cred/prophInc \
    --endpoint-file-name $V_TUT/server.txt &amp;
TUT_PID_SERVER=$!
</code></pre><p>Start a mount table.</p>
<!-- @startMountTable @test @sleep -->
<pre><code>PORT_MT=23000  # Pick an unused port.
kill_tut_process TUT_PID_MT
$V_BIN/mounttabled \
    --v23.credentials $V_TUT/cred/prophInc \
    --v23.tcp.address :$PORT_MT &amp;
TUT_PID_MT=$!
export V23_NAMESPACE=/localhost:$PORT_MT
</code></pre><p>Add the fortune server to the mount table at the name <code>prophInc</code>:</p>
<!-- @mountFortune @test -->
<pre><code>$V_BIN/namespace \
    --v23.credentials $V_TUT/cred/prophInc \
    mount prophInc `cat $V_TUT/server.txt` 2h
</code></pre><h2 id="hire-cassandra">Hire Cassandra</h2>
<p>Try to run a client as Cassandra:</p>
<div class="note warning"><p>Expect it to fail.</p>
</div>

<!-- @firstTryAsCassandra -->
<pre><code>$V_TUT/bin/client \
    --v23.credentials $V_TUT/cred/cassandra \
    --server prophInc/cassandra
</code></pre><p>The error message will be something like: <em>Client doesn&#39;t trust the
server.</em> That&#39;s a runtime error - the code you wrote above hasn&#39;t even
been run yet.  Cassandra has no knowledege of Prophecies Inc.</p>
<p>You&#39;ve <a href="/tutorials/security/principals-and-blessings.html#blessings">learned how to fix this</a>; Cassandra needs
a blessing from the server&#39;s principal:</p>
<!-- @blessCassandra @test -->
<pre><code>$V_BIN/principal bless \
    --v23.credentials $V_TUT/cred/prophInc \
    --for=24h $V_TUT/cred/cassandra consultant:cassandra | \
        $V_BIN/principal set \
            --v23.credentials $V_TUT/cred/cassandra \
            forpeer - prophInc
</code></pre><p>Try again.</p>
<!-- @secondTryAsCassandra -->
<pre><code>$V_TUT/bin/client \
    --v23.credentials $V_TUT/cred/cassandra \
    --server prophInc/cassandra
</code></pre><p>That works.</p>
<p>Likewise, the client should be able to write to that service:</p>
<!-- @writingFails -->
<pre><code>$V_TUT/bin/client \
    --v23.credentials $V_TUT/cred/cassandra \
    --server prophInc/cassandra \
    --add &#39;Do not visit Sparta!&#39;
</code></pre><h1 id="more-use-cases">More use cases</h1>
<p><img src="/images/tut/suffix-scenario.svg" alt=""></p>
<h2 id="hire-nostradamus">Hire Nostradamus</h2>
<p>What can Nostradamus do at this point?
Nothing, since the company hasn&#39;t blessed him.
Let&#39;s do that:</p>
<!-- @blessNostradamus @test -->
<pre><code>$V_BIN/principal bless \
  --v23.credentials $V_TUT/cred/prophInc \
  --for=24h $V_TUT/cred/nostradamus consultant:nostradamus |\
        $V_BIN/principal set \
            --v23.credentials $V_TUT/cred/nostradamus \
            forpeer - prophInc
</code></pre><p>Now verify that Nostradamus can read/write his own service:</p>
<!-- @firstTryAsNostradamus @test -->
<pre><code>$V_TUT/bin/client \
    --v23.credentials $V_TUT/cred/nostradamus \
    --server prophInc/nostradamus
</code></pre><p>But Nostradamus <em>should not be able to read his colleague Cassandra&#39;s service</em>:</p>
<div class="note warning"><p>This should fail.</p>
</div>

<!-- @secondTryAsNostradamus  -->
<pre><code>$V_TUT/bin/client \
    --v23.credentials $V_TUT/cred/nostradamus \
    --server prophInc/cassandra
</code></pre><p>Also, notice that Nostradadus doesn&#39;t see cassandra in the namespace.</p>
<!-- @globServer @test -->
<pre><code>$V_BIN/namespace \
    --v23.credentials $V_TUT/cred/nostradamus \
    glob &quot;prophInc/*&quot;
</code></pre><h2 id="interns">Interns</h2>
<p>Suppose Cassandra needs some vacation, and wants Alice to take over.
Alice currently has no blessings relevant to the running service, so
can do nothing.</p>
<p>Cassandra can change this by hiring Alice as an intern.  Cassandra can
do so without access to the credentials belonging to Prophesies
Inc.</p>
<!-- @cassandraDelegatesToAlice @test -->
<pre><code>$V_BIN/principal get \
   --v23.credentials $V_TUT/cred/cassandra \
   forpeer prophInc | \
       $V_BIN/principal bless \
         --v23.credentials $V_TUT/cred/cassandra \
         --with=- --for=24h $V_TUT/cred/alice intern:alice |\
               $V_BIN/principal set \
                  --v23.credentials $V_TUT/cred/alice \
                  forpeer - prophInc
</code></pre><p>Now, like Cassandra, Alice can read and write Cassandra&#39;s service:</p>
<!-- @firstTryAsAlice @test -->
<pre><code>$V_TUT/bin/client \
    --v23.credentials $V_TUT/cred/alice \
    --server prophInc/cassandra
</code></pre><p>But Alice cannot access Nostradamus&#39; service:</p>
<div class="note warning"><p>This should fail.</p>
</div>

<!-- @secondTryAsAlice  -->
<pre><code>$V_TUT/bin/client \
    --v23.credentials $V_TUT/cred/alice \
    --server prophInc/nostradamus
</code></pre><p>And Alice can only see cassandra in the namespace:
<!-- @globServer @test --></p>
<pre><code>$V_BIN/namespace \
    --v23.credentials $V_TUT/cred/alice \
    glob &quot;prophInc/*&quot;
</code></pre><h2 id="customers">Customers</h2>
<p>Of the principals created for this tutorial, only Bob is untouched.</p>
<p>Make him a customer to Nostradamus:</p>
<!-- @bobIsCustomerOfNostradamus @test -->
<pre><code>$V_BIN/principal get \
   --v23.credentials $V_TUT/cred/nostradamus \
   forpeer prophInc | \
       $V_BIN/principal bless \
         --v23.credentials $V_TUT/cred/nostradamus \
         --with=- --for=24h $V_TUT/cred/bob cust:bob | \
               $V_BIN/principal set \
                  --v23.credentials $V_TUT/cred/bob \
                  forpeer - prophInc
</code></pre><p>Verify that Bob can get fortunes from Nostradamus:</p>
<!-- @bobCanRead @test -->
<pre><code>$V_TUT/bin/client \
    --v23.credentials $V_TUT/cred/bob \
    --server prophInc/nostradamus
</code></pre><p>But that he cannot write to Nostradamus&#39; service:</p>
<div class="note warning"><p>This should fail.</p>
</div>


<!-- @bobCannotWrite  -->
<pre><code>$V_TUT/bin/client \
    --v23.credentials $V_TUT/cred/bob \
    --server prophInc/nostradamus \
    --add &#39;Bob is so Cool!&#39;
</code></pre><p>Verify on your own that Bob is unable to access Cassandra&#39;s service.</p>
<div class="note warning"><p>This should fail.</p>
</div>

<!-- @bobCannotReadCassandra -->
<pre><code>$V_TUT/bin/client \
    --v23.credentials $V_TUT/cred/bob \
    --server prophInc/cassandra
</code></pre><p>As a customer, Bob can only see nostradamus:
<!-- @bobOnlySeesNostradamus @test --></p>
<pre><code>$V_BIN/namespace \
    --v23.credentials $V_TUT/cred/bob \
    glob &quot;prophInc/*&quot;
</code></pre><h1 id="exercises">Exercises</h1>
<h2 id="cassandra-peeks-at-nostradamus">Cassandra peeks at Nostradamus</h2>
<p>Alice is Cassandra&#39;s intern.</p>
<p>What would it take to make her <em>also</em> a customer of Nostradamus?
That is, what needs to happen to make the following command work?</p>
<!-- @aliceReadsNostradamus  -->
<pre><code>$V_TUT/bin/client \
    --v23.credentials $V_TUT/cred/alice \
    --server prophInc/nostradamus
</code></pre><h2 id="nostradamus-cheats">Nostradamus cheats</h2>
<p>Can Nostradamus bless himself to gain access to Cassandra&#39;s data?</p>
<p>What if he got &#39;hired&#39; with the name <code>consultant:cassandra2</code>?</p>
<h2 id="internship">Internship</h2>
<p>Can an intern have an intern?  If so, can you prevent it?</p>
<p>Can an intern accept a new customer?</p>
<h1 id="cleanup">Cleanup</h1>
<!-- @cleanup @test -->
<pre><code>kill_tut_process TUT_PID_SERVER
kill_tut_process TUT_PID_MT
unset V23_NAMESPACE
</code></pre><h1 id="summary">Summary</h1>
<ul>
<li>In Vanadium, authorization boils down to simple string comparisons.
Supporting infrastructure assures the strings cannot be forged.</li>
</ul>

    </main>
    <nav class="previous-next">
      <a href="/tutorials/naming/suffix-part1.html" class="previous">
        <div class="icon"><i class="material-icons">arrow_back</i></div>
        <div class="text-wrapper">
          <small>Previous</small>
          <div class="text">
            <span>The Suffix - Part I</span>
          </div>
        </div>
      </a>
  <a href="/tutorials/naming/globber.html" class="next">
        <div class="text-wrapper">
          <small>Next</small>
          <div class="text">
            <span>Globber</span>
          </div>
        </div>
        <div class="icon"><i class="material-icons">arrow_forward</i></div>
      </a>
</nav>
  </body>
</html>
