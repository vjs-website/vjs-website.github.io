<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,
                                   initial-scale=1,
                                   minimum-scale=1,
                                   maximum-scale=1,
                                   user-scalable=no,
                                   minimal-ui">
  
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
  
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
    <title>Fortune in Java - Vanadium</title>
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,400,400italic,500,500italic,700,700italic|Source+Code+Pro">
  
    <link rel="stylesheet" href="/css/github.css">
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  
    <script src="/js/react-0.14.3.min.js"></script>
    <script src="/js/react-dom-0.14.3.min.js"></script>
  
    <link rel="apple-touch-icon" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="160x160" href="/favicons/favicon-160x160.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/favicons/favicon-192x192.png">
    <meta name="msapplication-TileColor" content="#00acc1">
    <meta name="msapplication-TileImage" content="/favicons/mstile-144x144.png">
  
    <link rel="stylesheet" href="/css/bundle.css">
    <script src="/js/bundle.js"></script>
  </head>
  <body>
    <header class="mdl-shadow--2dp">
      <div class="row">
        <div class="icon menu"><i class="material-icons">menu</i></div>
        <div class="icon v-icon"><img src="/images/v-icon-white.svg"></div>
        <div class="logo"><a href="/">Vanadium</a></div>
        <div class="spacer"></div>
        <nav>
          <a href="/">Overview</a>
          <a href="/installation/">Installation</a>
          <a href="/tutorials/hello-world.html">Tutorials</a>
        </nav>
      </div>
    </header>
    <div class="sidebar"></div>
    <div class="sidebar-data">
      <a href="/">Overview</a>
      <a href="/installation/">Installation</a>
    
      <a href="#" class="nav">Tutorials</a>
      <nav>
        <a href="/tutorials/hello-world.html">Hello World</a>
        <a href="/tutorials/basics.html">Client/Server Basics</a>
    
        <a href="#" class="nav">Security</a>
        <nav>
          <a href="/tutorials/security/">Overview</a>
          <a href="/tutorials/security/principals-and-blessings.html">Principals and Blessings</a>
      <a href="/tutorials/security/permissions-authorizer.html">Permissions Authorizer</a>
      <a href="/tutorials/security/first-party-caveats.html">Caveats</a>
      <a href="/tutorials/security/third-party-caveats.html">Third-party Caveats</a>
      <a href="/tutorials/security/agent.html">The Agent</a>
      <a href="/tutorials/security/custom-authorizer.html">Custom Authorizer</a>
    </nav>
    
        <a href="#" class="nav">Naming</a>
        <nav>
          <a href="/tutorials/naming/">Overview</a>
          <a href="/tutorials/naming/mount-table.html">The Mount Table</a>
      <a href="/tutorials/naming/namespace.html">Namespaces</a>
      <a href="/tutorials/naming/suffix-part1.html">The Suffix - Part I</a>
      <a href="/tutorials/naming/suffix-part2.html">The Suffix - Part II</a>
      <a href="/tutorials/naming/globber.html">Globber</a>
    </nav>
    
        <a href="#" class="nav">Java</a>
        <nav>
          <a href="/tutorials/java/">Overview</a>
          <a href="/tutorials/java/fortune.html">Fortune in Java</a>
      <a href="/tutorials/java/android.html">Location Service in Android</a>
    </nav>
    
        <a href="#" class="nav">JavaScript</a>
        <nav>
          <a href="/tutorials/javascript/">Overview</a>
          <a href="/tutorials/javascript/hellopeer.html">Hello Peer</a>
      <a href="/tutorials/javascript/fortune.html">Fortune in JS</a>
      <a href="/tutorials/javascript/security.html">Security in JS</a>
    </nav>
    
        <a href="/tutorials/faq.html">Tutorial FAQ</a>
      </nav>
    
      <a href="#" class="nav">Concepts</a>
      <nav>
        <a href="/concepts/rpc.html">RPC System</a>
    <a href="/concepts/naming.html">Naming</a>
    <a href="/concepts/security.html">Security</a>
    <a href="/concepts/device-management.html">Device Management</a>
    <a href="/concepts/syncbase-overview.html">Syncbase</a>
  </nav>
    
      <a href="/example-apps.html">Example Apps</a>
      <a href="/api-reference.html">API Reference</a>
    
      <a href="#" class="nav">Community</a>
      <nav>
        <a href="/community/coding-guidelines.html">Coding Guidelines</a>
    <a href="/community/contributing.html">Contributing</a>
  </nav>
    
      <a href="#" class="nav">Tools</a>
      <nav>
        <a href="/tools/identity-service-faq.html">Vanadium Identity Service</a>
    <a href="/tools/jiri.html">Jiri</a>
    <a href="/tools/services.html">Vanadium Cloud Services</a>
    <a href="/tools/vanadium-chrome-extension.html">Vanadium Chrome Extension</a>
  </nav>
    
      <a href="#" class="nav">Design Docs</a>
      <nav>
        <a href="/designdocs/authentication.html">Authentication Protocol</a>
    <a href="/designdocs/identity-service.html">Identity Service</a>
    <a href="/designdocs/vdl-spec.html">VDL Specification</a>
    <a href="/designdocs/vom-spec.html">VOM Specification</a>
  </nav>
    
      <a href="/glossary.html">Glossary</a>
      <a href="/faq.html">FAQ</a>
      <a href="/tos.html">Terms of Service</a>
    </div>
    <main>
      <h1 class="title">
        Fortune in Java
        
      </h1>

      <p class="wherein"><strong>Wherein</strong> you build a fortune teller service and a client to talk to it.</p>

      <div class="toc"></div>

      <div class="prerequisites">
      <div class="note info"><p><strong>Prerequisites</strong>:<br>
All Java tutorials require Java and <a href="http://gradle.org/">Gradle</a>.</p>
</div>
</div>

      <h2 id="introduction">Introduction</h2>
<p>In this tutorial, we will create a fortune teller server and a client to talk to
it. The server will have two methods:</p>
<ul>
<li><code>Add</code>, which adds a fortune to the list of fortunes, and</li>
<li><code>Get</code>, which retrieves a random fortune.</li>
</ul>
<h2 id="setting-up-the-project">Setting up the project</h2>
<p>In this tutorial, we will use the <a href="http://gradle.org/">Gradle</a> build tool to build the
project. There is no requirement that Vanadium Java projects use Gradle, but
it&#39;s the easiest way to get started. See the <a href="https://docs.gradle.org/current/userguide/installation.html">installation
instructions</a> for details. The remainder of the tutorial will
assume that you have the <code>gradle</code> program in your PATH.</p>
<h3 id="build-file">Build file</h3>
<p>The first step to defining a Gradle project is to create a <code>build.gradle</code> file
in the project root directory.</p>
<p>First, create a new project directory.</p>
<pre><code>mkdir fortuneJava
cd fortuneJava
</code></pre><p>Now, create a <code>build.gradle</code> file:</p>
<!-- @createBuildFile @test -->
<pre><code>cat &lt;&lt;EOF &gt; build.gradle

buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {
        // Our project is going to use VDL, so we need to depend on the Vanadium
        // Gradle plugin.
        classpath &#39;io.v:gradle-plugin:0.5&#39;
    }
}

// We&#39;re going to be building an application to run
apply plugin: &#39;application&#39;

// It&#39;s going to use VDL
apply plugin: &#39;io.v.vdl&#39;

// And it&#39;s going to be written in Java
apply plugin: &#39;java&#39;

// This class will contain our server&#39;s entry point
mainClassName = &#39;io.v.tutorial.FortuneTutorial&#39;

repositories {
    mavenCentral()
}

dependencies {
    // We need the Vanadium Java libraries.
    compile &#39;io.v:vanadium:0.1&#39;
}

vdl {
    // This is where the VDL tool will look for VDL definitions.
    inputPaths += &#39;src/main/java&#39;
}

EOF
</code></pre><h2 id="defining-the-fortune-service">Defining the Fortune service</h2>
<p>In Java, we must use <a href="/glossary.html#vanadium-definition-language-vdl-">VDL</a> (Vanadium Definition Language) to define our server
interface. We will reuse the same interface definition from the
<a href="/tutorials/basics.html">Client/Server Basics tutorial</a>.
For this tutorial, the fortune teller server definition lives in <code>src/main/java/io/v/tutorial/fortune.vdl</code>.
Let&#39;s create this file now:</p>
<!-- @createVdlInterface @test -->
<pre><code>mkdir -p src/main/java/io/v/tutorial
cat &lt;&lt;EOF &gt; src/main/java/io/v/tutorial/fortune.vdl
package fortune

type Fortune interface {
  // Returns a random fortune.
  Get() (wisdom string | error)
  // Adds a fortune to the set used by Get().
  Add(wisdom string) error
}
EOF
</code></pre><p>As you can see, we provide &#39;Get&#39; and &#39;Add&#39; methods to get and add fortunes. We
can now test our VDL file by asking Gradle to generate the corresponding Java
files. Do this by running</p>
<!-- @generateVdlSource @test -->
<pre><code>gradle vdl
</code></pre><p>You should see output like the following:</p>
<pre><code class="noclipboard">:prepareVdl
:extractVdl
:generateVdl
signature
time
vdltool
io/v/tutorial
:removeVdlRoot
:vdl

BUILD SUCCESSFUL</code></pre>

<p>The <code>io/v/tutorial</code> line indicates that VDL tool has processed your input file.
If you now look inside the <code>generated-src</code> directory, you&#39;ll find the following
entries:</p>
<pre><code class="noclipboard">generated-src/vdl/io/v/tutorial/FortuneServerWrapper.java
generated-src/vdl/io/v/tutorial/FortuneClient.java
generated-src/vdl/io/v/tutorial/FortuneServer.java
generated-src/vdl/io/v/tutorial/FortuneClientImpl.java
generated-src/vdl/io/v/tutorial/FortuneClientFactory.java</code></pre>

<h3 id="implementation">Implementation</h3>
<p>Now we must provide an implementation for the FortuneServer.</p>
<p>Create <code>src/main/java/io/v/tutorial/InMemoryFortuneServer.java</code>:</p>
<!-- @generateInMemoryFortuneServerImpl @test -->
<pre><code>cat &lt;&lt;EOF &gt; src/main/java/io/v/tutorial/InMemoryFortuneServer.java
package io.v.tutorial;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Random;

import io.v.v23.V;
import io.v.v23.context.VContext;
import io.v.v23.naming.Endpoint;
import io.v.v23.rpc.Server;
import io.v.v23.rpc.ServerCall;
import io.v.v23.security.VSecurity;
import io.v.v23.verror.VException;

public class InMemoryFortuneServer implements FortuneServer {
    private final List&lt;String&gt; fortunes = new ArrayList&lt;&gt;();
    private final Random random = new Random(System.currentTimeMillis());

    @Override
    public String get(VContext ctx, ServerCall call) throws VException {
        if (fortunes.isEmpty()) {
            throw new VException(&quot;There are no fortunes available, try Add()ing one!&quot;);
        } else {
            return fortunes.get(random.nextInt(fortunes.size()));
        }
    }

    @Override
    public void add(VContext ctx, ServerCall call, String wisdom) throws VException {
        fortunes.add(wisdom);
    }

    public static Endpoint[] startServer() throws VException {
        // Initialize the Vanadium runtime and load its native shared library
        // implementation. This is required before we can do anything involving
        // Vanadium.
        VContext context = V.init();

        // Serve a new InMemoryFortuneServer with an allow-everyone authorizer.
        // This call will return immediately, serving is done in a separate
        // thread.
        Server fortuneServer = V.getServer(V.withNewServer(context, &quot;&quot;,
            new InMemoryFortuneServer(),
            VSecurity.newAllowEveryoneAuthorizer()));

        return fortuneServer.getStatus().getEndpoints();
    }
}
EOF
</code></pre><p>And now let&#39;s create our entry point at
<code>src/main/java/io/v/tutorial/FortuneTutorial.java</code>:</p>
<!-- @defineMainMethod @test -->
<pre><code>cat &lt;&lt;EOF &gt; src/main/java/io/v/tutorial/FortuneTutorial.java
package io.v.tutorial;

import java.io.IOException;
import java.util.Arrays;

import io.v.v23.naming.Endpoint;
import io.v.v23.verror.VException;

public class FortuneTutorial {
    public static void main(String[] args) throws IOException, VException {
        Endpoint[] endpoints = InMemoryFortuneServer.startServer();
        System.out.println(&quot;FortuneServer available at the following endpoints: &quot; +
                Arrays.toString(endpoints));
        System.out.println(&quot;Listening for connections, press enter to quit.&quot;);
        System.in.read();
        System.out.println(&quot;Exiting...&quot;);
    }
}
EOF
</code></pre><h2 id="running-the-server">Running the server</h2>
<p>Now you are ready to build and run the server.</p>
<!-- @buildWrapper @test -->
<pre><code>gradle installDist
</code></pre><p>This will leave an executable script in
<code>build/install/fortuneJava/bin/fortuneJava</code>. When we run it:</p>
<pre><code class="noclipboard">FortuneServer available at the following endpoints: [@5@wsh@127.0.0.1:54221@50704f409f1fc0bf20f01020b02f2030@s@sjr@example.com-15180@@, @5@wsh@192.168.2.4:54221@50704f409f1fc0bf20f01020b02f2030@s@sjr@example.com-15180@@]
Listening for connections, press enter to quit.</code></pre>

<p>Excellent, the server is now running. Let&#39;s write a client to talk to it.</p>
<h2 id="defining-a-fortune-client">Defining a Fortune client</h2>
<p>The VDL step has generated a client stub for us to use to call methods on a
server. We obtain stub instances from the generated <code>FortuneClientFactory</code>
class. The only other piece of information we need is the name of the <a href="/glossary.html#endpoint">endpoint</a>
to which to talk.</p>
<p>Let&#39;s create <code>src/main/java/io/v/tutorial/FancyFortuneClient.java</code>:</p>
<!-- @createClientDefinition @test -->
<pre><code>cat &lt;&lt;EOF &gt; src/main/java/io/v/tutorial/FancyFortuneClient.java
package io.v.tutorial;

import io.v.v23.OptionDefs;
import io.v.v23.Options;
import io.v.v23.context.VContext;
import io.v.v23.verror.VException;

public class FancyFortuneClient {
    private final VContext context;
    private final FortuneClient client;
    private final Options options;

    public FancyFortuneClient(VContext context, String endpointName) {
        this.context = context;
        this.client = FortuneClientFactory.getFortuneClient(endpointName);

        // The SKIP_SERVER_ENDPOINT_AUTHORIZATION is necessary because this
        // tutorial does not deal with trust. If we omit this option, our client
        // will not trust the server. Your production code should not set this
        // option because it makes the client vulnerable to man-in-the-middle
        // attacks.
        this.options = new Options().set(OptionDefs.SKIP_SERVER_ENDPOINT_AUTHORIZATION,
                true);
    }

    public String get() throws VException {
        return client.get(context, options);
    }

    public void add(String wisdom) throws VException {
        client.add(context, wisdom, options);
    }
}
EOF
</code></pre><p>Let&#39;s modify the main FortuneTutorial class a little. It will now have three
modes depending on how many arguments we pass in:</p>
<ul>
<li><p>no arguments: start a Fortune server just as we did in the first part of the
tutorial</p>
</li>
<li><p>one argument: fetch a fortune from the endpoint named by that argument</p>
</li>
<li><p>two or more arguments: add the second and subsequent arguments as fortunes
to the server named by the first argument</p>
</li>
</ul>
<p>For example:</p>
<pre><code class="noclipboard">build/install/fortuneJava/bin/fortuneJava  # run a server
build/install/fortuneJava/bin/fortuneJava @5@...@@  # fetch a fortune
build/install/fortuneJava/bin/fortuneJava @5@...@@ "Hello world!"  # add a fortune</code></pre>

<p>Here is the new FortuneTutorial:</p>
<!-- @refineMainMethod @test -->
<pre><code>cat &lt;&lt;EOF &gt; src/main/java/io/v/tutorial/FortuneTutorial.java
package io.v.tutorial;

import java.io.IOException;
import java.util.Arrays;

import io.v.v23.V;
import io.v.v23.naming.Endpoint;
import io.v.v23.verror.VException;

public class FortuneTutorial {
    public static void main(String[] args) throws IOException, VException {
        if (args.length &gt; 0) {
            FancyFortuneClient client = new FancyFortuneClient(V.init(), args[0]);
            if (args.length &gt;= 2) {
                for (int i = 1; i &lt; args.length; i++) {
                    client.add(args[i]);
                }
            } else {
                System.out.println(client.get());
            }
        } else {
            Endpoint[] endpoints = InMemoryFortuneServer.startServer();
            System.out.println(&quot;FortuneServer available at the following endpoints: &quot; +
                    Arrays.toString(endpoints));
            System.out.println(&quot;Listening for connections, press enter to quit.&quot;);
            System.in.read();
            System.out.println(&quot;Exiting...&quot;);
        }
    }
}
EOF
</code></pre><p>Build the tutorial again:</p>
<!-- @buildWrapper @test -->
<pre><code>gradle installDist
</code></pre><p>Here&#39;s an example session:</p>
<pre><code class="noclipboard">$ FortuneServer available at the following endpoints: [@5@wsh@127.0.0.1:36191@c00090af3ff050d020ef3f4f4f40ffff@s@sjr@example.com-28934@@, @5@wsh@192.168.2.4:36191@c00090af3ff050d020ef3f4f4f40ffff@s@sjr@example.com-28934@@]
Listening for connections, press enter to quit.</code></pre>

<p>In a separate terminal:</p>
<pre><code class="noclipboard">$ export ENDPOINT=/@5@wsh@192.168.2.4:36191@c00090af3ff050d020ef3f4f4f40ffff@s@sjr@example.com-28934@@
$ build/install/fortuneJava/bin/fortuneJava $ENDPOINT
Exception in thread "main" io.v.v23.verror.VException: sjr:<rpc.Client>"/@5@wsh@192.168.2.4:36191@c00090af3ff050d020ef3f4f4f40ffff@s@sjr@example.com-28934@@".Get: Error: There are no fortunes available, try Add()ing one!
        at io.v.v23.verror.VExceptionVdlConverter.nativeFromVdlValue(VExceptionVdlConverter.java:70)
        at io.v.v23.verror.VExceptionVdlConverter.nativeFromVdlValue(VExceptionVdlConverter.java:22)
        at io.v.v23.vom.BinaryDecoder.readValue(BinaryDecoder.java:190)
        at io.v.v23.vom.BinaryDecoder.readValueMessage(BinaryDecoder.java:118)
        at io.v.v23.vom.BinaryDecoder.decodeValue(BinaryDecoder.java:85)
        at io.v.v23.vom.VomUtil.decode(VomUtil.java:104)
        at io.v.impl.google.rpc.ClientCallImpl.nativeFinish(Native Method)
        at io.v.impl.google.rpc.ClientCallImpl.finish(ClientCallImpl.java:35)
        at io.v.tutorial.FortuneClientImpl.get(FortuneClientImpl.java:62)
        at io.v.tutorial.FancyFortuneClient.get(FancyFortuneClient.java:21)
        at io.v.tutorial.FortuneTutorial.main(FortuneTutorial.java:19)
$ build/install/fortuneJava/bin/fortuneJava $ENDPOINT "Hello, world!"
$ build/install/fortuneJava/bin/fortuneJava $ENDPOINT
Hello, world!</code></pre>


<h2 id="summary">Summary</h2>
<p>Congratulations! You have successfully run the Java fortune example.</p>
<p>You have:</p>
<ul>
<li>Built a fortune client and server in Java.</li>
<li>Established communication between the Java and Go clients and servers.</li>
<li>Learned about using Vanadium in Java as compared to Go.</li>
</ul>

    </main>
    <nav class="previous-next">
      <a href="/tutorials/java/android.html" class="next">
        <div class="text-wrapper">
          <small>Next</small>
          <div class="text">
            <span>Location Service in Android</span>
          </div>
        </div>
        <div class="icon"><i class="material-icons">arrow_forward</i></div>
      </a>
</nav>
  </body>
</html>
