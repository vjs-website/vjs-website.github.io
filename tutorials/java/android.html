<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,
                                   initial-scale=1,
                                   minimum-scale=1,
                                   maximum-scale=1,
                                   user-scalable=no,
                                   minimal-ui">
  
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
  
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
    <title>Location Service in Android - Vanadium</title>
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,400,400italic,500,500italic,700,700italic|Source+Code+Pro">
  
    <link rel="stylesheet" href="/css/github.css">
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  
    <script src="/js/react-0.14.3.min.js"></script>
    <script src="/js/react-dom-0.14.3.min.js"></script>
  
    <link rel="apple-touch-icon" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="160x160" href="/favicons/favicon-160x160.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/favicons/favicon-192x192.png">
    <meta name="msapplication-TileColor" content="#00acc1">
    <meta name="msapplication-TileImage" content="/favicons/mstile-144x144.png">
  
    <link rel="stylesheet" href="/css/bundle.css">
    <script src="/js/bundle.js"></script>
  </head>
  <body>
    <header class="mdl-shadow--2dp">
      <div class="row">
        <div class="icon menu"><i class="material-icons">menu</i></div>
        <div class="icon v-icon"><img src="/images/v-icon-white.svg"></div>
        <div class="logo"><a href="/">Vanadium</a></div>
        <div class="spacer"></div>
        <nav>
          <a href="/">Overview</a>
          <a href="/installation/">Installation</a>
          <a href="/tutorials/hello-world.html">Tutorials</a>
        </nav>
      </div>
    </header>
    <div class="sidebar"></div>
    <div class="sidebar-data">
      <a href="/">Overview</a>
      <a href="/installation/">Installation</a>
    
      <a href="#" class="nav">Tutorials</a>
      <nav>
        <a href="/tutorials/hello-world.html">Hello World</a>
        <a href="/tutorials/basics.html">Client/Server Basics</a>
    
        <a href="#" class="nav">Security</a>
        <nav>
          <a href="/tutorials/security/">Overview</a>
          <a href="/tutorials/security/principals-and-blessings.html">Principals and Blessings</a>
      <a href="/tutorials/security/permissions-authorizer.html">Permissions Authorizer</a>
      <a href="/tutorials/security/first-party-caveats.html">Caveats</a>
      <a href="/tutorials/security/third-party-caveats.html">Third-party Caveats</a>
      <a href="/tutorials/security/agent.html">The Agent</a>
      <a href="/tutorials/security/custom-authorizer.html">Custom Authorizer</a>
    </nav>
    
        <a href="#" class="nav">Naming</a>
        <nav>
          <a href="/tutorials/naming/">Overview</a>
          <a href="/tutorials/naming/mount-table.html">The Mount Table</a>
      <a href="/tutorials/naming/namespace.html">Namespaces</a>
      <a href="/tutorials/naming/suffix-part1.html">The Suffix - Part I</a>
      <a href="/tutorials/naming/suffix-part2.html">The Suffix - Part II</a>
      <a href="/tutorials/naming/globber.html">Globber</a>
    </nav>
    
        <a href="#" class="nav">Java</a>
        <nav>
          <a href="/tutorials/java/">Overview</a>
          <a href="/tutorials/java/fortune.html">Fortune in Java</a>
      <a href="/tutorials/java/android.html">Location Service in Android</a>
    </nav>
    
        <a href="#" class="nav">JavaScript</a>
        <nav>
          <a href="/tutorials/javascript/">Overview</a>
          <a href="/tutorials/javascript/hellopeer.html">Hello Peer</a>
      <a href="/tutorials/javascript/fortune.html">Fortune in JS</a>
      <a href="/tutorials/javascript/security.html">Security in JS</a>
    </nav>
    
        <a href="/tutorials/faq.html">Tutorial FAQ</a>
      </nav>
    
      <a href="#" class="nav">Concepts</a>
      <nav>
        <a href="/concepts/rpc.html">RPC System</a>
    <a href="/concepts/naming.html">Naming</a>
    <a href="/concepts/security.html">Security</a>
    <a href="/concepts/device-management.html">Device Management</a>
    <a href="/concepts/syncbase-overview.html">Syncbase</a>
  </nav>
    
      <a href="/example-apps.html">Example Apps</a>
      <a href="/api-reference.html">API Reference</a>
    
      <a href="#" class="nav">Community</a>
      <nav>
        <a href="/community/coding-guidelines.html">Coding Guidelines</a>
    <a href="/community/contributing.html">Contributing</a>
  </nav>
    
      <a href="#" class="nav">Tools</a>
      <nav>
        <a href="/tools/identity-service-faq.html">Vanadium Identity Service</a>
    <a href="/tools/jiri.html">Jiri</a>
    <a href="/tools/services.html">Vanadium Cloud Services</a>
    <a href="/tools/vanadium-chrome-extension.html">Vanadium Chrome Extension</a>
  </nav>
    
      <a href="#" class="nav">Design Docs</a>
      <nav>
        <a href="/designdocs/authentication.html">Authentication Protocol</a>
    <a href="/designdocs/identity-service.html">Identity Service</a>
    <a href="/designdocs/vdl-spec.html">VDL Specification</a>
    <a href="/designdocs/vom-spec.html">VOM Specification</a>
  </nav>
    
      <a href="/glossary.html">Glossary</a>
      <a href="/faq.html">FAQ</a>
      <a href="/tos.html">Terms of Service</a>
    </div>
    <main>
      <h1 class="title">
        Location Service in Android
        
      </h1>

      <p class="wherein"><strong>Wherein</strong> you build an Android phone locator service.</p>

      <div class="toc"></div>

      <div class="prerequisites">
      <div class="note info"><p><strong>Prerequisites</strong>:<br>
All Java tutorials require Java and <a href="http://gradle.org/">Gradle</a>.</p>
</div>
</div>

      <h1 id="introduction">Introduction</h1>
<p>In this tutorial, we will build a very simple Android application that will
create a Vanadium server on the phone. When queried by an authorized client,
the server will return the phone&#39;s physical location (latitude and longitude).</p>
<p>The tutorial will demonstrate some Android-specific aspects of the Vanadium
implementation. It will also show that Vanadium allows clients to work across
NAT networks transparently.</p>
<p>We will be building three software components in this tutorial:</p>
<ul>
<li>the Vanadium server that responds to location requests</li>
<li>the Android service that starts the Vanadium server</li>
<li>the Android activity that sets up our security environment and starts the
Android service</li>
</ul>
<p>Here&#39;s a screenshot of the tutorial program built and running on a Nexus 5
emulator.</p>
<p><img src="/images/tut/location-service-activity.png" alt="Location service activity"></p>
<h1 id="setting-up-the-project">Setting up the project</h1>
<p>In this tutorial, we will use the <a href="http://gradle.org/">Gradle</a> build tool to build the
project. There is no requirement that Vanadium Java projects use Gradle, but
it&#39;s the easiest way to get started. See the <a href="https://docs.gradle.org/current/userguide/installation.html">installation
instructions</a> for details. The remainder of the tutorial will
assume that you have the <code>gradle</code> program in your PATH.</p>
<p>If you are familiar with <a href="https://developer.android.com/sdk/index.html">Android Studio</a>, we encourage you to
use it for this tutorial.</p>
<h2 id="build-file">Build file</h2>
<p>The first step to defining a Gradle project is to create a <code>build.gradle</code> file
in the project root directory.</p>
<p>First, create a new project directory.</p>
<pre><code>mkdir location
cd location
</code></pre><p>Now, create a <code>build.gradle</code> file:</p>
<!-- @createBuildFile @test -->
<pre><code>cat &lt;&lt;EOF &gt; build.gradle

buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {
        // This introduces the Android plugin to make building Android
        // applications easier.
        classpath &#39;com.android.tools.build:gradle:1.3.1&#39;

        // We are going to define a custom VDL service. The Vanadium
        // Gradle plugin makes that easier, so let&#39;s use that.
        classpath &#39;io.v:gradle-plugin:0.5&#39;

        // Use the Android SDK manager, which will automatically download
        // the required Android SDK.
        classpath &#39;com.jakewharton.sdkmanager:gradle-plugin:0.12.0&#39;
    }
}

// Make our lives easier by automatically downloading the appropriate Android
// SDK.
apply plugin: &#39;android-sdk-manager&#39;

// It&#39;s an Android application.
apply plugin: &#39;com.android.application&#39;

// It&#39;s going to use VDL.
apply plugin: &#39;io.v.vdl&#39;

repositories {
    mavenCentral()
}

android {
    compileSdkVersion 19
    buildToolsVersion &quot;23.0.1&quot;
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_7
        targetCompatibility JavaVersion.VERSION_1_7
    }
    packagingOptions {
        exclude &#39;META-INF/LICENSE.txt&#39;
        exclude &#39;META-INF/NOTICE.txt&#39;
    }
}

dependencies {
    compile &#39;io.v:vanadium:0.1&#39;
    compile &#39;io.v:vanadium-android:0.1&#39;
}

vdl {
    inputPaths += &#39;src/main/java&#39;
}

EOF
</code></pre><h1 id="defining-the-location-server">Defining the Location Server</h1>
<p>We&#39;re going to create a Vanadium server on the Android phone. The easiest way to
do this is to define it in <a href="/glossary.html#vanadium-definition-language-vdl-">VDL</a>.</p>
<!-- @createVdlInterface @test -->
<pre><code>mkdir -p src/main/java/io/v/location
cat &lt;&lt;EOF &gt; src/main/java/io/v/location/location.vdl
package location

type LatLng struct {
        // The latitude of the phone, in degrees.
        Lat float64

        // The longitude of the phone, in degrees.
        Lng float64
}

type Location interface {
        // The one method that we will support. When called, returns the
        // physical location of the phone or an error if it could not be
        // determined.
        Get() (LatLng | error)
}

EOF
</code></pre><p>As you can see, we provide a single &#39;Get&#39; method to get the location of the
phone. Let&#39;s generate the VDL source just to make sure everything worked.</p>
<!-- @generateVdlSource @test -->
<pre><code>gradle vdl
</code></pre><p>You should see output like the following:</p>
<pre><code class="noclipboard">:prepareVdl
:extractVdl
:generateVdl
signature
time
vdltool
io/v/location
:removeVdlRoot
:vdl

BUILD SUCCESSFUL</code></pre>

<p>The <code>io/v/location</code> line indicates that VDL tool has processed your input file.
If you now look inside the <code>generated-src</code> directory, you&#39;ll find the following
entries:</p>
<pre><code class="noclipboard">generated-src/vdl/io/v/location/LocationClientFactory.java
generated-src/vdl/io/v/location/LocationServer.java
generated-src/vdl/io/v/location/LocationClientImpl.java
generated-src/vdl/io/v/location/LatLng.java
generated-src/vdl/io/v/location/LocationClient.java
generated-src/vdl/io/v/location/LocationServerWrapper.java</code></pre>

<h2 id="implementation">Implementation</h2>
<p>Now we must provide an implementation for the LocationServer. We&#39;d like this
server to be long-lived, so we&#39;re going to use an <a href="http://developer.android.com/guide/components/services.html">Android Service</a>.</p>
<p>Create <code>src/main/java/io/v/location/LocationService.java</code>:</p>
<!-- @generateLocationServerImpl @test -->
<pre><code>cat &lt;&lt;EOF &gt; src/main/java/io/v/location/LocationServerImpl.java
package io.v.location;

import android.location.Criteria;
import android.location.Location;
import android.location.LocationManager;

import io.v.android.v23.V;
import io.v.v23.context.VContext;
import io.v.v23.rpc.ServerCall;
import io.v.v23.verror.VException;

/**
 * This class implements the VDL interface we defined above.
 */
public class LocationServerImpl implements LocationServer {
   // We&#39;re going to use Android&#39;s LocationManager to get the phone&#39;s
   // physical location.
   private final LocationManager manager;

   LocationServerImpl(LocationManager manager) {
       this.manager = manager;
   }

   @Override
   public LatLng get(VContext context, ServerCall call) throws VException {
       Criteria criteria = new Criteria();
       criteria.setAccuracy(Criteria.NO_REQUIREMENT);
       String provider = manager.getBestProvider(criteria, true);
       if (provider == null || provider.isEmpty()) {
           throw new VException(&quot;Couldn&#39;t find any location providers on the device.&quot;);
       }
       Location location = manager.getLastKnownLocation(provider);
       if (location == null) {
           throw new VException(&quot;Got null location.&quot;);
       }
       return new LatLng(location.getLatitude(), location.getLongitude());
   }
}
EOF
</code></pre><h1 id="android-service">Android service</h1>
<p>Long-running tasks, like a Vanadium server, belong in Android services. In this
section we implement an Android service that starts our <code>LocationServer</code> and
mounts it into the Vanadium namespace. Please see the <a href="http://developer.android.com/guide/components/services.html">Android
documentation</a> for detailed information about Services.</p>
<p>Recall that Vanadium is secure. Given that this service is going to be
responsible for mounting objects into the Vanadium namespace, we need to:</p>
<ul>
<li>trust the remote mounttable server</li>
<li>present to that server a set of acceptable blessings</li>
</ul>
<p>This service implementation will assume that this information is passed into the
<code>onCreate</code> method.</p>
<h2 id="implementation">Implementation</h2>
<!-- @generateLocationService @test -->
<pre><code>cat &lt;&lt;EOF &gt; src/main/java/io/v/location/LocationService.java
package io.v.location;

import android.app.Service;
import android.content.Context;
import android.content.Intent;
import android.location.LocationManager;
import android.os.IBinder;
import android.widget.Toast;

import com.google.common.collect.Lists;

import java.util.List;

import io.v.android.v23.V;
import io.v.v23.context.VContext;
import io.v.v23.rpc.ListenSpec;
import io.v.v23.rpc.Server;
import io.v.v23.security.BlessingPattern;
import io.v.v23.security.Blessings;
import io.v.v23.security.VCertificate;
import io.v.v23.security.VPrincipal;
import io.v.v23.security.VSecurity;
import io.v.v23.verror.VException;
import io.v.v23.vom.VomUtil;

public class LocationService extends Service {
    public static final String BLESSINGS_KEY = &quot;Blessings&quot;;
    private VContext baseContext;

    @Override
    public IBinder onBind(Intent intent) {
        return null;  // Binding not allowed
    }

    /**
     * This method decodes the passed-in blessings and calls
     * startLocationServer to actually start and mount the
     * Vanadium server.
     */
    @Override
    public int onStartCommand(Intent intent, int flags, int startId) {
        // Initialize Vanadium.
        baseContext = V.init(this);

        // Fetch the blessings from the intent. The activity that is starting
        // the service must populate this field.
        String blessingsVom = intent.getStringExtra(BLESSINGS_KEY);

        if (blessingsVom == null || blessingsVom.isEmpty()) {
            String msg = &quot;Could not start LocationService: &quot;
                + &quot;null or empty encoded blessings.&quot;;
            Toast.makeText(this, msg, Toast.LENGTH_LONG).show();
            return START_REDELIVER_INTENT;
        }

        try {
            Blessings blessings = (Blessings) VomUtil.decodeFromString(
                blessingsVom, Blessings.class);
            if (blessings == null) {
                String msg = &quot;Couldn&#39;t start LocationService: &quot;
                    + &quot;null blessings.&quot;;
                Toast.makeText(this, msg, Toast.LENGTH_LONG).show();
                return START_REDELIVER_INTENT;
            }

            // We have blessings, start the server!
            startLocationServer(blessings);
        } catch (VException e) {
            String msg = &quot;Couldn&#39;t start LocationService: &quot; + e.getMessage();
            Toast.makeText(this, msg, Toast.LENGTH_LONG).show();
        }
        return START_REDELIVER_INTENT;
    }

    /**
     * This method starts and mounts the Vanadium location server with the given
     * blessings.
     */
    public void startLocationServer(Blessings blessings) throws VException {
        // Principal represents our identity within the Vanadium system.
        VPrincipal principal = V.getPrincipal(baseContext);

        // Provide the given blessings when anybody connects to us.
        principal.blessingStore().setDefaultBlessings(blessings);

        // Also, provide these blessings when we connect to other services (for
        // example, when we talk to the mounttable).
        principal.blessingStore().set(blessings, new BlessingPattern(&quot;...&quot;));

        // Trust these blessings and all the &quot;parent&quot; blessings.
        VSecurity.addToRoots(principal, blessings);

        // Our security environment is now set up. Let&#39;s find a home in the
        // namespace for our service.
        String mountPoint;
        String prefix = mountNameFromBlessings(blessings);

        if (&quot;&quot;.equals(prefix)) {
            throw new VException(&quot;Could not determine mount point: &quot;
                + &quot;no username in blessings?&quot;);
        } else {
            mountPoint = &quot;users/&quot; + prefix + &quot;/location&quot;;
            String msg = &quot;Mounting server at &quot; + mountPoint;
            Toast.makeText(this, msg, Toast.LENGTH_LONG).show();
        }

        // Now create the server and mount it.
        LocationServer locationServer = new LocationServerImpl(
            (LocationManager) getSystemService(Context.LOCATION_SERVICE));

        // Use Vanadium&#39;s production proxy server for NAT traversal. None of
        // your data is visible to the proxy server because it&#39;s all encrypted.
        ListenSpec spec = V.getListenSpec(baseContext).withProxy(&quot;proxy&quot;);

        // Finally, the magic moment!
        Server server = V.getServer(
            V.withNewServer(V.withListenSpec(baseContext, spec),
                mountPoint, locationServer, null));

        Toast.makeText(this, &quot;Success!&quot;, Toast.LENGTH_SHORT).show();
    }

    /**
     * This method finds the last certificate in our blessing&#39;s certificate
     * chains whose extension contains an &#39;@&#39;. We will assume that extension to
     * represent our username.
     */
    private static String mountNameFromBlessings(Blessings blessings) {
        for (List&lt;VCertificate&gt; chain : blessings.getCertificateChains()) {
            for (VCertificate certificate : Lists.reverse(chain)) {
                if (certificate.getExtension().contains(&quot;@&quot;)) {
                    return certificate.getExtension();
                }
            }
        }
        return &quot;&quot;;
    }
}
EOF
</code></pre><h1 id="android-activity">Android activity</h1>
<p>We have defined a service, now we need an <a href="http://developer.android.com/guide/components/activities.html">activity</a> to run it. This activity
has only two UI elements: a button to choose a Vanadium blessing and a button to
start the location service.</p>
<h2 id="security-and-the-account-manager">Security and the Account Manager</h2>
<p>Now would be a good time to talk some more about security. Since this tutorial
involves talking to the Vanadium root mounttable, we&#39;re going to need a blessing
issued by the Vanadium identity service. The details of how a trusted channel is
established between two authenticated endpoints is beyond the scope of this
tutorial. To make a long story short: we&#39;re going to delegate all of this to a
special Android application called the Account Manager.</p>
<p>You should download and install the account manager using the following
commands:</p>
<pre><code>wget https://v.io/account_manager-release.apk
</code></pre><pre><code>$HOME/.android-sdk/platform-tools/adb install -r account_manager-release.apk
</code></pre><h2 id="implementation">Implementation</h2>
<p>Assuming that you&#39;ve installed the account manager, you&#39;re ready to implement
the location activity. Typically, Android applications will use declarative XML
layouts, but to keep this tutorial as short as possible, we&#39;re going to create
and lay out the UI components manually in Java.</p>
<!-- @defineLocationActivity @test -->
<pre><code>cat &lt;&lt;EOF &gt; src/main/java/io/v/location/LocationActivity.java

package io.v.location;

import android.app.Activity;
import android.content.Intent;
import android.os.Bundle;
import android.view.View;
import android.widget.Button;
import android.widget.LinearLayout;
import android.widget.Toast;

import io.v.android.libs.security.BlessingsManager;
import io.v.android.v23.V;
import io.v.android.v23.services.blessing.BlessingCreationException;
import io.v.android.v23.services.blessing.BlessingService;
import io.v.v23.context.VContext;
import io.v.v23.security.Blessings;
import io.v.v23.verror.VException;
import io.v.v23.vom.VomUtil;

public class LocationActivity extends Activity {
    private static final int BLESSING_REQUEST = 1;

    private VContext mBaseContext;
    private Button chooseBlessingsButton;
    private Button startServiceButton;
    private Blessings blessings;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        // Initialize Vanadium.
        mBaseContext = V.init(this);

        // Layout our two buttons vertically.
        LinearLayout layout = new LinearLayout(getApplicationContext());
        layout.setOrientation(LinearLayout.VERTICAL);

        // Initially the blessings will be null. Give the user a button to pick
        // the blessings to use.
        chooseBlessingsButton = new Button(getApplicationContext());
        chooseBlessingsButton.setText(&quot;Choose blessings...&quot;);
        chooseBlessingsButton.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                fetchBlessings(false);
            }
        });
        layout.addView(chooseBlessingsButton);

        // Once they&#39;ve picked blessings, this button will be enabled and will
        // allow the user to start the location service.
        startServiceButton = new Button(getApplicationContext());
        startServiceButton.setText(&quot;Start listening&quot;);
        startServiceButton.setEnabled(false);
        startServiceButton.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                startLocationService(blessings);
            }
        });
        layout.addView(startServiceButton);

        setContentView(layout);
    }

    /**
     * This method is called when the user clicks the &quot;choose blessings&quot; button.
     * It fires off an intent which will be handled by the Account Manager.
     */
    private void fetchBlessings(boolean startService) {
        Intent intent = BlessingService.newBlessingIntent(this);
        startActivityForResult(intent, BLESSING_REQUEST);
    }

    /**
     * This method will be called once the user has finished selecting their
     * blessings from the Account Manager.
     */
    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
        switch (requestCode) {
            case BLESSING_REQUEST:
                try {
                    // The Account Manager will pass us the blessings to use as
                    // an array of bytes. Use VomUtil to decode them...
                    byte[] blessingsVom =
                        BlessingService.extractBlessingReply(resultCode, data);
                    blessings = (Blessings) VomUtil.decode(blessingsVom, Blessings.class);
                    BlessingsManager.addBlessings(this, blessings);
                    Toast.makeText(this, &quot;Success, ready to listen!&quot;,
                        Toast.LENGTH_SHORT).show();

                    // Enable the &quot;start service&quot; button.
                    startServiceButton.setEnabled(true);
                } catch (BlessingCreationException e) {
                    String msg = &quot;Couldn&#39;t create blessing: &quot; + e.getMessage();
                    Toast.makeText(this, msg, Toast.LENGTH_LONG).show();
                } catch (VException e) {
                    String msg = &quot;Couldn&#39;t store blessing: &quot; + e.getMessage();
                    Toast.makeText(this, msg, Toast.LENGTH_LONG).show();
                }
                return;
        }
    }

    /**
     * Finally, this is the start service button handler.
     */
    private void startLocationService(Blessings blessings) {
        try {
            // Recall that the location service expects a Blessings object
            // encoded as a VOM string.
            String blessingsVom = VomUtil.encodeToString(blessings, Blessings.class);
            Intent intent = new Intent(this, LocationService.class);
            intent.putExtra(LocationService.BLESSINGS_KEY, blessingsVom);
            stopService(intent);
            startService(intent);
        } catch (VException e) {
            String msg = String.format(
                    &quot;Couldn&#39;t encode blessings %s: %s&quot;, blessings, e.getMessage());
            Toast.makeText(this, msg, Toast.LENGTH_LONG).show();
        }
    }
}
EOF
</code></pre><h1 id="android-manifest-file">Android manifest file</h1>
<p>Android applications require a manifest file. In our case, it&#39;s pretty
straightforward:</p>
<!-- @defineManifest @test -->
<pre><code>cat &lt;&lt;EOF &gt; src/main/AndroidManifest.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
    package=&quot;io.v.location&quot;
    android:versionCode=&quot;1&quot;
    android:versionName=&quot;1.0&quot; &gt;

    &lt;uses-sdk
        android:minSdkVersion=&quot;21&quot;
        android:targetSdkVersion=&quot;21&quot; /&gt;

    &lt;uses-permission android:name=&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;/&gt;
    &lt;uses-permission android:name=&quot;android.permission.READ_EXTERNAL_STORAGE&quot;/&gt;
    &lt;uses-permission android:name=&quot;android.permission.INTERNET&quot;/&gt;
    &lt;uses-permission android:name=&quot;android.permission.ACCESS_FINE_LOCATION&quot; /&gt;
    &lt;uses-permission android:name=&quot;android.permission.ACCESS_COARSE_LOCATION&quot; /&gt;

    &lt;application&gt;
        &lt;activity
            android:name=&quot;.LocationActivity&quot;
            android:label=&quot;Location Service&quot; &gt;
            &lt;intent-filter&gt;
                &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;
                &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;
            &lt;/intent-filter&gt;
        &lt;/activity&gt;
        &lt;service
          android:name=&quot;.LocationService&quot;
          android:exported=&quot;false&quot;
          android:label=&quot;Location Service&quot;
          android:process=&quot;:LocationService&quot;&gt;
        &lt;/service&gt;
    &lt;/application&gt;
&lt;/manifest&gt;
EOF
</code></pre><p>We&#39;ll create a resource file to hold some values. The Android Gradle plugin
will fail if no resources are defined.</p>
<!-- @addResources @test -->
<pre><code>mkdir -p src/main/res/values
cat &lt;&lt;EOF &gt; src/main/res/values/strings.xml
&lt;resources&gt;
    &lt;string name=&quot;app_name&quot;&gt;Location&lt;/string&gt;
&lt;/resources&gt;
EOF
</code></pre><h1 id="deploying-and-running-the-application">Deploying and running the application</h1>
<p>Finally, you&#39;re ready to build and deploy your Android application. To do this:</p>
<!-- @assembleRelease @test -->
<pre><code>gradle assembleRelease
</code></pre><p>This will produce file named <code>build/outputs/location-release-unsigned.apk</code>. You
can install this on your phone:</p>
<pre><code>$HOME/.android-sdk/platform-tools/adb \
    install -r build/outputs/location-release-unsigned.apk
</code></pre><p>You will now find your application in your phone&#39;s application list. When you
run it, you will need to pick some blessings. Choose your email address from the
account list.</p>
<h1 id="calling-the-server">Calling the server</h1>
<p>The server is now running on your phone and listening for connections. Now we
can connect to it from another computer. We&#39;ll use the <code>vrpc</code> command in the
<a href="/glossary.html#vanadium-definition-language-vdl-">Vanadium distribution</a>. Once you&#39;ve installed that, we need to get
ourselves some blessings to talk to the phone.</p>
<p>The Vanadium server that we placed into the Vanadium namespace uses a default
authorizer. This means that it will trust an incoming connection if the client
provides blessings that share a common name with the server.</p>
<pre><code>$HOME/v23_release/bin/principal \
    --v23.credentials=/tmp/creds seekblessings

# This command will open a browser. In it, you should sign in to Google using
# the same email address that you used on your phone.
</code></pre><p>Now let&#39;s make the call:</p>
<pre><code>$HOME/v23_release/bin/vrpc \
    --v23.credentials=/tmp/creds \
    call /users/you@gmail.com/android/io.v.location/location
</code></pre><p>Try making some changes to the phone&#39;s network configuration. For example,
disconnect from the Wi-Fi network so that your phone is using a mobile data
connection. Your location requests should still be successful.</p>
<h1 id="summary">Summary</h1>
<p>Congratulations! You have successfully built and run the location service
application on Android.</p>
<p>You have:</p>
<ul>
<li>built a Vanadium-enabled secure location server Android application</li>
<li>connected to that application from your desktop</li>
<li>observed that changes to the network configuration of the server do not
affect its ability to receive requests</li>
</ul>
<p>There are a few things to note:</p>
<ul>
<li>we have used the Account Manager application to authenticate to Google via
OAuth. While you&#39;re more than welcome to use Google to authenticate, you are
free to come up with your own methods for trusting peers. For example, you
might want to exchange blessings via <a href="https://developer.android.com/guide/topics/connectivity/nfc/index.html">NFC beaming</a>.</li>
<li>to keep the tutorial as small as possible, we did not use the Android
declarative XML UI framework. You will probably want to use that when
writing a real application</li>
</ul>

    </main>
    <nav class="previous-next">
      <a href="/tutorials/java/fortune.html" class="previous">
        <div class="icon"><i class="material-icons">arrow_back</i></div>
        <div class="text-wrapper">
          <small>Previous</small>
          <div class="text">
            <span>Fortune in Java</span>
          </div>
        </div>
      </a>
</nav>
  </body>
</html>
