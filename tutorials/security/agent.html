<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,
                                   initial-scale=1,
                                   minimum-scale=1,
                                   maximum-scale=1,
                                   user-scalable=no,
                                   minimal-ui">
  
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
  
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
    <title>The Agent - Vanadium</title>
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,400,400italic,500,500italic,700,700italic|Source+Code+Pro">
  
    <link rel="stylesheet" href="/css/github.css">
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  
    <script src="/js/react-0.14.3.min.js"></script>
    <script src="/js/react-dom-0.14.3.min.js"></script>
  
    <link rel="apple-touch-icon" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="160x160" href="/favicons/favicon-160x160.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/favicons/favicon-192x192.png">
    <meta name="msapplication-TileColor" content="#00acc1">
    <meta name="msapplication-TileImage" content="/favicons/mstile-144x144.png">
  
    <link rel="stylesheet" href="/css/bundle.css">
    <script src="/js/bundle.js"></script>
  </head>
  <body>
    <header class="mdl-shadow--2dp">
      <div class="row">
        <div class="icon menu"><i class="material-icons">menu</i></div>
        <div class="icon v-icon"><img src="/images/v-icon-white.svg"></div>
        <div class="logo"><a href="/">Vanadium</a></div>
        <div class="spacer"></div>
        <nav>
          <a href="/">Overview</a>
          <a href="/installation/">Installation</a>
          <a href="/tutorials/hello-world.html">Tutorials</a>
        </nav>
      </div>
    </header>
    <div class="sidebar"></div>
    <div class="sidebar-data">
      <a href="/">Overview</a>
      <a href="/installation/">Installation</a>
    
      <a href="#" class="nav">Tutorials</a>
      <nav>
        <a href="/tutorials/hello-world.html">Hello World</a>
        <a href="/tutorials/basics.html">Client/Server Basics</a>
    
        <a href="#" class="nav">Security</a>
        <nav>
          <a href="/tutorials/security/">Overview</a>
          <a href="/tutorials/security/principals-and-blessings.html">Principals and Blessings</a>
      <a href="/tutorials/security/permissions-authorizer.html">Permissions Authorizer</a>
      <a href="/tutorials/security/first-party-caveats.html">Caveats</a>
      <a href="/tutorials/security/third-party-caveats.html">Third-party Caveats</a>
      <a href="/tutorials/security/agent.html">The Agent</a>
      <a href="/tutorials/security/custom-authorizer.html">Custom Authorizer</a>
    </nav>
    
        <a href="#" class="nav">Naming</a>
        <nav>
          <a href="/tutorials/naming/">Overview</a>
          <a href="/tutorials/naming/mount-table.html">The Mount Table</a>
      <a href="/tutorials/naming/namespace.html">Namespaces</a>
      <a href="/tutorials/naming/suffix-part1.html">The Suffix - Part I</a>
      <a href="/tutorials/naming/suffix-part2.html">The Suffix - Part II</a>
      <a href="/tutorials/naming/globber.html">Globber</a>
    </nav>
    
        <a href="#" class="nav">Java</a>
        <nav>
          <a href="/tutorials/java/">Overview</a>
          <a href="/tutorials/java/fortune.html">Fortune in Java</a>
      <a href="/tutorials/java/android.html">Location Service in Android</a>
    </nav>
    
        <a href="#" class="nav">JavaScript</a>
        <nav>
          <a href="/tutorials/javascript/">Overview</a>
          <a href="/tutorials/javascript/hellopeer.html">Hello Peer</a>
      <a href="/tutorials/javascript/fortune.html">Fortune in JS</a>
      <a href="/tutorials/javascript/security.html">Security in JS</a>
    </nav>
    
        <a href="/tutorials/faq.html">Tutorial FAQ</a>
      </nav>
    
      <a href="#" class="nav">Concepts</a>
      <nav>
        <a href="/concepts/rpc.html">RPC System</a>
    <a href="/concepts/naming.html">Naming</a>
    <a href="/concepts/security.html">Security</a>
    <a href="/concepts/device-management.html">Device Management</a>
    <a href="/concepts/syncbase-overview.html">Syncbase</a>
  </nav>
    
      <a href="/example-apps.html">Example Apps</a>
      <a href="/api-reference.html">API Reference</a>
    
      <a href="#" class="nav">Community</a>
      <nav>
        <a href="/community/coding-guidelines.html">Coding Guidelines</a>
    <a href="/community/contributing.html">Contributing</a>
  </nav>
    
      <a href="#" class="nav">Tools</a>
      <nav>
        <a href="/tools/identity-service-faq.html">Vanadium Identity Service</a>
    <a href="/tools/jiri.html">Jiri</a>
    <a href="/tools/services.html">Vanadium Cloud Services</a>
    <a href="/tools/vanadium-chrome-extension.html">Vanadium Chrome Extension</a>
  </nav>
    
      <a href="#" class="nav">Design Docs</a>
      <nav>
        <a href="/designdocs/authentication.html">Authentication Protocol</a>
    <a href="/designdocs/identity-service.html">Identity Service</a>
    <a href="/designdocs/vdl-spec.html">VDL Specification</a>
    <a href="/designdocs/vom-spec.html">VOM Specification</a>
  </nav>
    
      <a href="/glossary.html">Glossary</a>
      <a href="/faq.html">FAQ</a>
      <a href="/tos.html">Terms of Service</a>
    </div>
    <main>
      <h1 class="title">
        
        The Agent
      </h1>

      <p class="wherein"><strong>Wherein</strong> you use a security agent to maintain your secrets and facilitate your secure use of Vanadium.</p>

      <div class="toc"></div>

      <div class="prerequisites">
      <div class="note info"><p><strong>Prerequisites</strong>:<br>
All tutorials require Vanadium <a href="/installation/">installation</a>, and must run in a <a href="/tutorials/faq.html#why-bash-">bash shell</a>.
<br>Further, please <a href="/sh/scenario-d-setup.sh" download="scenario-d-setup.sh"> download this script</a> then <a href="/tutorials/faq.html#why-source-">source</a> it:</p>
<pre><code>source ~/Downloads/scenario-d-setup.sh
</code></pre><p>This command wipes tutorial files and defines shell environment variables. If you start a new terminal, and just want to re-establish the environment, see instructions <a href="/tutorials/setup.html">here</a>.
</p>
<p></p>
<p></p>
</div>
</div>

      <h1 id="motivation">Motivation</h1>
<p>In the <a href="/tutorials/security/principals-and-blessings.html#principals">principals tutorial</a> you used the <code>principal create</code> command
to create the <em>principals</em> Alice, Bob, etc.  The operation made
collections of files in the specified target directories, e.g.:</p>
<!-- @lsCredAlice @test -->
<pre><code>ls $V_TUT/cred/alice $V_TUT/cred/bob
</code></pre><p>Stored among these files are the private keys associated with Alice
and Bob.  The keys could be encrypted (there are ways to do that), but
at the moment, they aren&#39;t.  At no point during earlier tutorials did
you - the tutee - get prompted for a passphrase, despite frequent use
of the <code>--v23.credentials {directory}</code> flag.</p>
<p>Using that flag means the given program loads the private key into
process memory as part of its runtime initialization.</p>
<p>This was OK for the tutorials, which had the goal of <em>teaching</em>
security concepts rather than <em>being</em> secure.  You were running only
official Vanadium apps or programs that you wrote, in your own
authenticated session, on a machine under your control.</p>
<p>But easy access to the private key is not OK under normal
circumstances. A private key should be private.</p>
<p>Likewise, the way blessings have been generated so far -  in which
you the tutee casually exploited your read access to the private keys
of both the blessor and blessee - isn&#39;t practical for blessings being
granted between disjoint principals remote from each other on
a network.</p>
<p>Encrypting the file on disk, and requiring a password with each
invocation of a command specifying <code>--v23.credentials {directory}</code>
will solve the immediate problem of a clear text key on disk, but
doesn&#39;t solve these other problems.</p>
<h1 id="an-agent-holds-the-key">An agent holds the key</h1>
<p>Part of the solution to these problems is <code>agentd</code>, a Vanadium utility
analogous to <a href="http://en.wikipedia.org/wiki/Ssh-agent"><code>ssh-agent</code></a>.  It loads credentials into its memory, and
serves key management requests from child processes.</p>
<p>The child process, needing to check the validity of blessings coming
in with a request, can pass said blessings (implicitly via the
runtime&#39;s use of a POSIX <a href="http://en.wikipedia.org/wiki/File_descriptor">file descriptor</a>) up to <code>agentd</code>, which then
does the necessary crypto with the keys it holds, passing the result
back to the child.</p>
<p>This happens in the Vanadium runtime - no new client code required.</p>
<p>To see that, rerun the <em>existing</em> client code against the <em>existing</em>
server code using two instances of the agent - one becomes Alice, the
other becomes Bob.</p>
<p>The only difference between the following command sequence and
<a href="/tutorials/security/permissions-authorizer.html#a-specific-permissions-map">previous usage</a> is that <code>agentd</code> takes the
<code>--v23.credentials</code> flag, rather than the client and server.</p>
<!-- @twoAgents @test -->
<pre><code># Clean up from previous attempt, if any.
kill_tut_process TUT_PID_AGENT
/bin/rm -f $V_TUT/server.txt

# Run the server under an agent.
$V_BIN/agentd --v23.credentials $V_TUT/cred/alice \
    $V_TUT/bin/server \
        --endpoint-file-name $V_TUT/server.txt \
        --perms &#39;{&quot;R&quot;: {&quot;In&quot;: [&quot;alice:family&quot;,
                               &quot;alice:friend&quot;]},
                  &quot;W&quot;: {&quot;In&quot;: [&quot;alice:family&quot;]}}&#39; &amp;
TUT_PID_AGENT=$!
# Wait for startup.
sleep 2s

# Run the client under an agent.
$V_BIN/agentd --v23.credentials $V_TUT/cred/bob \
    $V_TUT/bin/client --server `cat $V_TUT/server.txt`

# All done, kill the server.
kill_tut_process TUT_PID_AGENT
</code></pre><p>The above should run without errors, i.e. the client should report a
fortune.</p>
<p>The crucial new behavior here is that <em>neither the server nor client
binary had access to private keys</em>.  The runtime off-loaded all crypto
checks to the agent in a different process (the parent process).</p>
<p>In the normal course of events, where you run code whose source code
you&#39;ve not written or may not have access to, this is a critical
capability.  The program runs with clear identity, but cannot secretly
send the private keys to that identity elsewhere.</p>
<h1 id="become-alice">Become Alice</h1>
<p>Use <code>bash {scriptName}</code> as the argument to <code>agentd</code> to safely
run a script as a given identity.  Here, the script just runs
<code>principal dump</code> commands, introspecting its own identity:</p>
<!-- @becomeAlice @test -->
<pre><code>cat &lt;&lt;EOF &gt; $V_TUT/subshell.sh
  $V_BIN/principal dump
  $V_BIN/principal get forpeer ... | \
      $V_BIN/principal dumpblessings -
EOF
$V_BIN/agentd --v23.credentials $V_TUT/cred/alice \
    bash $V_TUT/subshell.sh
</code></pre><p>Don&#39;t do this now, but say you wanted to spend the day as Alice.  To
interactively issue many commands as a particular Vanadium principal,
just start an agent-wrapped <em>interactive</em> shell:</p>
<p><code>$V_BIN/agentd --v23.credentials {directory} bash</code></p>
<p>At the time of writing, only the <em>bash</em> shell (not <em>csh</em> or <em>zsh</em>)
supports the correct file descriptor forwarding to allow this.</p>
<h1 id="alice-s-vassals">Alice&#39;s vassals</h1>
<p>If you&#39;re running <em>as Alice</em>, and you want to run some program <code>foo</code>
with a distinct principal, use <code>vbecome</code>:</p>
<!-- @becomeOthers @test -->
<pre><code>cat &lt;&lt;EOF &gt; $V_TUT/subshell.sh
  echo &quot; &quot;
  echo &quot;************************ Alice:&quot;
  $V_BIN/principal dump
  echo &quot; &quot;
  echo &quot;************************ Alice&#39;s vassal Andy:&quot;
  $V_BIN/vbecome --name andy $V_BIN/principal dump
EOF
$V_BIN/agentd --v23.credentials $V_TUT/cred/alice \
    --additional-principals $V_TUT/cred/alice \
    bash $V_TUT/subshell.sh
</code></pre><p>Compare the output of the two <code>dump</code> commands to see that the first
one ran as simply <em>alice</em>, while the second, with <code>vbecome</code>, ran as
<em>alice:andy</em>.</p>
<p>The public keys of the two differ, indicating that the vassal is a
distinct principal.  A use for this behavior would be some manager of
many processes, running each process with a new identity.</p>
<p>Here&#39;s the server and client example again, using <code>vbecome</code> for the
client.  This example omits the <code>--name</code> flag on <code>vbecome</code>.  In this
case, <code>vbecome</code> uses the name of the executable being run as the blessing
name.  Thus, in this case, the blessing name will be <em>alice:client</em> (the agent
runs as <em>alice</em>, and the executable&#39;s name is <em>client</em>).</p>
<!-- @onceMoreWithFeeling @test -->
<pre><code>cat &lt;&lt;EOF &gt; $V_TUT/subshell.sh
  $V_TUT/bin/server \
      --endpoint-file-name $V_TUT/server.txt \
      --perms &#39;{&quot;R&quot;: {&quot;In&quot;: [&quot;alice:client&quot;]},
                &quot;W&quot;: {&quot;In&quot;: [&quot;alice:family&quot;]}}&#39; &amp;
  TUT_PID_SERVER=\$!
  sleep 2s # wait for startup
  $V_BIN/vbecome $V_TUT/bin/client \
      --server \`cat $V_TUT/server.txt\`
  kill \$TUT_PID_SERVER # Only making one call.
EOF
$V_BIN/agentd --v23.credentials $V_TUT/cred/alice \
    --additional-principals $V_TUT/cred/alice \
    bash $V_TUT/subshell.sh
</code></pre><p>The RPC works because the client runs with a blessing derived from the
principal running the server - specifically, the client runs with the
blessing <code>alice:client</code> (note the server&#39;s permissions).</p>
<h1 id="secure-blessing">Secure blessing</h1>
<p><a href="/tutorials/security/principals-and-blessings.html#blessings">Previous examples of blessing</a> used a Unix pipe to
transmit a blessing from one process running <code>principal bless</code> to some
other process using <code>principal set forpeer</code>.</p>
<p>The problem in that is not the blessing being sent &#39;in the clear&#39; -
that&#39;s OK.  The problem is that the person issuing the commands <em>has
direct access to credential data on both sides</em>.</p>
<p>The agent, and the command <code>principal recvblessing</code>, make the act of
blessing much more secure.</p>
<p>The following example involves two processes, securely running under
distinct agents (neither process can see private keys).</p>
<p>The first process, running as Bob, will get into a state where it
<em>waits</em> for a blessing. The second process, running as Alice, will
send the blessing.</p>
<p>First start Bob.  He&#39;ll wait for the blessing, then dump it and exit
as soon as he gets it.</p>
<!-- @receiveBlessing @sleep -->
<pre><code>cat &lt;&lt;EOF &gt; $V_TUT/subshell1.sh
  $V_BIN/principal recvblessings \
      --remote-arg-file $V_TUT/recvblessings_args.json
  $V_BIN/principal dump
EOF
$V_BIN/agentd --v23.credentials $V_TUT/cred/bob \
    bash $V_TUT/subshell1.sh &amp;
</code></pre><div class="note info"><p>The next commands can be run in the same terminal, but you might want to
start a <a href="/tutorials/setup.html">second terminal</a> to keep the process output disentangled.</p>
</div>

<p>Now run Alice.  Alice will transmit the blessing, using instructions
Bob left her in the file <code>$V_TUT/recvblessings_args.json</code>.</p>
<!-- @transmitBlessing @sleep -->
<pre><code>cat &lt;&lt;EOF &gt; $V_TUT/subshell2.sh
  echo &quot; &quot;
  echo &quot;Transmitting the blessing.&quot;
  $V_BIN/principal bless \
      --for 2h \
      --remote-arg-file $V_TUT/recvblessings_args.json \
      companion
EOF
$V_BIN/agentd --v23.credentials $V_TUT/cred/alice \
    bash $V_TUT/subshell2.sh
</code></pre><p>The <code>bless</code> command above transmits the blessing <code>alice:companion</code> from
Alice to Bob.  This blessing can be seen in the output of <code>principal
dump</code> in the output from Bob&#39;s shell.</p>
<p>In this scenario, neither Alice nor Bob nor the principal programs
running on either end had direct access to private keys.  Only the two
agents had the keys.</p>
<p>The file doesn&#39;t hold the blessing, it just holds communication
overhead data; see <code>$V_BIN/principal help recvblessings</code> for more
info.</p>
<h1 id="summary">Summary</h1>
<ul>
<li><p>Use <code>agentd</code> to keep your private keys private.</p>
</li>
<li><p>Use <code>vbecome</code> to seamlessly create a principal for a subprocess, blessed
by the principal of the existing process.</p>
</li>
<li><p>Use <code>principal recvblessing</code> to send a blessing over the network
from the command line.</p>
</li>
</ul>

    </main>
    <nav class="previous-next">
      <a href="/tutorials/security/third-party-caveats.html" class="previous">
        <div class="icon"><i class="material-icons">arrow_back</i></div>
        <div class="text-wrapper">
          <small>Previous</small>
          <div class="text">
            <span>Third-party Caveats</span>
          </div>
        </div>
      </a>
  <a href="/tutorials/security/custom-authorizer.html" class="next">
        <div class="text-wrapper">
          <small>Next</small>
          <div class="text">
            <span>Custom Authorizer</span>
          </div>
        </div>
        <div class="icon"><i class="material-icons">arrow_forward</i></div>
      </a>
</nav>
  </body>
</html>
