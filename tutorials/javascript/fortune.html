<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,
                                   initial-scale=1,
                                   minimum-scale=1,
                                   maximum-scale=1,
                                   user-scalable=no,
                                   minimal-ui">
  
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
  
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
    <title>Fortune in JS - Vanadium</title>
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,400,400italic,500,500italic,700,700italic|Source+Code+Pro">
  
    <link rel="stylesheet" href="/css/github.css">
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  
    <script src="/js/react-0.14.3.min.js"></script>
    <script src="/js/react-dom-0.14.3.min.js"></script>
  
    <link rel="apple-touch-icon" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="160x160" href="/favicons/favicon-160x160.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/favicons/favicon-192x192.png">
    <meta name="msapplication-TileColor" content="#00acc1">
    <meta name="msapplication-TileImage" content="/favicons/mstile-144x144.png">
  
    <link rel="stylesheet" href="/css/bundle.css">
    <script src="/js/bundle.js"></script>
  </head>
  <body>
    <header class="mdl-shadow--2dp">
      <div class="row">
        <div class="icon menu"><i class="material-icons">menu</i></div>
        <div class="icon v-icon"><img src="/images/v-icon-white.svg"></div>
        <div class="logo"><a href="/">Vanadium</a></div>
        <div class="spacer"></div>
        <nav>
          <a href="/">Overview</a>
          <a href="/installation/">Installation</a>
          <a href="/tutorials/hello-world.html">Tutorials</a>
        </nav>
      </div>
    </header>
    <div class="sidebar"></div>
    <div class="sidebar-data">
      <a href="/">Overview</a>
      <a href="/installation/">Installation</a>
    
      <a href="#" class="nav">Tutorials</a>
      <nav>
        <a href="/tutorials/hello-world.html">Hello World</a>
        <a href="/tutorials/basics.html">Client/Server Basics</a>
    
        <a href="#" class="nav">Security</a>
        <nav>
          <a href="/tutorials/security/">Overview</a>
          <a href="/tutorials/security/principals-and-blessings.html">Principals and Blessings</a>
      <a href="/tutorials/security/permissions-authorizer.html">Permissions Authorizer</a>
      <a href="/tutorials/security/first-party-caveats.html">Caveats</a>
      <a href="/tutorials/security/third-party-caveats.html">Third-party Caveats</a>
      <a href="/tutorials/security/agent.html">The Agent</a>
      <a href="/tutorials/security/custom-authorizer.html">Custom Authorizer</a>
    </nav>
    
        <a href="#" class="nav">Naming</a>
        <nav>
          <a href="/tutorials/naming/">Overview</a>
          <a href="/tutorials/naming/mount-table.html">The Mount Table</a>
      <a href="/tutorials/naming/namespace.html">Namespaces</a>
      <a href="/tutorials/naming/suffix-part1.html">The Suffix - Part I</a>
      <a href="/tutorials/naming/suffix-part2.html">The Suffix - Part II</a>
      <a href="/tutorials/naming/globber.html">Globber</a>
    </nav>
    
        <a href="#" class="nav">Java</a>
        <nav>
          <a href="/tutorials/java/">Overview</a>
          <a href="/tutorials/java/fortune.html">Fortune in Java</a>
      <a href="/tutorials/java/android.html">Location Service in Android</a>
    </nav>
    
        <a href="#" class="nav">JavaScript</a>
        <nav>
          <a href="/tutorials/javascript/">Overview</a>
          <a href="/tutorials/javascript/hellopeer.html">Hello Peer</a>
      <a href="/tutorials/javascript/fortune.html">Fortune in JS</a>
      <a href="/tutorials/javascript/security.html">Security in JS</a>
    </nav>
    
        <a href="/tutorials/faq.html">Tutorial FAQ</a>
      </nav>
    
      <a href="#" class="nav">Concepts</a>
      <nav>
        <a href="/concepts/rpc.html">RPC System</a>
    <a href="/concepts/naming.html">Naming</a>
    <a href="/concepts/security.html">Security</a>
    <a href="/concepts/device-management.html">Device Management</a>
    <a href="/concepts/syncbase-overview.html">Syncbase</a>
  </nav>
    
      <a href="/example-apps.html">Example Apps</a>
      <a href="/api-reference.html">API Reference</a>
    
      <a href="#" class="nav">Community</a>
      <nav>
        <a href="/community/coding-guidelines.html">Coding Guidelines</a>
    <a href="/community/contributing.html">Contributing</a>
  </nav>
    
      <a href="#" class="nav">Tools</a>
      <nav>
        <a href="/tools/identity-service-faq.html">Vanadium Identity Service</a>
    <a href="/tools/jiri.html">Jiri</a>
    <a href="/tools/services.html">Vanadium Cloud Services</a>
    <a href="/tools/vanadium-chrome-extension.html">Vanadium Chrome Extension</a>
  </nav>
    
      <a href="#" class="nav">Design Docs</a>
      <nav>
        <a href="/designdocs/authentication.html">Authentication Protocol</a>
    <a href="/designdocs/identity-service.html">Identity Service</a>
    <a href="/designdocs/vdl-spec.html">VDL Specification</a>
    <a href="/designdocs/vom-spec.html">VOM Specification</a>
  </nav>
    
      <a href="/glossary.html">Glossary</a>
      <a href="/faq.html">FAQ</a>
      <a href="/tos.html">Terms of Service</a>
    </div>
    <main>
      <h1 class="title">
        Fortune in JavaScript
        
      </h1>

      <p class="wherein"><strong>Wherein</strong> you build a fortune teller service and a client to talk to it.</p>

      <div class="toc"></div>

      <div class="prerequisites">
      <div class="note info"><p><strong>Prerequisites</strong>:<br>
All tutorials require Vanadium <a href="/installation/">installation</a>, and must run in a <a href="/tutorials/faq.html#why-bash-">bash shell</a>.
<br>Further, please <a href="/sh/scenario-e-setup.sh" download="scenario-e-setup.sh"> download this script</a> then <a href="/tutorials/faq.html#why-source-">source</a> it:</p>
<pre><code>source ~/Downloads/scenario-e-setup.sh
</code></pre><p>This command wipes tutorial files and defines shell environment variables. If you start a new terminal, and just want to re-establish the environment, see instructions <a href="/tutorials/setup.html">here</a>.
</p>
<p>Also:<ul>
<li>
Please see the <a href="/tutorials/basics.html">Client/Server Basics tutorial</a> and the <a href="/tutorials/javascript/hellopeer.html">Hello Peer tutorial</a> for background concepts.
</li><li>
Please install the <a href="https://chrome.google.com/webstore/detail/vanadium-extension/jcaelnibllfoobpedofhlaobfcoknpap">Vanadium Chrome extension from the Chrome web store</a>.
</li>
</ul></p>
<p>
If you would like to generate files from this tutorial without the copy/paste steps, download and source <a href="/sh/tut-completer-js-fortune.sh" download="tut-completer-js-fortune.sh">this script</a>. Files will be created in the <code>$V_TUT</code> <a href="/tutorials/setup.html">directory</a>.
</p>
</div>
</div>

      <h2 id="introduction">Introduction</h2>
<p>This tutorial creates a fortune teller example in order to go more deeply into
some Vanadium concepts than <a href="/tutorials/javascript/hellopeer.html">Hello Peer</a>. In addition, this
tutorial demonstrates how to connect
the application with a compatible Go-language fortune application.</p>
<p>JavaScript Vanadium applications are based around the same fundamental structure
as Go Vanadium applications. Because of the similarities, this tutorial
focuses on the differences between building Vanadium applications
in Go and JavaScript.</p>
<h2 id="defining-the-fortune-service">Defining the Fortune service</h2>
<p>In the <a href="/tutorials/javascript/hellopeer.html">Hello Peer</a> tutorial, <a href="/glossary.html#vanadium-definition-language-vdl-">VDL</a> (Vanadium Definition Language)
was not used.
It is possible to communicate without VDL for simple applications, but
it is strongly recommended to use VDL for cross-platform, cross-language,
or more complex applications. VDL provides a clear, strongly-typed definition
of the protocols that your clients and servers will use to communicate with each other.</p>
<p>When not using VDL, different programming languages may have different
representations of values that may not be coerced to compatible types.
In particular, a special representation is used for JavaScript values
when VDL is not being used that may be incompatible with Go values.</p>
<h3 id="fortune-vdl">Fortune VDL</h3>
<p>We will reuse the same interface definition from the
<a href="/tutorials/basics.html">Client/Server Basics tutorial</a>.
<code>$V_TUT/src/fortune/ifc/fortune.vdl</code> defines a fortune teller service, which
allows clients to <code>Get</code> and <code>Add</code> fortunes. The relevant code is reproduced below:</p>
<pre><code class="noclipboard">package fortune

type Fortune interface {
  // Returns a random fortune.
  Get() (wisdom string | error)
  // Adds a fortune to the set used by Get().
  Add(wisdom string) error
}</code></pre>

<p>The <code>vdl</code> tool generates a JavaScript file from this protocol definition.</p>
<!-- @generateFortuneVDLJS @buildjs @test @testui @completer -->
<pre><code>mkdir -p $V_TUT/src/fortune
VDLROOT=$V23_RELEASE/src/v.io/v23/vdlroot \
    VDLPATH=$V_TUT/src \
    $V_BIN/vdl generate -lang=javascript -js-out-dir=$V_TUT/src \
    $V_TUT/src/fortune/ifc
</code></pre><p>When generating JavaScript, the flag <code>-js-out-dir</code> is used to specify where
generated files should appear.
After running this command, <code>$V_TUT/src/fortune/ifc/index.js</code>
should have been created.</p>
<h3 id="implementation">Implementation</h3>
<p>The code below implements the Fortune service.
It defines the <code>Get</code> and <code>Add</code> methods and attaches the VDL-generated interface
description to the service&#39;s prototype chain.</p>
<p>Create <code>$V_TUT/src/fortune/service/index.js</code>.</p>
<!-- @fortuneImplementation @buildjs @test @testui @completer -->
<pre><code>mkdir -p $V_TUT/src/fortune/service
cat - &lt;&lt;EOF &gt;$V_TUT/src/fortune/service/index.js
var vdlFortune = require(&#39;../ifc&#39;);

module.exports = FortuneService;

// Define the fortune service.
function FortuneService() {
  this.fortunes = [
    &#39;You will reach the heights of success.&#39;,
    &#39;Conquer your fears or they will conquer you.&#39;,
    &#39;Today is your lucky day!&#39;,
  ];
  this.numFortunesServed = 0;
}

// Add VDL service metadata and type information.
FortuneService.prototype = new vdlFortune.Fortune();

// Define the FortuneServiceMethod bodies.
FortuneService.prototype.add = function(ctx, serverCall, wisdom) {
  this.fortunes.push(wisdom);
}
FortuneService.prototype.get = function(ctx, serverCall) {
  this.numFortunesServed++;
  var fortuneIndex = Math.floor(Math.random() *
    this.fortunes.length);
  return this.fortunes[fortuneIndex];
};
EOF
</code></pre><p>This service implementation is analogous to Go&#39;s. It also exposes two fields,
<code>fortunes</code> and <code>numFortunesServed</code>, which will be used to make the fortune teller
more interactive.</p>
<h2 id="fortune-server">Fortune server</h2>
<p>Two files are used to serve the Fortune service: the JavaScript file that
serves the service and an HTML page to display the server status.</p>
<h3 id="server-code">Server code</h3>
<p>Use a Vanadium server to serve the Fortune service.</p>
<!-- @fortuneServerJS @buildjs @test @testui @completer -->
<pre><code>mkdir -p $V_TUT/src/fortune/server
cat - &lt;&lt;EOF &gt;$V_TUT/src/fortune/server/index.js
var vanadium = require(&#39;vanadium&#39;);
var FortuneService = require(&#39;../service&#39;);

// Define the Vanadium configuration for this app.
var config = {
  logLevel: vanadium.vlog.levels.INFO,
  appName: &#39;Fortune Server&#39;
};

// Setup Vanadium and serve the Fortune service.
vanadium.init(config, function(err, runtime) {
  if (err) {
    return displayError(err);
  }
  runtime.on(&#39;crash&#39;, displayError);

  // Create and serve the Fortune service.
  var service = new FortuneService();
  var serviceName = getDefaultServiceName(runtime.accountName);
  runtime.newServer(serviceName, service, function(err) {
    if (err) {
      displayError(err);
    }
  });

  // Initialize the UI (see fortune-server.html).
  uiInit(service, serviceName);
});
function getDefaultServiceName(accountName) {
  var homeDir = accountName.replace(/^dev.v.io:u:/, &#39;users/&#39;).replace(vanadium.security.ChainSeparator.val, &#39;/&#39;);
  return homeDir + &#39;/tutorial/fortune&#39;;
}
EOF
</code></pre><p>The Fortune server works similarly to the one in the <a href="/tutorials/basics.html">Client/Server Basics tutorial</a>.
The service implementation:</p>
<ul>
<li>Uses a VDL protocol to define the Fortune interface</li>
<li>Creates and runs the Fortune service</li>
<li>Uses the default authorizer</li>
<li>Uses the default dispatcher</li>
</ul>
<p>The following sections describe some <strong>key differences</strong> between the JavaScript
and Go APIs.</p>
<h3 id="configuration">Configuration</h3>
<p>A configuration can optionally be specified when initializing Vanadium,
for example:</p>
<pre><code class="noclipboard">var config = {
  logLevel: vanadium.vlog.levels.INFO,
  appName: 'Fortune Server'
};</code></pre>

<p>This sets the output level for Vanadium log messages to <code>INFO</code> (<code>WARN</code> is the default)
and sets the name of the application, which is primarily used to identify the
application in error messages.</p>
<p>Similar parameters are typically specified through command line flags with Go.</p>
<h3 id="serving-at-a-name">Serving at a name</h3>
<p>The Fortune service was served using a Vanadium <a href="/glossary.html#object-name">name</a>. To learn more about names and name resolution, read
the <a href="/concepts/naming.html">Naming Concepts</a> page or go through the <a href="/tutorials/naming/">Naming tutorial</a>.</p>
<pre><code class="noclipboard">// Serve the service at a Vanadium name.
server.serve(name, service, callback);</code></pre>

<p>In the <a href="/tutorials/basics.html">Client/Server Basics tutorial</a>, the Fortune client connected to the server directly using
a name rooted at its <a href="/glossary.html#endpoint">endpoint address</a>.
In contrast, the server in this tutorial uses a name that does not include
an endpoint address and is resolved against a mount table.</p>
<h3 id="server-html">Server HTML</h3>
<p>Create the HTML page. This page displays:</p>
<ul>
<li>The service name</li>
<li>The number of fortunes sent by the service</li>
<li>The service&#39;s list of fortunes</li>
</ul>
<p>The service will manipulate the page as its data is updated.</p>
<!-- @fortuneServerHTML @buildjs @test @testui @completer -->
<pre><code>cat - &lt;&lt;EOF &gt;$V_TUT/fortune-server.html
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;Fortune Teller - Server&lt;/title&gt;
  &lt;script&gt;
    // Helpers to display status information on the page.
    function displayError(err) {
      displayNumFortunesServed(&#39;Error: &#39; + err.toString());
    }
    function displayNumFortunesServed(count) {
      document.getElementById(&#39;fortune-count&#39;).innerHTML = count;
    }
    function displayFortunes(fortunes) {
      var fortuneList = document.getElementById(&#39;fortune-list&#39;);
      // Assume that only new fortunes can be added to the end list.
      for (var i = fortuneList.childNodes.length; i &lt; fortunes.length; i++) {
        var bullet = document.createElement(&#39;li&#39;);
        bullet.textContent = fortunes[i];
        fortuneList.appendChild(bullet);
      }
    }
    function setServiceName(serviceName) {
      return document.getElementById(&#39;service-name&#39;).textContent = serviceName;
    }
    function uiInit(service, serviceName) {
      setServiceName(serviceName);
      setInterval(function() {
        displayNumFortunesServed(service.numFortunesServed);
        displayFortunes(service.fortunes);
      }, 250);
    }
  &lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;Server&lt;/h1&gt;
  &lt;p&gt;
    &lt;span&gt;Name of service to provide to clients: &lt;/span&gt;
    &lt;span id=&quot;service-name&quot;&gt;&lt;/span&gt;
  &lt;/p&gt;
  &lt;p&gt;
    List of fortunes:
    &lt;br&gt;&lt;ol id=&quot;fortune-list&quot;&gt;&lt;/ol&gt;&lt;/br&gt;
  &lt;/p&gt;
  &lt;p&gt;
    Total Fortunes Sent: &lt;span id=&quot;fortune-count&quot;&gt;0&lt;/span&gt;
  &lt;/p&gt;
  &lt;script src=&quot;browser/fortune-server.js&quot;&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
EOF
</code></pre><h2 id="fortune-client">Fortune client</h2>
<p>As with the server, the client consists of two files: a JavaScript file that
contains the application logic and an HTML page for the user interface.</p>
<h3 id="client-code">Client code</h3>
<p>The client code starts Vanadium and waits for the user to act.</p>
<ul>
<li>Upon pressing the <code>Add</code> button, the client makes an <code>Add</code> RPC request.</li>
<li>Upon pressing the <code>Get</code> button, the client makes a <code>Get</code> RPC request.</li>
</ul>
<p>Create <code>$V_TUT/src/fortune/client/index.js</code>.</p>
<!-- @fortuneClientJS @buildjs @test @testui @completer -->
<pre><code>mkdir -p $V_TUT/src/fortune/client
cat - &lt;&lt;EOF &gt;$V_TUT/src/fortune/client/index.js
var vanadium = require(&#39;vanadium&#39;);

// Define the Vanadium configuration for this app.
var config = {
  logLevel: vanadium.vlog.levels.INFO,
  appName: &#39;Fortune Client&#39;
};

vanadium.init(config, function(err, runtime) {
  if (err) {
    displayError(err);
    return;
  }

  // Get runtime context and client.
  var context = runtime.getContext();
  var client = runtime.getClient();

  // Set default service name.
  var defaultName = getDefaultServiceName(runtime.accountName);
  setServiceName(defaultName);

  // Listen for button presses.
  document.getElementById(&#39;get-button&#39;).addEventListener(&#39;click&#39;, getFortune);
  document.getElementById(&#39;add-button&#39;).addEventListener(&#39;click&#39;, addFortune);

  // Adds a fortune to the fortune teller.
  function addFortune() {
    updateStatus(&#39;Adding &#39; + getEnteredFortune() + &#39;...&#39;);
    client.bindTo(context, getServiceName(), function(err, s) {
      if (err) {
        displayError(err);
        return;
      }

      s.add(context, getEnteredFortune(), function(err) {
        if (err) {
          displayError(err);
          return;
        }
        updateStatus(&#39;Done!&#39;);
      });
    });
  }

  // Gets a random fortune from the fortune teller.
  function getFortune() {
    updateStatus(&#39;Getting random fortune...&#39;);
    client.bindTo(context, getServiceName(), function(err, s) {
      if (err) {
        displayError(err);
        return;
      }

      s.get(context, function(err, randomFortune) {
        if (err) {
          displayError(err);
          return;
        }

        displayFortune(randomFortune);
        updateStatus(&#39;Done!&#39;);
      });
    });
  }
});
function getDefaultServiceName(accountName) {
  var homeDir = accountName.replace(/^dev.v.io:u:/, &#39;users/&#39;).replace(vanadium.security.ChainSeparator.val, &#39;/&#39;);
  return homeDir + &#39;/tutorial/fortune&#39;;
}
EOF
</code></pre><h3 id="client-html">Client HTML</h3>
<p>Create the client&#39;s HTML page. This page contains:</p>
<ul>
<li>An input for selecting the server endpoint</li>
<li>An input for adding new fortunes</li>
<li>A button to get new fortunes</li>
<li>A running list of fortunes received</li>
<li>JavaScript code to manipulate these elements</li>
</ul>
<!-- @fortuneClientHTML @buildjs @test @testui @completer -->
<pre><code>cat - &lt;&lt;EOF &gt;$V_TUT/fortune-client.html
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;Fortune Teller - Client&lt;/title&gt;
  &lt;script&gt;
    // Helpers to update and introspect the HTML page.
    function getServiceName() {
      return document.getElementById(&#39;service-name&#39;).value;
    }
    function setServiceName(serviceName) {
      return document.getElementById(&#39;service-name&#39;).value = serviceName;
    }
    function getEnteredFortune() {
      return document.getElementById(&#39;add-text&#39;).value;
    }
    function displayFortune(fortune) {
      var fortuneNode = document.createElement(&#39;li&#39;);
      fortuneNode.textContent = fortune;
      document.getElementById(&#39;fortune-list&#39;).appendChild(fortuneNode);
    }
    function displayError(err) {
      updateStatus(err.toString());
    }
    function updateStatus(status) {
      document.getElementById(&#39;status&#39;).innerHTML = status;
    }
  &lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;Client&lt;/h1&gt;
  &lt;p&gt;Service to connect to: &lt;input id=&quot;service-name&quot; type=&quot;text&quot; placeholder=&quot;Enter a service name&quot; size=&quot;60&quot; /&gt;&lt;/p&gt;
  &lt;p&gt;
  Fortune to add: &lt;input type=&quot;text&quot; id=&quot;add-text&quot; placeholder=&quot;write a custom fortune&quot; size=&quot;60&quot;/&gt; &lt;button id=&quot;add-button&quot;&gt;Add Fortune&lt;/button&gt;
  &lt;/p&gt;
  &lt;p&gt;&lt;button id=&quot;get-button&quot;&gt;Get Fortune&lt;/button&gt;&lt;/p&gt;
  &lt;h2&gt;Status: &lt;span id=&quot;status&quot;&gt;Ready&lt;/span&gt;&lt;/h2&gt;
  &lt;p&gt;Received fortunes: &lt;ol id=&quot;fortune-list&quot;&gt;&lt;/ol&gt;&lt;/p&gt;
  &lt;script src=&quot;browser/fortune-client.js&quot;&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
EOF
</code></pre><h3 id="about-bindto">About bindTo</h3>
<p>The example above uses <code>bindTo</code> to retrieve a service stub. This step does not
exist when using Go.</p>
<pre><code class="noclipboard">client.bindTo(context, name, callback);</code></pre>

<p><code>bindTo</code> retrieves the service definition from the remote server. This allows
the client to generate a service stub without needing a local VDL definition.
In contrast, Go clients typically get the service definition from the generated
VDL code because types must be known at compile-time.</p>
<p>If the JavaScript client already has access to the service signature, it can skip
the retrieval step by creating the stub directly using <code>bindWithSignature</code>:</p>
<pre><code class="noclipboard">client.bindWithSignature(name, signature);</code></pre>


<h3 id="about-contexts">About contexts</h3>
<p>The <code>context</code> or <code>ctx</code> variable has appeared in a few places in this tutorial.</p>
<pre><code class="noclipboard">// Client connecting to a service.
client.bindTo(context, serviceName, callback);

// Fortune service method definition.
FortuneService.prototype.get = function(ctx, serverCall) {
  ...
};</code></pre>

<p>Contexts are used to:</p>
<ul>
<li>Configure deadlines and timeouts for RPCs</li>
<li>Provide request traces when debugging</li>
<li>Carry security configuration information during a request</li>
</ul>
<p>When a service method is invoked, the context it receives should generally be
used for any ensuing outgoing RPCs so that the full sequence of calls can
be traced.</p>
<h2 id="running-fortune">Running Fortune</h2>
<h3 id="browserify">Browserify</h3>
<p>Use <code>browserify</code> to build the browser-targeted JavaScript files, which
integrate the Vanadium libraries with the server and client code.</p>
<!-- @browserifyFortune @buildjs @test @testui @completer -->
<pre><code>NODE_PATH=$V_TUT $V_TUT/node_modules/.bin/browserify \
  $V_TUT/src/fortune/client/index.js -o $V_TUT/browser/fortune-client.js
NODE_PATH=$V_TUT $V_TUT/node_modules/.bin/browserify \
  $V_TUT/src/fortune/server/index.js -o $V_TUT/browser/fortune-server.js
</code></pre><h3 id="combined-html-page">Combined HTML page</h3>
<p>For demonstration purposes, the Fortune client and server are shown on the same page.</p>
<!-- @fortuneIndexHTML @buildjs @test @testui @completer -->
<pre><code>cat - &lt;&lt;EOF &gt;$V_TUT/fortune.html
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;Fortune Teller&lt;/title&gt;
&lt;/head&gt;
&lt;body style=&quot;background: #000000;&quot;&gt;
  &lt;div style=&quot;position:fixed;top:0px;left:0px;bottom:0;width:48%; background: #ffffff;&quot;&gt;
    &lt;iframe id=&quot;client&quot; src=&quot;fortune-client.html&quot; style=&quot;width:100%; height:100%;&quot; frameBorder=&quot;0&quot;&gt;&lt;/iframe&gt;
  &lt;/div&gt;
  &lt;div style=&quot;position:fixed;top:0px;right:0px;bottom:0;width:48%; background: #ffffff;&quot;&gt;
    &lt;iframe id=&quot;server&quot; src=&quot;fortune-server.html&quot; style=&quot;width:100%; height:100%;&quot; frameBorder=&quot;0&quot;&gt;&lt;/iframe&gt;
  &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
EOF
</code></pre><h3 id="try-it-out">Try it out</h3>
<p>You are ready to serve the web pages on a local server. Run the web server on port 8989.</p>
<p>Using node-static, the command is:</p>
<!-- @nodeStaticBackground @test @testui @sleep -->
<pre><code>$V_TUT/node_modules/.bin/static $V_TUT -p 8989 &gt; /dev/null &amp;
TUT_PID_HTTPD=$!
</code></pre><p>This static server runs in the background and is stopped in the <a href="#cleanup">Cleanup section</a>.</p>
<p>Go to <a href="http://127.0.0.1:8989/fortune.html">http://127.0.0.1:8989/fortune.html</a> to view the examples.</p>
<h2 id="interoperating-with-go">Interoperating with Go</h2>
<p>The client and server defined here can communicate with the client and server that was defined in Go.</p>
<h3 id="creating-an-oauth-authenticated-principal-for-go">Creating an OAuth-authenticated principal for Go</h3>
<p>For simplicity, this example uses the default authorizer. To pass
the authorization check, it is possible to create a principal with
the proper blessings for communication with the browser. To read more, go to
the <a href="/concepts/security.html">Security Concepts</a> page or run through the <a href="/tutorials/security/principals-and-blessings.html">Principals and blessings</a> tutorial.</p>
<p>Use the <code>principal</code> tool, as follows:</p>
<pre><code>$V_BIN/principal --v23.credentials $V_TUT/cred/basics \
  seekblessings
</code></pre><p>A new tab will appear in the browser. Click the <code>Bless</code> button. The Go code
will now have access to an OAuth-authenticated blessing that matches the
browser&#39;s.</p>
<p>In general, it is not necessary to generate an identical set of blessings; other
authorizers can be used to grant access with different rules than the default
authorizer.</p>
<h3 id="go-client-js-server">Go client + JS server</h3>
<p>In order for the Go client to contact the JavaScript server, it needs the
Vanadium name for the server.</p>
<p><code>$JS_FORTUNE_NAME</code> will hold the name of the JavaScript server. The following
command parses the principal and computes the name of the fortune server.
It should match the service name listed on the Fortune page.</p>
<pre><code>export JS_FORTUNE_NAME=$(
  $V23_RELEASE/bin/principal get \
    --v23.credentials $V_TUT/cred/basics default \
    | $V_BIN/principal dumpblessings - \
    | awk -F/ &#39;/Blessings/ {print &quot;users/&quot; $3 &quot;/chrome/tutorial/fortune&quot;}&#39;
  )
</code></pre><p>Use the Go fortune client to request a fortune from the JS server.</p>
<pre><code>$V_TUT/bin/client --v23.credentials $V_TUT/cred/basics \
  --server $JS_FORTUNE_NAME
</code></pre><p>It is also possible to add a fortune:</p>
<pre><code>$V_TUT/bin/client --v23.credentials $V_TUT/cred/basics \
  --server $JS_FORTUNE_NAME -add &#39;Fortune favors the bold.&#39;
</code></pre><h3 id="go-server-js-client">Go server + JS client</h3>
<p>To use a Go fortune server with a JS client, first run the server.</p>
<!-- @runFortuneGoServer @test @testui @sleep -->
<pre><code>kill_tut_process TUT_PID_SERVER
$V_TUT/bin/server --v23.credentials $V_TUT/cred/basics \
  --endpoint-file-name=$V_TUT/server.txt &amp;
TUT_PID_SERVER=$!
</code></pre><p>The server&#39;s endpoint will be used to identify the fortune service. To get
the endpoint, run the following command.</p>
<!-- @runFortuneGoServer -->
<pre><code>cat $V_TUT/server.txt # The go server&#39;s endpoint address
</code></pre><p>The Go server&#39;s endpoint should be printed out to the console.
<strong>Copy this endpoint and paste it into the client page&#39;s Server field.</strong></p>
<p>The JS client will now be able to call <code>Get</code> and <code>Add</code> on the Go server.</p>
<h2 id="cleanup">Cleanup</h2>
<p>Once finished, stop the HTTP server and the Go fortune server.</p>
<!-- @runFortuneGoServer @test @testui -->
<pre><code>kill $TUT_PID_HTTPD
kill $TUT_PID_SERVER
</code></pre><h2 id="summary">Summary</h2>
<p>Congratulations! You have successfully run the Go-JS fortune example.</p>
<p>You have:</p>
<ul>
<li>Built a fortune client and server in JavaScript. A hosted copy of the tutorial
result can be accessed <a href="/tutorials/javascript/results/fortune.html">here</a>.</li>
<li>Established communication between the JavaScript and Go clients and servers.</li>
<li>Learned about using Vanadium in JavaScript as compared to Go.</li>
</ul>

    </main>
    <nav class="previous-next">
      <a href="/tutorials/javascript/hellopeer.html" class="previous">
        <div class="icon"><i class="material-icons">arrow_back</i></div>
        <div class="text-wrapper">
          <small>Previous</small>
          <div class="text">
            <span>Hello Peer</span>
          </div>
        </div>
      </a>
  <a href="/tutorials/javascript/security.html" class="next">
        <div class="text-wrapper">
          <small>Next</small>
          <div class="text">
            <span>Security in JS</span>
          </div>
        </div>
        <div class="icon"><i class="material-icons">arrow_forward</i></div>
      </a>
</nav>
  </body>
</html>
