<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,
                                   initial-scale=1,
                                   minimum-scale=1,
                                   maximum-scale=1,
                                   user-scalable=no,
                                   minimal-ui">
  
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
  
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
    <title>Hello Peer - Vanadium</title>
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,400,400italic,500,500italic,700,700italic|Source+Code+Pro">
  
    <link rel="stylesheet" href="/css/github.css">
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  
    <script src="/js/react-0.14.3.min.js"></script>
    <script src="/js/react-dom-0.14.3.min.js"></script>
  
    <link rel="apple-touch-icon" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="160x160" href="/favicons/favicon-160x160.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/favicons/favicon-192x192.png">
    <meta name="msapplication-TileColor" content="#00acc1">
    <meta name="msapplication-TileImage" content="/favicons/mstile-144x144.png">
  
    <link rel="stylesheet" href="/css/bundle.css">
    <script src="/js/bundle.js"></script>
  </head>
  <body>
    <header class="mdl-shadow--2dp">
      <div class="row">
        <div class="icon menu"><i class="material-icons">menu</i></div>
        <div class="icon v-icon"><img src="/images/v-icon-white.svg"></div>
        <div class="logo"><a href="/">Vanadium</a></div>
        <div class="spacer"></div>
        <nav>
          <a href="/">Overview</a>
          <a href="/installation/">Installation</a>
          <a href="/tutorials/hello-world.html">Tutorials</a>
        </nav>
      </div>
    </header>
    <div class="sidebar"></div>
    <div class="sidebar-data">
      <a href="/">Overview</a>
      <a href="/installation/">Installation</a>
    
      <a href="#" class="nav">Tutorials</a>
      <nav>
        <a href="/tutorials/hello-world.html">Hello World</a>
        <a href="/tutorials/basics.html">Client/Server Basics</a>
    
        <a href="#" class="nav">Security</a>
        <nav>
          <a href="/tutorials/security/">Overview</a>
          <a href="/tutorials/security/principals-and-blessings.html">Principals and Blessings</a>
      <a href="/tutorials/security/permissions-authorizer.html">Permissions Authorizer</a>
      <a href="/tutorials/security/first-party-caveats.html">Caveats</a>
      <a href="/tutorials/security/third-party-caveats.html">Third-party Caveats</a>
      <a href="/tutorials/security/agent.html">The Agent</a>
      <a href="/tutorials/security/custom-authorizer.html">Custom Authorizer</a>
    </nav>
    
        <a href="#" class="nav">Naming</a>
        <nav>
          <a href="/tutorials/naming/">Overview</a>
          <a href="/tutorials/naming/mount-table.html">The Mount Table</a>
      <a href="/tutorials/naming/namespace.html">Namespaces</a>
      <a href="/tutorials/naming/suffix-part1.html">The Suffix - Part I</a>
      <a href="/tutorials/naming/suffix-part2.html">The Suffix - Part II</a>
      <a href="/tutorials/naming/globber.html">Globber</a>
    </nav>
    
        <a href="#" class="nav">Java</a>
        <nav>
          <a href="/tutorials/java/">Overview</a>
          <a href="/tutorials/java/fortune.html">Fortune in Java</a>
      <a href="/tutorials/java/android.html">Location Service in Android</a>
    </nav>
    
        <a href="#" class="nav">JavaScript</a>
        <nav>
          <a href="/tutorials/javascript/">Overview</a>
          <a href="/tutorials/javascript/hellopeer.html">Hello Peer</a>
      <a href="/tutorials/javascript/fortune.html">Fortune in JS</a>
      <a href="/tutorials/javascript/security.html">Security in JS</a>
    </nav>
    
        <a href="/tutorials/faq.html">Tutorial FAQ</a>
      </nav>
    
      <a href="#" class="nav">Concepts</a>
      <nav>
        <a href="/concepts/rpc.html">RPC System</a>
    <a href="/concepts/naming.html">Naming</a>
    <a href="/concepts/security.html">Security</a>
    <a href="/concepts/device-management.html">Device Management</a>
    <a href="/concepts/syncbase-overview.html">Syncbase</a>
  </nav>
    
      <a href="/example-apps.html">Example Apps</a>
      <a href="/api-reference.html">API Reference</a>
    
      <a href="#" class="nav">Community</a>
      <nav>
        <a href="/community/coding-guidelines.html">Coding Guidelines</a>
    <a href="/community/contributing.html">Contributing</a>
  </nav>
    
      <a href="#" class="nav">Tools</a>
      <nav>
        <a href="/tools/identity-service-faq.html">Vanadium Identity Service</a>
    <a href="/tools/jiri.html">Jiri</a>
    <a href="/tools/services.html">Vanadium Cloud Services</a>
    <a href="/tools/vanadium-chrome-extension.html">Vanadium Chrome Extension</a>
  </nav>
    
      <a href="#" class="nav">Design Docs</a>
      <nav>
        <a href="/designdocs/authentication.html">Authentication Protocol</a>
    <a href="/designdocs/identity-service.html">Identity Service</a>
    <a href="/designdocs/vdl-spec.html">VDL Specification</a>
    <a href="/designdocs/vom-spec.html">VOM Specification</a>
  </nav>
    
      <a href="/glossary.html">Glossary</a>
      <a href="/faq.html">FAQ</a>
      <a href="/tos.html">Terms of Service</a>
    </div>
    <main>
      <h1 class="title">
        
        Hello Peer
      </h1>

      <p class="wherein"><strong>Wherein</strong> Vanadium says hello in a peer-to-peer manner.</p>

      <div class="toc"></div>

      <div class="prerequisites">
      <div class="note info"><p><strong>Prerequisites</strong>:<br>
All tutorials require Vanadium <a href="/installation/">installation</a>, and must run in a <a href="/tutorials/faq.html#why-bash-">bash shell</a>.
</p>
<p></p>
<p>
If you would like to generate files from this tutorial without the copy/paste steps, download and source <a href="/sh/tut-completer-js-hellopeer.sh" download="tut-completer-js-hellopeer.sh">this script</a>. Files will be created in the <code>$V_TUT</code> <a href="/tutorials/setup.html">directory</a>.
</p>
</div>
</div>

      <h2 id="introduction">Introduction</h2>
<p>This tutorial demonstrates how to use JavaScript to create a peer-to-peer
Vanadium app and run it in your browser.</p>
<h2 id="setup">Setup</h2>
<p>Vanadium has two core dependencies when building browser apps:</p>
<ul>
<li><a href="https://nodejs.org/download">Node.js</a> for running a JavaScript-based build system.
Download and install node from <a href="https://nodejs.org/download">https://nodejs.org/download</a> and add it to your <code>PATH</code>.</li>
<li><a href="http://golang.org">Go</a> for core Vanadium tools. This is technically optional for this tutorial, but
will be used in later tutorials. Download and install it from <a href="https://golang.org/dl/">https://golang.org/dl/</a> or
through your package manager and make sure it is in your <code>PATH</code>.</li>
</ul>
<p>Apart from these two global dependencies, the remainder of the setup
involves only local changes to the project directory.</p>
<h3 id="project-directory">Project directory</h3>
<p>First, create a directory for the tutorial. The environment variable
<code>$V_TUT</code> will be used throughout the tutorials to represent this directory.</p>
<!-- @createProjectDir @buildjs @test @testui @completer -->
<pre><code>export V_TUT=${V_TUT-$HOME/v23_tutorial}
mkdir -p $V_TUT
</code></pre><h3 id="install-node-modules-with-npm">Install Node modules with NPM</h3>
<p>The Node Package Manager <code>npm</code> (which was installed with Node.js)
is used to install the modules
needed for the tutorial to <code>$V_TUT/node_modules</code>:</p>
<pre><code>cd $V_TUT
echo &quot;{}&quot; &gt; $V_TUT/package.json
npm install vanadium browserify node-static
</code></pre><div class="note warning"><p><strong>Pre-release only: Run this command block instead.</strong></p>
<!-- @removeThisBlockBeforeRelease @buildjs @test @testui @completer -->
<pre><code>cd $V_TUT
echo &quot;{}&quot; &gt; $V_TUT/package.json
npm install git+<a href="https://vanadium.googlesource.com/release.js.core">https://vanadium.googlesource.com/release.js.core</a>
npm install browserify node-static
</code></pre></div>

<p>After running this command, the following modules will be installed:</p>
<ul>
<li><code>vanadium</code> - The core vanadium library.</li>
<li><code>browserify</code> - A build tool used to create a browser-compatible
JavaScript file from a project structured for node. Vanadium uses node to handle
JavaScript dependency management.</li>
<li><code>node-static</code> - A simple static web server that enables the tutorials
to be viewed in a browser.</li>
</ul>
<h3 id="vanadium-chrome-extension">Vanadium Chrome extension</h3>
<p>Vanadium currently requires an extension to run JavaScript in the browser.
This extension is used to securely store credentials and
additionally contains Vanadium&#39;s go-language core.
The Vanadium team is working to remove the Chrome-extension dependency
in the future.</p>
<p>The extension can be installed from its page on the Chrome web store:
<a href="https://chrome.google.com/webstore/detail/jcaelnibllfoobpedofhlaobfcoknpap">https://chrome.google.com/webstore/detail/jcaelnibllfoobpedofhlaobfcoknpap</a></p>
<p>For more information, see: <a href="/tools/vanadium-chrome-extension.html">Vanadium Chrome extension Overview</a></p>
<p><strong>You have finished setting up your project. Now, onto the code!</strong></p>
<h2 id="creating-a-vanadium-application">Creating a Vanadium application</h2>
<p>Each <strong>peer</strong> in the application will consist of a <strong>server</strong> and a <strong>client</strong>.
After receiving a request, the server outputs the message sent by the client.</p>
<p>The following sections break down the application code into bite-sized snippets.
<strong>The full file will be shown afterwards.</strong></p>
<h3 id="service-definition">Service definition</h3>
<p>Define a service that has a single method <code>hello()</code> with a single
parameter <code>greeting</code>, in addition to the required <code>context</code> and <code>serverCall</code> parameters.</p>
<pre><code class="noclipboard">function HelloService() {}

HelloService.prototype.hello = function(ctx, serverCall, greeting) {
  displayHello(greeting);
};</code></pre>

<p>It is also possible to define service interfaces in <a href="/glossary.html#vanadium-definition-language-vdl-">VDL</a> (Vanadium Definition
Language) in order to declare the
protocol with explicit type information.
This is demonstrated in the next tutorial.</p>
<h3 id="creating-the-service">Creating the service</h3>
<p>The service is created and served by calling <code>runtime.newServer</code> and passing in
the name used to mount the service, along with the service itself.</p>
<pre><code class="noclipboard">runtime.newServer(serviceName, new HelloService(), function callback() {
  // HelloService is now ready.
});</code></pre>

<h3 id="calling-the-service-from-a-client">Calling the service from a client</h3>
<p>To call a service, first bind on the name. This results in a stub object
that represents the service.
When the client program calls a method on the stub,
the corresponding method is remotely invoked on the service.</p>
<pre><code class="noclipboard">var client = runtime.getClient();
var ctx = runtime.getContext();

client.bindTo(ctx, serviceName, function(err, helloService) {
  if (err) {
    // handle err
  }

  var greeting = 'Hello Vanadium';
  helloService.hello(ctx, greeting, function callback(err) {
    if (err) {
      // handle err
    }
    // The call is complete!
  });
});</code></pre>

<h3 id="putting-it-all-together">Putting it all together</h3>
<p>This example combines the service, server, and client into a single file.
Typically, the client is a separate program from the server and service.</p>
<p>The following command creates the peer implementation <code>$V_TUT/src/hello/peer.js</code>.</p>
<!-- @helloPeerJS @buildjs @test @testui @completer -->
<pre><code>mkdir -p $V_TUT/src/hello
cat - &lt;&lt;EOF &gt;$V_TUT/src/hello/peer.js
var vanadium = require(&#39;vanadium&#39;);

// Define HelloService and the hello() method.
function HelloService() {}

HelloService.prototype.hello = function(ctx, serverCall, greeting) {
  displayHello(greeting);
};

// Initialize Vanadium runtime.
vanadium.init(function(err, runtime) {
  if (err) {
    showStatus(&#39;Initialization error: &#39; + err);
    return;
  }
  showStatus(&#39;Initialized&#39;);
  runtime.on(&#39;crash&#39;, function(err) {
    showStatus(&#39;The runtime has crashed unexpectedly and the page must be reloaded.&#39;);
  });

  setupServer(runtime);
  setupClient(runtime);
});

// Setup the server.
function setupServer(runtime) {
  // Create a server and serve the HelloService.
  var serviceName = getLocalPeerName(runtime.accountName);
  runtime.newServer(serviceName, new HelloService(), function(err) {
    if (err) {
      showServerStatus(&#39;Failed to serve &#39; + serviceName + &#39;: &#39; + err);
      return;
    }
    showServerStatus(&#39;Serving&#39;);
    // HelloService is now served.
  });
}

// Setup the client.
function setupClient(runtime) {
  // Create a client and bind to the service.
  var client = runtime.getClient();
  var ctx = runtime.getContext();

  var serviceName = getRemotePeerName(runtime.accountName);
  showClientStatus(&#39;Binding&#39;);
  client.bindTo(ctx, serviceName, function(err, helloService) {
    if (err) {
      showClientStatus(&#39;Failed to bind to &#39; + serviceName + &#39;: &#39; + err);
      return;
    }
    showClientStatus(&#39;Ready&#39;);

    registerButtonHandler(function(greeting) {
      showClientStatus(&#39;Calling&#39;);
      // Call hello() on the service.
      helloService.hello(ctx, greeting, function(err) {
        if (err) {
          showClientStatus(&#39;Error invoking hello(): &#39; + err);
          return;
        }
        showClientStatus(&#39;Ready&#39;);
      });
    });
  });
}

// Get the local and remote names.
function getLocalPeerName(accountName) {
  var homeDir = accountName.replace(/^dev.v.io:u:/, &#39;users/&#39;).replace(vanadium.security.ChainSeparator.val, &#39;/&#39;);
  var hash = window.location.hash;
  return homeDir + &#39;/tutorial/hello&#39; + hash;
}
function getRemotePeerName(accountName) {
  var localPeer = getLocalPeerName(accountName);
  var splitPeer = localPeer.split(&#39;#&#39;);
  if (splitPeer[1] == &#39;A&#39;) {
    splitPeer[1] = &#39;B&#39;;
  } else {
    splitPeer[1] = &#39;A&#39;;
  }
  return splitPeer.join(&#39;#&#39;);
}

// Manipulate the html page.
function displayHello(greeting) {
  var li = document.createElement(&#39;li&#39;);
  li.textContent = greeting;
  document.getElementById(&#39;receivedhellos&#39;).appendChild(li);
}
function registerButtonHandler(fn) {
  document.getElementById(&#39;hellobutton&#39;).addEventListener(&#39;click&#39;, function() {
    var greeting = document.getElementById(&#39;hellotext&#39;).value;
    fn(greeting);
  });
}
function showClientStatus(text) {
  document.getElementById(&#39;clientstatus&#39;).textContent = text;
}
function showServerStatus(text) {
  document.getElementById(&#39;serverstatus&#39;).textContent = text;
}
function showStatus(text) {
  showClientStatus(text);
  showServerStatus(text);
}
EOF
</code></pre><h3 id="building-for-the-browser">Building for the browser</h3>
<p>Use <code>browserify</code> to build the browser-targeted JavaScript file, which
combines <code>peer.js</code> above with its dependencies, such as the Vanadium library:</p>
<!-- @browserifyServer @buildjs @test @testui @completer -->
<pre><code>mkdir -p $V_TUT/browser
NODE_PATH=$V_TUT $V_TUT/node_modules/.bin/browserify \
  $V_TUT/src/hello/peer.js -o $V_TUT/browser/hello-peer.js
</code></pre><p>This command generates <code>$V_TUT/browser/hello-peer.js</code>.</p>
<h3 id="adding-the-script-to-an-html-page">Adding the script to an HTML page</h3>
<p>Finally, a web page is needed to host <code>peer.js</code>.</p>
<p>Create another HTML file in <code>$V_TUT/browser/peer.html</code> that includes the server
JavaScript code and links to the client.</p>
<!-- @helloPeerHTML @buildjs @test @testui @completer -->
<pre><code>cat - &lt;&lt;EOF &gt;$V_TUT/browser/peer.html
 &lt;!DOCTYPE html&gt;
 &lt;html&gt;
 &lt;head&gt;
   &lt;title&gt;Hello Peer&lt;/title&gt;
 &lt;/head&gt;
 &lt;body&gt;
   &lt;div&gt;
     &lt;div style=&quot;float:left;&quot;&gt;&lt;input id=&quot;hellotext&quot; value=&quot;Hello World&quot;&gt;&lt;/input&gt;&lt;button id=&quot;hellobutton&quot;&gt;Send&lt;/button&gt;&lt;/div&gt;
     &lt;div style=&quot;float:right; white-space:nowrap&quot;&gt;
     &lt;div&gt;Client Status: &lt;span id=&quot;clientstatus&quot;&gt;Initializing&lt;/span&gt;&lt;/div&gt;
     &lt;div&gt;Server Status: &lt;span id=&quot;serverstatus&quot;&gt;Initializing&lt;/span&gt;&lt;/div&gt;
     &lt;/div&gt;
   &lt;/div&gt;
   &lt;div style=&quot;clear:both;&quot;&gt;
     Received Greetings:
     &lt;ol id=&quot;receivedhellos&quot;&gt;&lt;/ol&gt;
   &lt;/div&gt;
   &lt;script src=&quot;hello-peer.js&quot;&gt;&lt;/script&gt;
 &lt;/body&gt;
 &lt;/html&gt;
EOF
</code></pre><p>Create an HTML file in <code>$V_TUT/hello.html</code> that contains two copies of <code>peer.js</code>
in iframes for simplified viewing.</p>
<!-- @helloMainHTML @buildjs @test @testui @completer -->
<pre><code>cat - &lt;&lt;EOF &gt;$V_TUT/hello.html
 &lt;!DOCTYPE html&gt;
 &lt;html&gt;
 &lt;head&gt;
   &lt;title&gt;Hello Peers&lt;/title&gt;
 &lt;/head&gt;
 &lt;body style=&quot;background: #000000;&quot;&gt;
   &lt;div style=&quot;position:fixed;top:0px;left:0px;bottom:0px;width:48%; background: #ffffff;&quot;&gt;
     &lt;iframe id=&quot;frameA&quot; src=&quot;browser/peer.html#A&quot; style=&quot;width:100%; height:100%;&quot; frameBorder=&quot;0&quot;&gt;&lt;/iframe&gt;
   &lt;/div&gt;
   &lt;div style=&quot;position:fixed;top:0px;right:0px;bottom:0px;width:48%; background: #ffffff;&quot;&gt;
     &lt;iframe id=&quot;frameB&quot; src=&quot;browser/peer.html#B&quot; style=&quot;width:100%; height:100%;&quot; frameBorder=&quot;0&quot;&gt;&lt;/iframe&gt;
   &lt;/div&gt;
 &lt;/body&gt;
 &lt;/html&gt;

EOF
</code></pre><p><strong>You are now ready to view the peers in a browser!</strong></p>
<h2 id="viewing-in-a-browser">Viewing in a browser</h2>
<h3 id="starting-a-local-server">Starting a local server</h3>
<p>You are ready to serve the web pages on a local server. Run the web server on port 8989.</p>
<p>Using node-static, the command is:</p>
<pre><code>$V_TUT/node_modules/.bin/static $V_TUT -p 8989 &gt; /dev/null
</code></pre><h3 id="viewing-the-pages">Viewing the pages</h3>
<p>The page shows two peers. Enter a greeting (or use the default &#39;Hello World&#39;) and
press Send for one peer. The other peer will receive the greeting.</p>
<div class="note warning"><p>On your first visit to a Vanadium web app, the Chrome Vanadium extension
prompts you to <code>Allow</code> blessings.
This grants the web app permission to use your identity when running servers and clients.</p>
<p>For the purposes of the tutorials, please click the <code>Allow</code> button when prompted
(this might be in another browser tab).</p>
</div>

<p>Open <a href="http://127.0.0.1:8989/hello.html">http://127.0.0.1:8989/hello.html</a> and allow the blessing.</p>
<h2 id="summary">Summary</h2>
<p>This tutorial demonstrated how to:</p>
<ul>
<li>Set up the Vanadium environment for JavaScript.</li>
<li>Create and build a Hello Peer client and server.</li>
<li>Run the example in a web browser. A hosted copy of the tutorial
result can be accessed <a href="/tutorials/javascript/results/hello.html">here</a>.</li>
</ul>

    </main>
    <nav class="previous-next">
      <a href="/tutorials/javascript/fortune.html" class="next">
        <div class="text-wrapper">
          <small>Next</small>
          <div class="text">
            <span>Fortune in JS</span>
          </div>
        </div>
        <div class="icon"><i class="material-icons">arrow_forward</i></div>
      </a>
</nav>
  </body>
</html>
